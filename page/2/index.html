<!DOCTYPE html>
<script src="/js/src/clicklove.js"></script>
<html lang="zh">
<head><meta name="generator" content="Hexo 3.9.0">
    <meta charset="utf-8">
<title>贾志翔的博客</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">



    <meta name="description" content="jia jiazhixiang jiaxiaochu jiaxiaochu.github.io">
<meta property="og:type" content="website">
<meta property="og:title" content="贾志翔的博客">
<meta property="og:url" content="http://yoursite.com/page/2/index.html">
<meta property="og:site_name" content="贾志翔的博客">
<meta property="og:description" content="jia jiazhixiang jiaxiaochu jiaxiaochu.github.io">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="http://yoursite.com/images/og_image.png">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="贾志翔的博客">
<meta name="twitter:description" content="jia jiazhixiang jiaxiaochu jiaxiaochu.github.io">
<meta name="twitter:image" content="http://yoursite.com/images/og_image.png">







<link rel="icon" href="/images/favicon.svg">


<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.7.2/css/bulma.css">
<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.4.1/css/all.css">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Ubuntu:400,600|Source+Code+Pro">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-dark.css">


    
    
    
    <style>body>.footer,body>.navbar,body>.section{opacity:0}</style>
    

    
    
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/css/lightgallery.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/css/justifiedGallery.min.css">
    

    
    

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/outdatedbrowser@1.1.5/outdatedbrowser/outdatedbrowser.min.css">


    
    
    
    

<link rel="stylesheet" href="/css/back-to-top.css">


    
    

    
    
    
    

    
    
<link rel="stylesheet" href="/css/progressbar.css">
<script src="https://cdn.jsdelivr.net/npm/pace-js@1.0.2/pace.min.js"></script>

    
    
    

    


<link rel="stylesheet" href="/css/style.css">
</head>
<body class="is-3-column">
    <nav class="navbar navbar-main">
    <div class="container">
        <div class="navbar-brand is-flex-center">
            <a class="navbar-item navbar-logo" href="/">
            
                <img src="/images/logo.svg" alt="贾志翔的博客" height="28">
            
            </a>
        </div>
        <div class="navbar-menu">
            
            <div class="navbar-start">
                
                <a class="navbar-item" href="/">主页</a>
                
                <a class="navbar-item" href="/archives">归档</a>
                
                <a class="navbar-item" href="/tags">标签</a>
                
                <a class="navbar-item" href="/about">支持</a>
                
                <a class="navbar-item" href="http://www.tripwiremagazine.com/wp-content/uploads/images/stories/Articles/9_Funniest_JavaScript_effects/Unclosable%20Window.html">别点·有毒</a>
                
                <a class="navbar-item" href="http://fanfou.com/">饭否</a>
                
            </div>
            
            <div class="navbar-end">
                
                    
                    
                    <a class="navbar-item" target="_blank" title="Download on GitHub" href="https://github.com/jiaxiaochu/jiaxiaochu.github.io">
                        
                        <i class="fab fa-github"></i>
                        
                    </a>
                    
                
                
                
                <a class="navbar-item search" title="搜索" href="javascript:;">
                    <i class="fas fa-search"></i>
                </a>
                
            </div>
        </div>
    </div>
</nav>
    
    <section class="section">
        <div class="container">
            <div class="columns">
                <div class="column is-8-tablet is-8-desktop is-6-widescreen has-order-2 column-main">
    <div class="card">
    
    <div class="card-content article ">
        
        <div class="level article-meta is-size-7 is-uppercase is-mobile is-overflow-x-auto">
            <div class="level-left">
                <time class="level-item has-text-grey" datetime="2019-04-10T16:08:06.398Z">2019-04-11</time>
                
                <div class="level-item">
                <a class="has-link-grey -link" href="/categories/计算机网络/">计算机网络</a>
                </div>
                
                
                <span class="level-item has-text-grey">
                    
                    
                    3 分钟 读完 (大约 478 个字)
                </span>
                
                
            </div>
        </div>
        
        <h1 class="title is-size-3 is-size-4-mobile has-text-weight-normal">
            
                <a class="has-link-black-ter" href="/2019/04/11/2019-03-29-计算机网络第四章 介质控制子层/">计算机网络 第四章 介质控制子层</a>
            
        </h1>
        <div class="content">
            <h1 id="生成树协议-Spanning-Tree-Protocol"><a href="#生成树协议-Spanning-Tree-Protocol" class="headerlink" title="生成树协议(Spanning Tree Protocol)"></a>生成树协议(Spanning Tree Protocol)</h1><ul>
<li>网桥只在根端口和指定端口之间转发帧</li>
<li>指定端口：指定网桥上与网段连接的端口</li>
<li>指定网桥：网段上离根最近的网桥</li>
<li>如果到根网桥的最短路径有多条，可以采用最短路径上的下一网桥ID和下一个端口ID用于打破平衡（取更小的）</li>
</ul>
<h1 id="虚拟局域网（Virtual-LAN-VLAN）"><a href="#虚拟局域网（Virtual-LAN-VLAN）" class="headerlink" title="虚拟局域网（Virtual LAN,VLAN）"></a>虚拟局域网（Virtual LAN,VLAN）</h1><p>如果网桥只在具有相同颜色的端口(Port) 之间转发帧，就会把原来的局域网分割成多个相互隔离的局域网，称为虚拟局域网(Virtual LAN,VLAN)。所谓的颜色其实就是VLAN ID，是由管理员为每个端口配置的，具有相同的VLAN ID的端口处于同一个VLAN，端口的默认VLAN为VLAN 1。</p>
<p>一个VLAN的帧只能转发到属于同一个VLAN的端口或者干道端口。<br>只有发往干道端口的帧才需要加上VLAN ID。<br>从干道收到的帧中如果没有VLAN ID，则认为是本征VLAN(Native VLAN)，默认为VLAN 1。<br>发往干道的Native VLAN的帧不加VLAN ID。</p>
<p>CST, PVST+ and MSTP</p>
<ul>
<li>IEEE 802.1Q中定义了由所有VLAN共享一棵树的公共生成树 (Common Spanning Tree，CST) 。</li>
<li>具有思科专利的PVST(Per-VLAN Spanning Tree)协议为每个VLAN配置一 颗生成树。由于 PVST 只能用于ISL，思科又定义了同时可用于IEEE 802.1Q的PVST+标准。思科的设备现在默认使用PVST+。</li>
<li>多生成树MSTP (Multiple Spanning Tree Protocol)起初单独由IEEE 802.1s定义，后来并入IEEE 802.1Q-2005。它是RSTP的一个扩展，并可 以把VLAN分组，每个VLAN组使用一颗生成树。</li>
<li>BID：PRIORITY(4b)+VLAN ID(12b)+MAC addr(6B) PRIORITY(4b):0,4096,… ,32768(default),…, 61440</li>
</ul>

        </div>
        
        
        
    </div>
</div>








    <div class="card">
    
    <div class="card-content article ">
        
        <div class="level article-meta is-size-7 is-uppercase is-mobile is-overflow-x-auto">
            <div class="level-left">
                <time class="level-item has-text-grey" datetime="2019-04-10T16:08:06.398Z">2019-04-11</time>
                
                <div class="level-item">
                <a class="has-link-grey -link" href="/categories/ACM/">ACM</a>&nbsp;/&nbsp;<a class="has-link-grey -link" href="/categories/ACM/题解/">题解</a>
                </div>
                
                
                <span class="level-item has-text-grey">
                    
                    
                    3 分钟 读完 (大约 450 个字)
                </span>
                
                
            </div>
        </div>
        
        <h1 class="title is-size-3 is-size-4-mobile has-text-weight-normal">
            
                <a class="has-link-black-ter" href="/2019/04/11/2019-03-23-ACM-ICPC World Finals 2018/">ACM-ICPC World Finals 2018</a>
            
        </h1>
        <div class="content">
            <h1 id="Comma-Sprinkler"><a href="#Comma-Sprinkler" class="headerlink" title="Comma Sprinkler"></a><a href="https://vjudge.net/problem/Kattis-comma" target="_blank" rel="noopener">Comma Sprinkler</a></h1><figure class="highlight cpp hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;bits/stdc++.h&gt;</span></span></span><br><span class="line"><span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> <span class="hljs-built_in">std</span>;</span><br><span class="line"><span class="hljs-keyword">const</span> <span class="hljs-keyword">int</span> N = <span class="hljs-number">1e6</span> + <span class="hljs-number">9</span>;</span><br><span class="line"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">ID</span> :</span> <span class="hljs-built_in">unordered_map</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-keyword">int</span>&gt;</span><br><span class="line">&#123;</span><br><span class="line">	<span class="hljs-built_in">vector</span>&lt;<span class="hljs-built_in">string</span>&gt; v;</span><br><span class="line">	<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">ask</span><span class="hljs-params">(<span class="hljs-keyword">const</span> <span class="hljs-built_in">string</span> &amp;s)</span></span></span><br><span class="line"><span class="hljs-function">	</span>&#123;</span><br><span class="line">		<span class="hljs-keyword">if</span> (count(s))</span><br><span class="line">			<span class="hljs-keyword">return</span> at(s);</span><br><span class="line">		<span class="hljs-keyword">return</span> insert(&#123;s, v.size()&#125;), v.push_back(s), v.size() - <span class="hljs-number">1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125; id;</span><br><span class="line"><span class="hljs-built_in">deque</span>&lt;pair&lt;<span class="hljs-keyword">int</span>, <span class="hljs-keyword">int</span>&gt;&gt; q;</span><br><span class="line"><span class="hljs-built_in">vector</span>&lt;<span class="hljs-keyword">int</span>&gt; v[N];</span><br><span class="line"><span class="hljs-keyword">char</span> s[N], t[N], vis[N][<span class="hljs-number">2</span>];</span><br><span class="line"><span class="hljs-keyword">int</span> n, a[N];</span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span></span><br><span class="line"><span class="hljs-function"></span>&#123;</span><br><span class="line">	<span class="hljs-keyword">for</span> (; ~<span class="hljs-built_in">scanf</span>(<span class="hljs-string">"%s"</span>, s); ++n)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="hljs-keyword">int</span> len = <span class="hljs-built_in">strlen</span>(s);</span><br><span class="line">		<span class="hljs-keyword">if</span> (s[len - <span class="hljs-number">1</span>] == <span class="hljs-string">','</span> || s[len - <span class="hljs-number">1</span>] == <span class="hljs-string">'.'</span>)</span><br><span class="line">			t[n] = s[--len], s[len] = <span class="hljs-number">0</span>;</span><br><span class="line">		v[a[n] = id.ask(s)].push_back(n);</span><br><span class="line">		<span class="hljs-keyword">if</span> (t[n] == <span class="hljs-string">','</span>)</span><br><span class="line">			q.push_back(&#123;n, <span class="hljs-number">1</span>&#125;), q.push_back(&#123;n + <span class="hljs-number">1</span>, <span class="hljs-number">0</span>&#125;);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="hljs-keyword">for</span> (; !q.empty(); q.pop_front())</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="hljs-keyword">int</span> an = a[q.front().first], type = q.front().second;</span><br><span class="line">		<span class="hljs-keyword">if</span> (vis[an][type] || q.front().first &gt;= n)</span><br><span class="line">			<span class="hljs-keyword">continue</span>;</span><br><span class="line">		<span class="hljs-keyword">else</span></span><br><span class="line">			vis[an][type] = <span class="hljs-number">1</span>;</span><br><span class="line">		<span class="hljs-keyword">if</span> (type)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="hljs-keyword">for</span> (<span class="hljs-keyword">auto</span> i : v[an])</span><br><span class="line">				<span class="hljs-keyword">if</span> (!t[i])</span><br><span class="line">					t[i] = <span class="hljs-string">','</span>, q.push_back(&#123;i + <span class="hljs-number">1</span>, <span class="hljs-number">0</span>&#125;);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="hljs-keyword">else</span></span><br><span class="line">		&#123;</span><br><span class="line">			<span class="hljs-keyword">for</span> (<span class="hljs-keyword">auto</span> i : v[an])</span><br><span class="line">				<span class="hljs-keyword">if</span> (i &gt; <span class="hljs-number">0</span> &amp;&amp; !t[i - <span class="hljs-number">1</span>])</span><br><span class="line">					t[i - <span class="hljs-number">1</span>] = <span class="hljs-string">','</span>, q.push_back(&#123;i - <span class="hljs-number">1</span>, <span class="hljs-number">1</span>&#125;);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; n; ++i)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="hljs-built_in">cout</span> &lt;&lt; id.v[a[i]];</span><br><span class="line">		<span class="hljs-keyword">if</span> (t[i])</span><br><span class="line">			<span class="hljs-built_in">cout</span> &lt;&lt; t[i];</span><br><span class="line">		<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">" "</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="Go-with-the-Flow"><a href="#Go-with-the-Flow" class="headerlink" title="Go with the Flow"></a><a href="https://vjudge.net/problem/Kattis-gowithflow" target="_blank" rel="noopener">Go with the Flow</a></h1><figure class="highlight cpp hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;bits/stdc++.h&gt;</span></span></span><br><span class="line"><span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> <span class="hljs-built_in">std</span>;</span><br><span class="line"><span class="hljs-keyword">const</span> <span class="hljs-keyword">int</span> N = <span class="hljs-number">4095</span>;</span><br><span class="line"><span class="hljs-keyword">char</span> s[<span class="hljs-number">99</span>];</span><br><span class="line"><span class="hljs-keyword">int</span> n, a[N], ans0, ans1;</span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span></span><br><span class="line"><span class="hljs-function"></span>&#123;</span><br><span class="line">	<span class="hljs-built_in">scanf</span>(<span class="hljs-string">"%d"</span>, &amp;n);</span><br><span class="line">	<span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; n; ++i)</span><br><span class="line">		<span class="hljs-built_in">scanf</span>(<span class="hljs-string">"%s"</span>, s), a[i] = <span class="hljs-built_in">strlen</span>(s);</span><br><span class="line">	<span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> len = *max_element(a, a + n), i = len; i &lt; n * len + n; ++i)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="hljs-built_in">vector</span>&lt;pair&lt;<span class="hljs-keyword">int</span>, <span class="hljs-keyword">int</span>&gt;&gt; mp, mmp;</span><br><span class="line">		<span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> j = <span class="hljs-number">0</span>, now = <span class="hljs-number">0</span>, p = <span class="hljs-number">0</span>; j &lt; n; ++j)</span><br><span class="line">		&#123;</span><br><span class="line">			now += a[j] + <span class="hljs-number">1</span>;</span><br><span class="line">			<span class="hljs-keyword">if</span> (j + <span class="hljs-number">1</span> &gt;= n || now + a[j + <span class="hljs-number">1</span>] &gt; i)</span><br><span class="line">			&#123;</span><br><span class="line">				now = p = <span class="hljs-number">0</span>;</span><br><span class="line">				swap(mp, mmp);</span><br><span class="line">				mp.clear();</span><br><span class="line">				<span class="hljs-keyword">continue</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			mp.push_back(&#123;now, <span class="hljs-number">1</span>&#125;);</span><br><span class="line">			<span class="hljs-keyword">while</span> (p &lt; mmp.size() &amp;&amp; mmp[p].first &lt; now - <span class="hljs-number">1</span>)</span><br><span class="line">				++p;</span><br><span class="line">			<span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> k = p; k &lt; mmp.size() &amp;&amp; mmp[k].first &lt; now + <span class="hljs-number">2</span>; ++k)</span><br><span class="line">				mp.back().second = max(mp.back().second, mmp[k].second + <span class="hljs-number">1</span>);</span><br><span class="line">			<span class="hljs-keyword">if</span> (ans1 &lt; mp.back().second)</span><br><span class="line">				ans0 = i, ans1 = mp.back().second;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="hljs-built_in">printf</span>(<span class="hljs-string">"%d %d"</span>, ans0, ans1);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="Wireless-is-the-New-Fiber"><a href="#Wireless-is-the-New-Fiber" class="headerlink" title="Wireless is the New Fiber"></a><a href="https://vjudge.net/problem/Kattis-newfiber" target="_blank" rel="noopener">Wireless is the New Fiber</a></h1><figure class="highlight cpp hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;bits/stdc++.h&gt;</span></span></span><br><span class="line"><span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> <span class="hljs-built_in">std</span>;</span><br><span class="line"><span class="hljs-keyword">const</span> <span class="hljs-keyword">int</span> N = <span class="hljs-number">1e5</span> + <span class="hljs-number">9</span>;</span><br><span class="line"><span class="hljs-built_in">set</span>&lt;pair&lt;<span class="hljs-keyword">int</span>, <span class="hljs-keyword">int</span>&gt;&gt; p, q;</span><br><span class="line"><span class="hljs-keyword">int</span> n, m, d[N];</span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span></span><br><span class="line"><span class="hljs-function"></span>&#123;</span><br><span class="line">	<span class="hljs-built_in">scanf</span>(<span class="hljs-string">"%d%d"</span>, &amp;n, &amp;m);</span><br><span class="line">	<span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>, u, v; i &lt; m; ++i)</span><br><span class="line">		<span class="hljs-built_in">scanf</span>(<span class="hljs-string">"%d%d"</span>, &amp;u, &amp;v), ++d[u], ++d[v];</span><br><span class="line">	<span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; n; ++i)</span><br><span class="line">		p.insert(&#123;d[i], i&#125;);</span><br><span class="line">	<span class="hljs-keyword">int</span> t = (m = n) - <span class="hljs-number">1</span>;</span><br><span class="line">	<span class="hljs-keyword">for</span> (<span class="hljs-keyword">auto</span> it : p)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="hljs-keyword">if</span> (t &gt; it.first - <span class="hljs-number">1</span>)</span><br><span class="line">			t -= it.first - <span class="hljs-number">1</span>, q.insert(it), --m;</span><br><span class="line">		<span class="hljs-keyword">else</span></span><br><span class="line">			q.insert(&#123;t, it.second&#125;), t = <span class="hljs-number">1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="hljs-built_in">printf</span>(<span class="hljs-string">"%d\n%d %d\n"</span>, m, n, n - <span class="hljs-number">1</span>);</span><br><span class="line">	<span class="hljs-keyword">while</span> (!q.empty())</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="hljs-keyword">auto</span> ch = *q.begin(), fa = *q.rbegin();</span><br><span class="line">		<span class="hljs-built_in">printf</span>(<span class="hljs-string">"%d %d\n"</span>, ch.second, fa.second);</span><br><span class="line">		q.erase(ch), q.erase(fa);</span><br><span class="line">		<span class="hljs-keyword">if</span> (--fa.first)</span><br><span class="line">			q.insert(fa);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


        </div>
        
        
        
    </div>
</div>








    <div class="card">
    
    <div class="card-content article ">
        
        <div class="level article-meta is-size-7 is-uppercase is-mobile is-overflow-x-auto">
            <div class="level-left">
                <time class="level-item has-text-grey" datetime="2019-04-10T16:08:06.398Z">2019-04-11</time>
                
                <div class="level-item">
                <a class="has-link-grey -link" href="/categories/并行与分布式计算/">并行与分布式计算</a>
                </div>
                
                
                <span class="level-item has-text-grey">
                    
                    
                    27 分钟 读完 (大约 4000 个字)
                </span>
                
                
            </div>
        </div>
        
        <h1 class="title is-size-3 is-size-4-mobile has-text-weight-normal">
            
                <a class="has-link-black-ter" href="/2019/04/11/2019-03-25-并行与分布式计算（2）/"></a>
            
        </h1>
        <div class="content">
            <p>并行与分布式计算<br>学院：数据科学与计算机学院<br>专业：计算机科学与技术（超级计算方向）<br>学号：17341163<br>姓名：吴坎</p>
<h1 id="课后作业"><a href="#课后作业" class="headerlink" title="课后作业"></a>课后作业</h1><blockquote>
<p>Why is it difficult to construct a true shared-memory computer? What is the minimum number of switches for connecting p processors to a shared memory with b words (where each word can be accessed independently)?</p>
</blockquote>
<p>共享内存的使用大大降低了在大规模数据处理过程中内存的消耗，但是共享内存的使用中有很多的陷阱，使理解和管理数据的局部性变得困难，一不注意就很容易导致程序崩溃。数据在读写过程中会更透明，但是数据写入进程或数据读出进程中，需要附加的数据结构控制。</p>
<p>每个word都需要一个开关，一共需要$b$个开关。</p>
<blockquote>
<p>Consider a memory system with a level 1 cache of 32 KB and DRAM of 512 MB with the processor operating at 1 GHz. The latency to L1 cache is one cycle and the latency to DRAM is 100 cycles. In each memory cycle, the processor fetches four words (cache line size is four words). What is the peak achievable performance of a dot product of two vectors? Note: Where necessary, assume an optimal cache placement policy.</p>
<figure class="highlight c hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="hljs-comment">/* dot product loop */</span></span><br><span class="line">&gt; <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; dim; ++i)</span><br><span class="line">&gt; 	dot_prod += a[i] * b[i];</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<p>最佳的内存策略是cache的一半用于缓存a，另一半用于缓存b。在这样的情况下，i每增加4，会发生两次cache miss，访问2次DRAM和6次cache。因此，完成上述循环，需要$\frac{dim}{4}\times(2\times 100+6\times 1)\times\frac{1}{1GHz}=dim\times 5.15\times 10^{-8}s$</p>
<blockquote>
<h2 id="Homework-asst-1"><a href="#Homework-asst-1" class="headerlink" title="Homework-asst-1"></a>Homework-asst-1</h2><p>Consider the following code where each line within the function represents a single function.</p>
<figure class="highlight c hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><br><span class="line"><span class="hljs-class">&gt; &#123;</span></span><br><span class="line">&gt; 	<span class="hljs-keyword">float</span> x, y;</span><br><span class="line">&gt; &#125; Point;</span><br><span class="line">&gt; <span class="hljs-function"><span class="hljs-keyword">inline</span> <span class="hljs-keyword">void</span> <span class="hljs-title">innerProduct</span><span class="hljs-params">(<span class="hljs-keyword">const</span> Point *a, <span class="hljs-keyword">const</span> Point *b, <span class="hljs-keyword">float</span> *result)</span></span></span><br><span class="line">&gt; &#123;</span><br><span class="line">&gt; 	<span class="hljs-keyword">float</span> x1 = a-&gt;x, <span class="hljs-comment">//Uses a load instruction</span></span><br><span class="line">&gt; 		  x2 = b-&gt;x,</span><br><span class="line">&gt; 		  product1 = x1 * x2,</span><br><span class="line">&gt; 		  y1 = a-&gt;y,</span><br><span class="line">&gt; 		  y2 = b-&gt;y,</span><br><span class="line">&gt; 		  product2 = y1 * y2,</span><br><span class="line">&gt; 		  inner = product1 + product2;</span><br><span class="line">&gt; 	*result = inner; <span class="hljs-comment">//Uses a store instruction</span></span><br><span class="line">&gt; &#125;</span><br><span class="line">&gt; <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">computeInnerProduct</span><span class="hljs-params">(<span class="hljs-keyword">const</span> Point a[], <span class="hljs-keyword">const</span> Point b[], <span class="hljs-keyword">float</span> result[], <span class="hljs-keyword">int</span> n)</span></span></span><br><span class="line">&gt; &#123;</span><br><span class="line">&gt; 	<span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; n; ++i)</span><br><span class="line">&gt; 		innerProduct(&amp;a[i], &amp;b[i], &amp;result[i]);</span><br><span class="line">&gt; &#125;</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<blockquote>
<p>In the following questions, you can assume the following:</p>
<ul>
<li>$N$ is very large($&gt;10^6$).</li>
<li>The machines described have modern CPUs, providing out-of-order execution, speculative execution, branch prediction, etc.</li>
<li>There are no cache misses.</li>
<li>The overhead of updating the loopindex i is negligible.</li>
<li>The overhead due to procedure calls, as well as starting and ending loops, is negligible.</li>
</ul>
<p>Problem 1: Instruction-Level Parallelism<br>Suppose you have a machine $M_1$ with two load/store unites that can each load or store a single value on each clock cycle, and one arithmetic unit can perform one arithmetic operation(e.g., multiplication or addition) on each clock cycle.<br>A. Assume that the load/store and arithmetic have latencies of one cycle. How many clock cycles would be required to execute <code>computeInnerProduct</code> as a function of <code>n</code>? Explain what limits the performance.</p>
</blockquote>
<p>做一次<code>innerProduct</code>需要7次load，1次store，3次arithmetic. 而<code>computeInnerProduct</code>的循环中有n次<code>innerProduct</code>，如果不考虑循环处的消耗的话需要$11n$个cycle。</p>
<blockquote>
<p>老师上课说，这一问也考虑了不同指令的并行，所以还是3n。</p>
</blockquote>
<blockquote>
<p>B. Now assume that the load/store and arithmetic unit have latencies of 10 clock cycles, but they are fully pipelined, able to initiate new operations every clock cycle. How many cycles would be required to execute <code>computeInnerProduction</code> as a function of <code>n</code>?Explain how this relates your answer to Part-A.</p>
</blockquote>
<p>最理想的情况下不发生竞争，完全并行，因此不考虑循环处的消耗的话需要<code>3n</code>个cycle。和A部分相比，由于指令完全流水线，因此每次循环时的load/store/arithmetic间没有间断。</p>
<blockquote>
<p>Problem 2: SIMD with ISPC<br>Consider running the following ISPC code.</p>
<figure class="highlight autoit hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&gt; export void computeInnerProductISPC(</span><br><span class="line">&gt; 	uniform point[] a,</span><br><span class="line">&gt; 	uniform point[] b,</span><br><span class="line">&gt; 	uniform float[] result,</span><br><span class="line">&gt; 	uniform <span class="hljs-built_in">int</span> n</span><br><span class="line">&gt; )</span><br><span class="line">&gt; &#123;</span><br><span class="line">&gt; 	foreach (i = <span class="hljs-number">0.</span>..n)</span><br><span class="line">&gt; 		result[i] = a[i].x * b[i].x + a[i].y * b[i].y<span class="hljs-comment">;</span></span><br><span class="line">&gt; &#125;</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<blockquote>
<p>Suppose machine $M_2$ has one 8-wide SIMD load/store unit, and one 8-wide SIMD arithmetic unit. both have latencies of one clock cycle.<br>A. How many clock cycles would be required to execute <code>computeInnerProductISPC</code> as a function of <code>n</code>? Explain what lmits the performance.</p>
</blockquote>
<p>对于循环中的每个i，发生可4次load，1次store，3次arithmetic。所以一共需要$8n$个cycle。</p>
<blockquote>
<p>老师上课说是$\frac{5}{8}n$，因为5次内存操作是瓶颈，8路同时运算。</p>
</blockquote>
<blockquote>
<p>B. If we run the <code>computeInnerProductISPC</code> on a five-core machine $M_3$, where each core has the same SIMD capabilities as $M_2$, what would be the best speedup it could achieve over the single-core performance of Part-A? Explain.</p>
</blockquote>
<p>最理想的情况下能够加速5倍，因为每个进程间的计算是彼此独立的。</p>
<blockquote>
<p>由于使用了SIMD指令集，这是一套单盒的指令集，没有多核并行的内容，所以没有加速，一倍。太坑了！！！</p>
</blockquote>
<blockquote>
<h2 id="Homework-asst-2"><a href="#Homework-asst-2" class="headerlink" title="Homework-asst-2"></a>Homework-asst-2</h2><p>Parallel Fractal Generation Using Pthreads</p>
<p>Leverage the sample code provided in the course web site.</p>
<p>Build and run the code in the prob1_mandelbrot_threads directory of the Assignment 1 code base.This program produces the image file mandelbrot-vV -serial.ppm, where V is the view index. This image is a visualization of a famous set of complex numbers called the Mandelbrot set. As you can see in the images below, the result is a familiar and beautiful fractal. Each pixel in the image corresponds to a value in the complex plane, and the brightness of each pixel is proportional to the computational cost of determining whether the value is contained in the Mandelbrot set—white pixels required the maximum (256) number of iterations, dark ones only a few iterations, and colored pixels were somewhere in between. (See function mandel() defined in mandelbrot.cpp.) You can learn more about the definition of the Mandelbrot set at en.wikipedia.org/wiki/Mandelbrot set. Use the command option “–view V ” for V between 0 and 6 to get the different images. You can click the links below to see the different images on a browser. Take the time to do this—the images are quite striking. (View 0 is not shown— it is all white.)</p>
<p>Your job is to parallelize the computation of the images using Pthreads. The command-line option “–threads T” specifies that the computation is to be partitioned over T threads. In function mandelbrotThread(), located in mandelbrot.cpp, the main application thread creates T-1 additional thread using pthread_create(). It waits for these threads to complete using pthread_join(). Currently, neither the launched threads nor the main thread do any computation, and so the program generates an error message. You should add code to the workerThreadStart() function to accomplish this task. You will not need to use of any other Pthread API calls in this assignment. What you need to do:</p>
<ol>
<li>Modify the code in mandelbrot.cpp to parallelize the Mandelbrot generation using two cores. Specifically, compute the top half of the image in thread 0, and the bottom half of the image in thread 1. This type of problem decomposition is referred to as spatial decomposition since different spatial regions of the image are computed by different processors.</li>
<li>Extend your code to utilize T threads for {2, 4, 8,16} , partitioning the image generation work into the appropriate number of horizontal blocks. You will need to modify the code in function workerThreadStart, to partition the work over the threads.</li>
<li>To confirm (or disprove) your hypothesis, measure the amount of time each thread requires to complete its work by inserting timing code at the beginning and end of workerThreadStart(). How do your measurements explain the speedup graph you previously created?</li>
</ol>
</blockquote>
<p>问题本身还是比较容易的，只在<code>mandelbrot.cpp</code>中加入了$126\sim 134$行和$164\sim 174$行就解决了问题，详见源代码。以上三个文件都在文件夹<code>prog1_mandelbrot_threads\</code>下，虽然老师给的代码有点乱，但好在写了<code>Makefile</code>。于是在终端中执行下列指令编译并运行。</p>
<figure class="highlight bash hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-built_in">cd</span> prog1_mandelbrot_threads</span><br><span class="line">make</span><br><span class="line">./mandelbrot -t 2</span><br></pre></td></tr></table></figure>

<p>得到如下输出。</p>
<figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[mandelbrot serial]:            [708.508] ms</span><br><span class="line">Wrote image file mandelbrot-serial.ppmHello world from thread 0</span><br><span class="line">Hello world from thread 1</span><br><span class="line">Hello world from thread 0</span><br><span class="line">Hello world from thread 1</span><br><span class="line">Hello world from thread 0</span><br><span class="line">Hello world from thread 1</span><br><span class="line">Hello world from thread 0</span><br><span class="line">Hello world from thread 1</span><br><span class="line">Hello world from thread 0</span><br><span class="line">Hello world from thread 1</span><br><span class="line">[mandelbrot thread]:            [336.797] ms</span><br><span class="line">Wrote image file mandelbrot-thread.ppm++++                            (2.10x speedup from 2 threads)</span><br></pre></td></tr></table></figure>

<p>以上输出表明并行计算的版本在双线程时比单线程快了2.1倍。生成了两个ppm格式的文件<code>mandelbrot-serial.ppm</code>、<code>mandelbrot-thread.ppm</code>，但是并看不了。使用下述指令进行转码：</p>
<figure class="highlight bash hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ffmpeg -i mandelbrot-serial.ppm mandelbrot-serial.bmp</span><br><span class="line">ffmpeg -i mandelbrot-thread.ppm mandelbrot-thread.bmp</span><br></pre></td></tr></table></figure>

<p>得到如下两张图片，可以看到也是一模一样的。</p>
<table>
<thead>
<tr>
<th><img src="/2019/04/11/2019-03-25-并行与分布式计算（2）/image/2019-03-25-1.bmp" alt></th>
<th><img src="/2019/04/11/2019-03-25-并行与分布式计算（2）/image/2019-03-25-2.bmp" alt></th>
</tr>
</thead>
<tbody><tr>
<td><code>mandelbrot-serial.bmp</code></td>
<td><code>mandelbrot-thread.bmp</code></td>
</tr>
</tbody></table>
<p>假如要使用更多的线程进行计算，只需要修改<code>./mandelbrot -t 2</code>中<code>-t</code>后的参数即可。</p>
<figure class="highlight bash hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">$ ./mandelbrot -t 4</span><br><span class="line">[mandelbrot serial]:            [713.990] ms</span><br><span class="line">Wrote image file mandelbrot-serial.ppmHello world from thread 1</span><br><span class="line">Hello world from thread 2</span><br><span class="line">Hello world from thread 0</span><br><span class="line">Hello world from thread 3</span><br><span class="line">Hello world from thread 1</span><br><span class="line">Hello world from thread 2</span><br><span class="line">Hello world from thread 0</span><br><span class="line">Hello world from thread 3</span><br><span class="line">Hello world from thread 1</span><br><span class="line">Hello world from thread 0</span><br><span class="line">Hello world from thread 2</span><br><span class="line">Hello world from thread 3</span><br><span class="line">Hello world from thread 1</span><br><span class="line">Hello world from thread 2</span><br><span class="line">Hello world from thread 0</span><br><span class="line">Hello world from thread 3</span><br><span class="line">Hello world from thread 1</span><br><span class="line">Hello world from thread 2</span><br><span class="line">Hello world from thread 0</span><br><span class="line">Hello world from thread 3</span><br><span class="line">[mandelbrot thread]:            [291.995] ms</span><br><span class="line">Wrote image file mandelbrot-thread.ppm++++                            (2.45x speedup from 4 threads)</span><br></pre></td></tr></table></figure>

<p>4线程的时候只快了2.45倍。</p>
<figure class="highlight bash hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">$ ./mandelbrot -t 8</span><br><span class="line">[mandelbrot serial]:            [707.881] ms</span><br><span class="line">Wrote image file mandelbrot-serial.ppmHello world from thread 1</span><br><span class="line">Hello world from thread 2</span><br><span class="line">Hello world from thread 3</span><br><span class="line">Hello world from thread 4</span><br><span class="line">Hello world from thread 5</span><br><span class="line">Hello world from thread 6</span><br><span class="line">Hello world from thread 0</span><br><span class="line">Hello world from thread 7</span><br><span class="line">Hello world from thread 1</span><br><span class="line">Hello world from thread 0</span><br><span class="line">Hello world from thread 3</span><br><span class="line">Hello world from thread 4</span><br><span class="line">Hello world from thread 2</span><br><span class="line">Hello world from thread 5</span><br><span class="line">Hello world from thread 6</span><br><span class="line">Hello world from thread 7</span><br><span class="line">Hello world from thread 1</span><br><span class="line">Hello world from thread 0</span><br><span class="line">Hello world from thread 3</span><br><span class="line">Hello world from thread 4</span><br><span class="line">Hello world from thread 5</span><br><span class="line">Hello world from thread 6</span><br><span class="line">Hello world from thread 2</span><br><span class="line">Hello world from thread 7</span><br><span class="line">Hello world from thread 1</span><br><span class="line">Hello world from thread 2</span><br><span class="line">Hello world from thread 3</span><br><span class="line">Hello world from thread 4</span><br><span class="line">Hello world from thread 5</span><br><span class="line">Hello world from thread 0</span><br><span class="line">Hello world from thread 6</span><br><span class="line">Hello world from thread 7</span><br><span class="line">Hello world from thread 1</span><br><span class="line">Hello world from thread 2</span><br><span class="line">Hello world from thread 3</span><br><span class="line">Hello world from thread 4</span><br><span class="line">Hello world from thread 5</span><br><span class="line">Hello world from thread 6</span><br><span class="line">Hello world from thread 0</span><br><span class="line">Hello world from thread 7</span><br><span class="line">[mandelbrot thread]:            [196.575] ms</span><br><span class="line">Wrote image file mandelbrot-thread.ppm++++                            (3.60x speedup from 8 threads)</span><br></pre></td></tr></table></figure>

<p>8线程的时候3.6倍。</p>
<figure class="highlight bash hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line">$ ./mandelbrot -t 16</span><br><span class="line">[mandelbrot serial]:            [738.481] ms</span><br><span class="line">Wrote image file mandelbrot-serial.ppmHello world from thread 1</span><br><span class="line">Hello world from thread 4</span><br><span class="line">Hello world from thread 13</span><br><span class="line">Hello world from thread 5</span><br><span class="line">Hello world from thread 6</span><br><span class="line">Hello world from thread 2</span><br><span class="line">Hello world from thread 7</span><br><span class="line">Hello world from thread 8</span><br><span class="line">Hello world from thread 9</span><br><span class="line">Hello world from thread 10</span><br><span class="line">Hello world from thread 11</span><br><span class="line">Hello world from thread 0</span><br><span class="line">Hello world from thread 12</span><br><span class="line">Hello world from thread 14</span><br><span class="line">Hello world from thread 15</span><br><span class="line">Hello world from thread 3</span><br><span class="line">Hello world from thread 1</span><br><span class="line">Hello world from thread 6</span><br><span class="line">Hello world from thread 3</span><br><span class="line">Hello world from thread 4</span><br><span class="line">Hello world from thread 5</span><br><span class="line">Hello world from thread 7</span><br><span class="line">Hello world from thread 8</span><br><span class="line">Hello world from thread 9</span><br><span class="line">Hello world from thread 2</span><br><span class="line">Hello world from thread 10</span><br><span class="line">Hello world from thread 11</span><br><span class="line">Hello world from thread 12</span><br><span class="line">Hello world from thread 13</span><br><span class="line">Hello world from thread 0</span><br><span class="line">Hello world from thread 14</span><br><span class="line">Hello world from thread 15</span><br><span class="line">Hello world from thread 1</span><br><span class="line">Hello world from thread 2</span><br><span class="line">Hello world from thread 0</span><br><span class="line">Hello world from thread 4</span><br><span class="line">Hello world from thread 5</span><br><span class="line">Hello world from thread 6</span><br><span class="line">Hello world from thread 7</span><br><span class="line">Hello world from thread 8</span><br><span class="line">Hello world from thread 9</span><br><span class="line">Hello world from thread 10</span><br><span class="line">Hello world from thread 11</span><br><span class="line">Hello world from thread 12</span><br><span class="line">Hello world from thread 13</span><br><span class="line">Hello world from thread 14</span><br><span class="line">Hello world from thread 15</span><br><span class="line">Hello world from thread 3</span><br><span class="line">Hello world from thread 1</span><br><span class="line">Hello world from thread 2</span><br><span class="line">Hello world from thread 9</span><br><span class="line">Hello world from thread 15</span><br><span class="line">Hello world from thread 5</span><br><span class="line">Hello world from thread 6</span><br><span class="line">Hello world from thread 7</span><br><span class="line">Hello world from thread 8</span><br><span class="line">Hello world from thread 3</span><br><span class="line">Hello world from thread 10</span><br><span class="line">Hello world from thread 11</span><br><span class="line">Hello world from thread 12</span><br><span class="line">Hello world from thread 13</span><br><span class="line">Hello world from thread 0</span><br><span class="line">Hello world from thread 14</span><br><span class="line">Hello world from thread 4</span><br><span class="line">Hello world from thread 1</span><br><span class="line">Hello world from thread 2</span><br><span class="line">Hello world from thread 9</span><br><span class="line">Hello world from thread 3</span><br><span class="line">Hello world from thread 5</span><br><span class="line">Hello world from thread 6</span><br><span class="line">Hello world from thread 7</span><br><span class="line">Hello world from thread 8</span><br><span class="line">Hello world from thread 0</span><br><span class="line">Hello world from thread 4</span><br><span class="line">Hello world from thread 10</span><br><span class="line">Hello world from thread 11</span><br><span class="line">Hello world from thread 12</span><br><span class="line">Hello world from thread 13</span><br><span class="line">Hello world from thread 14</span><br><span class="line">Hello world from thread 15</span><br><span class="line">[mandelbrot thread]:            [185.233] ms</span><br><span class="line">Wrote image file mandelbrot-thread.ppm++++                            (3.99x speedup from 16 threads)</span><br></pre></td></tr></table></figure>

<p>16线程的时候3.99倍。</p>
<p>可以看到，加速比随进程增加而增加，但是增加的量不是线性的。这是因为并行的时候会有额外的开销。</p>
<h2 id="源代码"><a href="#源代码" class="headerlink" title="源代码"></a>源代码</h2><h3 id="mandelbrot-cpp"><a href="#mandelbrot-cpp" class="headerlink" title="mandelbrot.cpp"></a>mandelbrot.cpp</h3><p>主要的代码，</p>
<figure class="highlight cpp hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="hljs-comment">// Use this code to time your threads</span></span><br><span class="line"><span class="hljs-comment">// 我加入的代码在126~134行和164~174行</span></span><br><span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">"CycleTimer.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">/*</span></span><br><span class="line"><span class="hljs-comment"></span></span><br><span class="line"><span class="hljs-comment">  15418 Spring 2012 note: This code was modified from example code</span></span><br><span class="line"><span class="hljs-comment">  originally provided by Intel.  To comply with Intel's open source</span></span><br><span class="line"><span class="hljs-comment">  licensing agreement, their copyright is retained below.</span></span><br><span class="line"><span class="hljs-comment"></span></span><br><span class="line"><span class="hljs-comment">  -----------------------------------------------------------------</span></span><br><span class="line"><span class="hljs-comment"></span></span><br><span class="line"><span class="hljs-comment">  Copyright (c) 2010-2011, Intel Corporation</span></span><br><span class="line"><span class="hljs-comment">  All rights reserved.</span></span><br><span class="line"><span class="hljs-comment"></span></span><br><span class="line"><span class="hljs-comment">  Redistribution and use in source and binary forms, with or without</span></span><br><span class="line"><span class="hljs-comment">  modification, are permitted provided that the following conditions are</span></span><br><span class="line"><span class="hljs-comment">  met:</span></span><br><span class="line"><span class="hljs-comment"></span></span><br><span class="line"><span class="hljs-comment">	* Redistributions of source code must retain the above copyright</span></span><br><span class="line"><span class="hljs-comment">	  notice, this list of conditions and the following disclaimer.</span></span><br><span class="line"><span class="hljs-comment"></span></span><br><span class="line"><span class="hljs-comment">	* Redistributions in binary form must reproduce the above copyright</span></span><br><span class="line"><span class="hljs-comment">	  notice, this list of conditions and the following disclaimer in the</span></span><br><span class="line"><span class="hljs-comment">	  documentation and/or other materials provided with the distribution.</span></span><br><span class="line"><span class="hljs-comment"></span></span><br><span class="line"><span class="hljs-comment">	* Neither the name of Intel Corporation nor the names of its</span></span><br><span class="line"><span class="hljs-comment">	  contributors may be used to endorse or promote products derived from</span></span><br><span class="line"><span class="hljs-comment">	  this software without specific prior written permission.</span></span><br><span class="line"><span class="hljs-comment"></span></span><br><span class="line"><span class="hljs-comment">   THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS</span></span><br><span class="line"><span class="hljs-comment">   IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED</span></span><br><span class="line"><span class="hljs-comment">   TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A</span></span><br><span class="line"><span class="hljs-comment">   PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER</span></span><br><span class="line"><span class="hljs-comment">   OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL,</span></span><br><span class="line"><span class="hljs-comment">   EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO,</span></span><br><span class="line"><span class="hljs-comment">   PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR</span></span><br><span class="line"><span class="hljs-comment">   PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF</span></span><br><span class="line"><span class="hljs-comment">   LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING</span></span><br><span class="line"><span class="hljs-comment">   NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS</span></span><br><span class="line"><span class="hljs-comment">   SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.</span></span><br><span class="line"><span class="hljs-comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">// Core computation of Mandelbrot set membershop</span></span><br><span class="line"><span class="hljs-comment">// Iterate complex number c to determine whether it diverges</span></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-keyword">int</span> <span class="hljs-title">mandel</span><span class="hljs-params">(<span class="hljs-keyword">float</span> c_re, <span class="hljs-keyword">float</span> c_im, <span class="hljs-keyword">int</span> count)</span></span></span><br><span class="line"><span class="hljs-function"></span>&#123;</span><br><span class="line">	<span class="hljs-keyword">float</span> z_re = c_re, z_im = c_im;</span><br><span class="line">	<span class="hljs-keyword">int</span> i;</span><br><span class="line">	<span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; count; ++i)</span><br><span class="line">	&#123;</span><br><span class="line"></span><br><span class="line">		<span class="hljs-keyword">if</span> (z_re * z_re + z_im * z_im &gt; <span class="hljs-number">4.f</span>)</span><br><span class="line">			<span class="hljs-keyword">break</span>;</span><br><span class="line"></span><br><span class="line">		<span class="hljs-keyword">float</span> new_re = z_re * z_re - z_im * z_im;</span><br><span class="line">		<span class="hljs-keyword">float</span> new_im = <span class="hljs-number">2.f</span> * z_re * z_im;</span><br><span class="line">		z_re = c_re + new_re;</span><br><span class="line">		z_im = c_im + new_im;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="hljs-keyword">return</span> i;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">//</span></span><br><span class="line"><span class="hljs-comment">// MandelbrotSerial --</span></span><br><span class="line"><span class="hljs-comment">//</span></span><br><span class="line"><span class="hljs-comment">// Compute an image visualizing the mandelbrot set.  The resulting</span></span><br><span class="line"><span class="hljs-comment">// array contains the number of iterations required before the complex</span></span><br><span class="line"><span class="hljs-comment">// number corresponding to a pixel could be rejected from the set.</span></span><br><span class="line"><span class="hljs-comment">//</span></span><br><span class="line"><span class="hljs-comment">// * x0, y0, x1, y1 describe the complex coordinates mapping</span></span><br><span class="line"><span class="hljs-comment">//   into the image viewport.</span></span><br><span class="line"><span class="hljs-comment">// * width, height describe the size of the output image</span></span><br><span class="line"><span class="hljs-comment">// * startRow, endRow describe how much of the image to compute</span></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">mandelbrotSerial</span><span class="hljs-params">(</span></span></span><br><span class="line"><span class="hljs-function"><span class="hljs-params">	<span class="hljs-keyword">float</span> x0, <span class="hljs-keyword">float</span> y0, <span class="hljs-keyword">float</span> x1, <span class="hljs-keyword">float</span> y1,</span></span></span><br><span class="line"><span class="hljs-function"><span class="hljs-params">	<span class="hljs-keyword">int</span> width, <span class="hljs-keyword">int</span> height,</span></span></span><br><span class="line"><span class="hljs-function"><span class="hljs-params">	<span class="hljs-keyword">int</span> startRow, <span class="hljs-keyword">int</span> endRow,</span></span></span><br><span class="line"><span class="hljs-function"><span class="hljs-params">	<span class="hljs-keyword">int</span> maxIterations,</span></span></span><br><span class="line"><span class="hljs-function"><span class="hljs-params">	<span class="hljs-keyword">int</span> output[])</span></span></span><br><span class="line"><span class="hljs-function"></span>&#123;</span><br><span class="line">	<span class="hljs-keyword">float</span> dx = (x1 - x0) / width;</span><br><span class="line">	<span class="hljs-keyword">float</span> dy = (y1 - y0) / height;</span><br><span class="line"></span><br><span class="line">	<span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> j = startRow; j &lt; endRow; j++)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; width; ++i)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="hljs-keyword">float</span> x = x0 + i * dx;</span><br><span class="line">			<span class="hljs-keyword">float</span> y = y0 + j * dy;</span><br><span class="line"></span><br><span class="line">			<span class="hljs-keyword">int</span> index = (j * width + i);</span><br><span class="line">			output[index] = mandel(x, y, maxIterations);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">// Struct for passing arguments to thread routine</span></span><br><span class="line"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><br><span class="line"><span class="hljs-class">&#123;</span></span><br><span class="line">	<span class="hljs-keyword">float</span> x0, x1;</span><br><span class="line">	<span class="hljs-keyword">float</span> y0, y1;</span><br><span class="line">	<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> width;</span><br><span class="line">	<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> height;</span><br><span class="line">	<span class="hljs-keyword">int</span> maxIterations;</span><br><span class="line">	<span class="hljs-keyword">int</span> *output;</span><br><span class="line">	<span class="hljs-keyword">int</span> threadId;</span><br><span class="line">	<span class="hljs-keyword">int</span> numThreads;</span><br><span class="line">&#125; WorkerArgs;</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">//</span></span><br><span class="line"><span class="hljs-comment">// workerThreadStart --</span></span><br><span class="line"><span class="hljs-comment">//</span></span><br><span class="line"><span class="hljs-comment">// Thread entrypoint.</span></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">void</span> *<span class="hljs-title">workerThreadStart</span><span class="hljs-params">(<span class="hljs-keyword">void</span> *threadArgs)</span></span></span><br><span class="line"><span class="hljs-function"></span>&#123;</span><br><span class="line"></span><br><span class="line">	WorkerArgs *args = <span class="hljs-keyword">static_cast</span>&lt;WorkerArgs *&gt;(threadArgs);</span><br><span class="line"></span><br><span class="line">	<span class="hljs-comment">// <span class="hljs-doctag">TODO:</span> Implement worker thread here.</span></span><br><span class="line"></span><br><span class="line">	<span class="hljs-built_in">printf</span>(<span class="hljs-string">"Hello world from thread %d\n"</span>, args-&gt;threadId);</span><br><span class="line">	<span class="hljs-comment">//以下是我加的第一部分内容</span></span><br><span class="line">	mandelbrotSerial(</span><br><span class="line">		args-&gt;x0, args-&gt;y0, args-&gt;x1, args-&gt;y1,</span><br><span class="line">		args-&gt;width, args-&gt;height,</span><br><span class="line">		args-&gt;height / args-&gt;numThreads * args-&gt;threadId,																<span class="hljs-comment">//startRow</span></span><br><span class="line">		args-&gt;threadId == args-&gt;numThreads - <span class="hljs-number">1</span> ? args-&gt;height : args-&gt;height / args-&gt;numThreads * (args-&gt;threadId + <span class="hljs-number">1</span>), <span class="hljs-comment">//endRow</span></span><br><span class="line">		args-&gt;maxIterations,</span><br><span class="line">		args-&gt;output);</span><br><span class="line">	<span class="hljs-comment">//增加完毕，只需要调用串行部分的代码即可</span></span><br><span class="line">	<span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">//</span></span><br><span class="line"><span class="hljs-comment">// MandelbrotThread --</span></span><br><span class="line"><span class="hljs-comment">//</span></span><br><span class="line"><span class="hljs-comment">// Multi-threaded implementation of mandelbrot set image generation.</span></span><br><span class="line"><span class="hljs-comment">// Multi-threading performed via pthreads.</span></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">mandelbrotThread</span><span class="hljs-params">(</span></span></span><br><span class="line"><span class="hljs-function"><span class="hljs-params">	<span class="hljs-keyword">int</span> numThreads,</span></span></span><br><span class="line"><span class="hljs-function"><span class="hljs-params">	<span class="hljs-keyword">float</span> x0, <span class="hljs-keyword">float</span> y0, <span class="hljs-keyword">float</span> x1, <span class="hljs-keyword">float</span> y1,</span></span></span><br><span class="line"><span class="hljs-function"><span class="hljs-params">	<span class="hljs-keyword">int</span> width, <span class="hljs-keyword">int</span> height,</span></span></span><br><span class="line"><span class="hljs-function"><span class="hljs-params">	<span class="hljs-keyword">int</span> maxIterations, <span class="hljs-keyword">int</span> output[])</span></span></span><br><span class="line"><span class="hljs-function"></span>&#123;</span><br><span class="line">	<span class="hljs-keyword">const</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> MAX_THREADS = <span class="hljs-number">32</span>;</span><br><span class="line"></span><br><span class="line">	<span class="hljs-keyword">if</span> (numThreads &gt; MAX_THREADS)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">"Error: Max allowed threads is %d\n"</span>, MAX_THREADS);</span><br><span class="line">		<span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="hljs-keyword">pthread_t</span> workers[MAX_THREADS];</span><br><span class="line">	WorkerArgs args[MAX_THREADS];</span><br><span class="line"></span><br><span class="line">	<span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; numThreads; i++)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="hljs-comment">// <span class="hljs-doctag">TODO:</span> Set thread arguments here.</span></span><br><span class="line">		args[i].threadId = i;</span><br><span class="line">		<span class="hljs-comment">//以下是我加的第二段内容</span></span><br><span class="line">		args[i].x0 = x0;</span><br><span class="line">		args[i].x1 = x1;</span><br><span class="line">		args[i].y0 = y0;</span><br><span class="line">		args[i].y1 = y1;</span><br><span class="line">		args[i].width = width;</span><br><span class="line">		args[i].height = height;</span><br><span class="line">		args[i].maxIterations = maxIterations;</span><br><span class="line">		args[i].output = output;</span><br><span class="line">		args[i].numThreads = numThreads;</span><br><span class="line">		<span class="hljs-comment">//增加完毕，把所有信息传给worker线程即可</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="hljs-comment">// Fire up the worker threads.  Note that numThreads-1 pthreads</span></span><br><span class="line">	<span class="hljs-comment">// are created and the main app thread is used as a worker as</span></span><br><span class="line">	<span class="hljs-comment">// well.</span></span><br><span class="line"></span><br><span class="line">	<span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">1</span>; i &lt; numThreads; i++)</span><br><span class="line">		pthread_create(&amp;workers[i], <span class="hljs-literal">NULL</span>, workerThreadStart, &amp;args[i]);</span><br><span class="line"></span><br><span class="line">	workerThreadStart(&amp;args[<span class="hljs-number">0</span>]);</span><br><span class="line"></span><br><span class="line">	<span class="hljs-comment">// wait for worker threads to complete</span></span><br><span class="line">	<span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">1</span>; i &lt; numThreads; i++)</span><br><span class="line">		pthread_join(workers[i], <span class="hljs-literal">NULL</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="main-cpp"><a href="#main-cpp" class="headerlink" title="main.cpp"></a>main.cpp</h3><figure class="highlight cpp hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;algorithm&gt;</span></span></span><br><span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;getopt.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">"CycleTimer.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">extern</span> <span class="hljs-keyword">void</span> <span class="hljs-title">mandelbrotSerial</span><span class="hljs-params">(</span></span></span><br><span class="line"><span class="hljs-function"><span class="hljs-params">    <span class="hljs-keyword">float</span> x0, <span class="hljs-keyword">float</span> y0, <span class="hljs-keyword">float</span> x1, <span class="hljs-keyword">float</span> y1,</span></span></span><br><span class="line"><span class="hljs-function"><span class="hljs-params">    <span class="hljs-keyword">int</span> width, <span class="hljs-keyword">int</span> height,</span></span></span><br><span class="line"><span class="hljs-function"><span class="hljs-params">    <span class="hljs-keyword">int</span> startRow, <span class="hljs-keyword">int</span> endRow,</span></span></span><br><span class="line"><span class="hljs-function"><span class="hljs-params">    <span class="hljs-keyword">int</span> maxIterations,</span></span></span><br><span class="line"><span class="hljs-function"><span class="hljs-params">    <span class="hljs-keyword">int</span> output[])</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">extern</span> <span class="hljs-keyword">void</span> <span class="hljs-title">mandelbrotThread</span><span class="hljs-params">(</span></span></span><br><span class="line"><span class="hljs-function"><span class="hljs-params">    <span class="hljs-keyword">int</span> numThreads,</span></span></span><br><span class="line"><span class="hljs-function"><span class="hljs-params">    <span class="hljs-keyword">float</span> x0, <span class="hljs-keyword">float</span> y0, <span class="hljs-keyword">float</span> x1, <span class="hljs-keyword">float</span> y1,</span></span></span><br><span class="line"><span class="hljs-function"><span class="hljs-params">    <span class="hljs-keyword">int</span> width, <span class="hljs-keyword">int</span> height,</span></span></span><br><span class="line"><span class="hljs-function"><span class="hljs-params">    <span class="hljs-keyword">int</span> maxIterations,</span></span></span><br><span class="line"><span class="hljs-function"><span class="hljs-params">    <span class="hljs-keyword">int</span> output[])</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">extern</span> <span class="hljs-keyword">void</span> <span class="hljs-title">writePPMImage</span><span class="hljs-params">(</span></span></span><br><span class="line"><span class="hljs-function"><span class="hljs-params">    <span class="hljs-keyword">int</span> *data,</span></span></span><br><span class="line"><span class="hljs-function"><span class="hljs-params">    <span class="hljs-keyword">int</span> width, <span class="hljs-keyword">int</span> height,</span></span></span><br><span class="line"><span class="hljs-function"><span class="hljs-params">    <span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *filename,</span></span></span><br><span class="line"><span class="hljs-function"><span class="hljs-params">    <span class="hljs-keyword">int</span> maxIterations)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">scaleAndShift</span><span class="hljs-params">(<span class="hljs-keyword">float</span> &amp;x0, <span class="hljs-keyword">float</span> &amp;x1, <span class="hljs-keyword">float</span> &amp;y0, <span class="hljs-keyword">float</span> &amp;y1,</span></span></span><br><span class="line"><span class="hljs-function"><span class="hljs-params">                   <span class="hljs-keyword">float</span> scale,</span></span></span><br><span class="line"><span class="hljs-function"><span class="hljs-params">                   <span class="hljs-keyword">float</span> shiftX, <span class="hljs-keyword">float</span> shiftY)</span></span></span><br><span class="line"><span class="hljs-function"></span>&#123;</span><br><span class="line"></span><br><span class="line">    x0 *= scale;</span><br><span class="line">    x1 *= scale;</span><br><span class="line">    y0 *= scale;</span><br><span class="line">    y1 *= scale;</span><br><span class="line">    x0 += shiftX;</span><br><span class="line">    x1 += shiftX;</span><br><span class="line">    y0 += shiftY;</span><br><span class="line">    y1 += shiftY;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">usage</span><span class="hljs-params">(<span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *progname)</span></span></span><br><span class="line"><span class="hljs-function"></span>&#123;</span><br><span class="line">    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Usage: %s [options]\n"</span>, progname);</span><br><span class="line">    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Program Options:\n"</span>);</span><br><span class="line">    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"  -t  --threads &lt;N&gt;  Use N threads\n"</span>);</span><br><span class="line">    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"  -v  --view &lt;INT&gt;   Use specified view settings (1-6)\n"</span>);</span><br><span class="line">    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"  -?  --help         This message\n"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">bool</span> <span class="hljs-title">verifyResult</span><span class="hljs-params">(<span class="hljs-keyword">int</span> *gold, <span class="hljs-keyword">int</span> *result, <span class="hljs-keyword">int</span> width, <span class="hljs-keyword">int</span> height)</span></span></span><br><span class="line"><span class="hljs-function"></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">int</span> i, j;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; height; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="hljs-keyword">for</span> (j = <span class="hljs-number">0</span>; j &lt; width; j++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="hljs-keyword">if</span> (gold[i * width + j] != result[i * width + j])</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Mismatch : [%d][%d], Expected : %d, Actual : %d\n"</span>,</span><br><span class="line">                       i, j, gold[i * width + j], result[i * width + j]);</span><br><span class="line">                <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> VIEWCNT 6</span></span><br><span class="line"></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-keyword">int</span> argc, <span class="hljs-keyword">char</span> **argv)</span></span></span><br><span class="line"><span class="hljs-function"></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">const</span> <span class="hljs-keyword">int</span> width = <span class="hljs-number">1440</span>;</span><br><span class="line">    <span class="hljs-keyword">const</span> <span class="hljs-keyword">int</span> height = <span class="hljs-number">900</span>;</span><br><span class="line">    <span class="hljs-keyword">const</span> <span class="hljs-keyword">int</span> maxIterations = <span class="hljs-number">256</span>;</span><br><span class="line">    <span class="hljs-keyword">int</span> numThreads = <span class="hljs-number">2</span>;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">float</span> x0 = <span class="hljs-number">-2.167</span>;</span><br><span class="line">    <span class="hljs-keyword">float</span> x1 = <span class="hljs-number">1.167</span>;</span><br><span class="line">    <span class="hljs-keyword">float</span> y0 = <span class="hljs-number">-1</span>;</span><br><span class="line">    <span class="hljs-keyword">float</span> y1 = <span class="hljs-number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">// Support VIEWCNT views</span></span><br><span class="line">    <span class="hljs-keyword">float</span> scaleValues[VIEWCNT + <span class="hljs-number">1</span>] = &#123;<span class="hljs-number">1.0f</span>, <span class="hljs-number">1.0f</span>, <span class="hljs-number">0.015f</span>, <span class="hljs-number">0.02f</span>, <span class="hljs-number">0.02f</span>, <span class="hljs-number">0.02f</span>, <span class="hljs-number">0.002f</span>&#125;;</span><br><span class="line">    <span class="hljs-keyword">float</span> shiftXs[VIEWCNT + <span class="hljs-number">1</span>] = &#123;<span class="hljs-number">0.0f</span>, <span class="hljs-number">0.0f</span>, <span class="hljs-number">-0.98f</span>, <span class="hljs-number">0.35f</span>, <span class="hljs-number">0.0f</span>, <span class="hljs-number">-1.5f</span>, <span class="hljs-number">-1.4f</span>&#125;;</span><br><span class="line">    <span class="hljs-keyword">float</span> shiftYs[VIEWCNT + <span class="hljs-number">1</span>] = &#123;<span class="hljs-number">0.0f</span>, <span class="hljs-number">0.0f</span>, <span class="hljs-number">0.30f</span>, <span class="hljs-number">0.05f</span>, <span class="hljs-number">0.73f</span>, <span class="hljs-number">0.0f</span>, <span class="hljs-number">0.0f</span>&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">// parse commandline options ////////////////////////////////////////////</span></span><br><span class="line">    <span class="hljs-keyword">int</span> opt;</span><br><span class="line">    <span class="hljs-keyword">static</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">option</span> <span class="hljs-title">long_options</span>[] = &#123;</span></span><br><span class="line">        &#123;<span class="hljs-string">"threads"</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-string">'t'</span>&#125;,</span><br><span class="line">        &#123;<span class="hljs-string">"view"</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-string">'v'</span>&#125;,</span><br><span class="line">        &#123;<span class="hljs-string">"help"</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-string">'?'</span>&#125;,</span><br><span class="line">        &#123;<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>&#125;&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">while</span> ((opt = getopt_long(argc, argv, <span class="hljs-string">"t:v:?"</span>, long_options, <span class="hljs-literal">NULL</span>)) != EOF)</span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">        <span class="hljs-keyword">switch</span> (opt)</span><br><span class="line">        &#123;</span><br><span class="line">        <span class="hljs-keyword">case</span> <span class="hljs-string">'t'</span>:</span><br><span class="line">        &#123;</span><br><span class="line">            numThreads = atoi(optarg);</span><br><span class="line">            <span class="hljs-keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="hljs-keyword">case</span> <span class="hljs-string">'v'</span>:</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="hljs-keyword">int</span> viewIndex = atoi(optarg);</span><br><span class="line">            <span class="hljs-comment">// change view settings</span></span><br><span class="line">            <span class="hljs-keyword">if</span> (viewIndex &gt;= <span class="hljs-number">1</span> &amp;&amp; viewIndex &lt;= VIEWCNT)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="hljs-keyword">float</span> scaleValue = scaleValues[viewIndex];</span><br><span class="line">                <span class="hljs-keyword">float</span> shiftX = shiftXs[viewIndex];</span><br><span class="line">                <span class="hljs-keyword">float</span> shiftY = shiftYs[viewIndex];</span><br><span class="line">                scaleAndShift(x0, x1, y0, y1, scaleValue, shiftX, shiftY);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="hljs-keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">"Invalid view index\n"</span>);</span><br><span class="line">                <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="hljs-keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="hljs-keyword">case</span> <span class="hljs-string">'?'</span>:</span><br><span class="line">        <span class="hljs-keyword">default</span>:</span><br><span class="line">            usage(argv[<span class="hljs-number">0</span>]);</span><br><span class="line">            <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="hljs-comment">// end parsing of commandline options</span></span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">int</span> *output_serial = <span class="hljs-keyword">new</span> <span class="hljs-keyword">int</span>[width * height];</span><br><span class="line">    <span class="hljs-keyword">int</span> *output_thread = <span class="hljs-keyword">new</span> <span class="hljs-keyword">int</span>[width * height];</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">//</span></span><br><span class="line">    <span class="hljs-comment">// Run the serial implementation.  Run the code three times and</span></span><br><span class="line">    <span class="hljs-comment">// take the minimum to get a good estimate.</span></span><br><span class="line">    <span class="hljs-comment">//</span></span><br><span class="line">    <span class="hljs-built_in">memset</span>(output_serial, <span class="hljs-number">0</span>, width * height * <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">int</span>));</span><br><span class="line">    <span class="hljs-keyword">double</span> minSerial = <span class="hljs-number">1e30</span>;</span><br><span class="line">    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">3</span>; ++i)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="hljs-keyword">double</span> startTime = CycleTimer::currentSeconds();</span><br><span class="line">        mandelbrotSerial(x0, y0, x1, y1, width, height, <span class="hljs-number">0</span>, height, maxIterations, output_serial);</span><br><span class="line">        <span class="hljs-keyword">double</span> endTime = CycleTimer::currentSeconds();</span><br><span class="line">        minSerial = <span class="hljs-built_in">std</span>::min(minSerial, endTime - startTime);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"[mandelbrot serial]:\t\t[%.3f] ms\n"</span>, minSerial * <span class="hljs-number">1000</span>);</span><br><span class="line">    writePPMImage(output_serial, width, height, <span class="hljs-string">"mandelbrot-serial.ppm"</span>, maxIterations);</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">//</span></span><br><span class="line">    <span class="hljs-comment">// Run the threaded version</span></span><br><span class="line">    <span class="hljs-comment">//</span></span><br><span class="line">    <span class="hljs-built_in">memset</span>(output_thread, <span class="hljs-number">0</span>, width * height * <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">int</span>));</span><br><span class="line">    <span class="hljs-keyword">double</span> minThread = <span class="hljs-number">1e30</span>;</span><br><span class="line">    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">5</span>; ++i)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="hljs-keyword">double</span> startTime = CycleTimer::currentSeconds();</span><br><span class="line">        mandelbrotThread(numThreads, x0, y0, x1, y1, width, height, maxIterations, output_thread);</span><br><span class="line">        <span class="hljs-keyword">double</span> endTime = CycleTimer::currentSeconds();</span><br><span class="line">        minThread = <span class="hljs-built_in">std</span>::min(minThread, endTime - startTime);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"[mandelbrot thread]:\t\t[%.3f] ms\n"</span>, minThread * <span class="hljs-number">1000</span>);</span><br><span class="line">    writePPMImage(output_thread, width, height, <span class="hljs-string">"mandelbrot-thread.ppm"</span>, maxIterations);</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">if</span> (!verifyResult(output_serial, output_thread, width, height))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="hljs-built_in">printf</span>(<span class="hljs-string">"ERROR : Output from threads does not match serial output\n"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="hljs-keyword">delete</span>[] output_serial;</span><br><span class="line">        <span class="hljs-keyword">delete</span>[] output_thread;</span><br><span class="line"></span><br><span class="line">        <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">// compute speedup</span></span><br><span class="line">    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"++++\t\t\t\t(%.2fx speedup from %d threads)\n"</span>, minSerial / minThread, numThreads);</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">delete</span>[] output_serial;</span><br><span class="line">    <span class="hljs-keyword">delete</span>[] output_thread;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Makefile"><a href="#Makefile" class="headerlink" title="Makefile"></a>Makefile</h3><figure class="highlight makefile hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">CXX=g++ -m64</span><br><span class="line">CXXFLAGS=-I../common -Iobjs/ -O3 -Wall</span><br><span class="line"></span><br><span class="line">APP_NAME=mandelbrot</span><br><span class="line">OBJDIR=objs</span><br><span class="line">COMMONDIR=../common</span><br><span class="line"></span><br><span class="line">PPM_CXX=<span class="hljs-variable">$(COMMONDIR)</span>/ppm.cpp</span><br><span class="line">PPM_OBJ=<span class="hljs-variable">$(<span class="hljs-built_in">addprefix</span> <span class="hljs-variable">$(OBJDIR)</span>/, $(<span class="hljs-built_in">subst</span> <span class="hljs-variable">$(COMMONDIR)</span>/,, $(PPM_CXX:.cpp=.o)</span>))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="hljs-section">default: <span class="hljs-variable">$(APP_NAME)</span></span></span><br><span class="line"></span><br><span class="line"><span class="hljs-meta"><span class="hljs-meta-keyword">.PHONY</span>: dirs clean</span></span><br><span class="line"></span><br><span class="line"><span class="hljs-section">dirs:</span></span><br><span class="line">		/bin/mkdir -p <span class="hljs-variable">$(OBJDIR)</span>/</span><br><span class="line"></span><br><span class="line"><span class="hljs-section">clean:</span></span><br><span class="line">		/bin/rm -rf <span class="hljs-variable">$(OBJDIR)</span> *.ppm *~ <span class="hljs-variable">$(APP_NAME)</span></span><br><span class="line"></span><br><span class="line">OBJS=<span class="hljs-variable">$(OBJDIR)</span>/main.o <span class="hljs-variable">$(OBJDIR)</span>/mandelbrot.o <span class="hljs-variable">$(PPM_OBJ)</span></span><br><span class="line"></span><br><span class="line"><span class="hljs-variable">$(APP_NAME)</span>: dirs <span class="hljs-variable">$(OBJS)</span></span><br><span class="line">		<span class="hljs-variable">$(CXX)</span> <span class="hljs-variable">$(CXXFLAGS)</span> -o <span class="hljs-variable">$@</span> <span class="hljs-variable">$(OBJS)</span> -lm -lpthread</span><br><span class="line"></span><br><span class="line"><span class="hljs-variable">$(OBJDIR)</span>/%.o: %.cpp</span><br><span class="line">		<span class="hljs-variable">$(CXX)</span> <span class="hljs-variable">$&lt;</span> <span class="hljs-variable">$(CXXFLAGS)</span> -c -o <span class="hljs-variable">$@</span></span><br><span class="line"></span><br><span class="line"><span class="hljs-variable">$(OBJDIR)</span>/%.o: <span class="hljs-variable">$(COMMONDIR)</span>/%.cpp</span><br><span class="line">	<span class="hljs-variable">$(CXX)</span> <span class="hljs-variable">$&lt;</span> <span class="hljs-variable">$(CXXFLAGS)</span> -c -o <span class="hljs-variable">$@</span></span><br><span class="line"></span><br><span class="line"><span class="hljs-variable">$(OBJDIR)</span>/main.o: <span class="hljs-variable">$(COMMONDIR)</span>/CycleTimer.h</span><br></pre></td></tr></table></figure>


        </div>
        
        
        
    </div>
</div>








    <div class="card">
    
    <div class="card-content article ">
        
        <div class="level article-meta is-size-7 is-uppercase is-mobile is-overflow-x-auto">
            <div class="level-left">
                <time class="level-item has-text-grey" datetime="2019-04-10T16:08:06.397Z">2019-04-11</time>
                
                <div class="level-item">
                <a class="has-link-grey -link" href="/categories/ACM/">ACM</a>&nbsp;/&nbsp;<a class="has-link-grey -link" href="/categories/ACM/题解/">题解</a>
                </div>
                
                
                <span class="level-item has-text-grey">
                    
                    
                    9 分钟 读完 (大约 1375 个字)
                </span>
                
                
            </div>
        </div>
        
        <h1 class="title is-size-3 is-size-4-mobile has-text-weight-normal">
            
                <a class="has-link-black-ter" href="/2019/04/11/2019-03-20-2018-2019 ACM-ICPC Southeastern European Regional Programming Contest (SEERC 2018)/">2018-2019 ACM-ICPC Southeastern European Regional Programming Contest (SEERC 2018)</a>
            
        </h1>
        <div class="content">
            <h1 id="Broken-Watch"><a href="#Broken-Watch" class="headerlink" title="Broken Watch"></a><a href="https://vjudge.net/problem/Gym-101964B" target="_blank" rel="noopener">Broken Watch</a></h1><p>假如三根指针等长，答案是$C_n^3-3*C_{\lfloor\frac{n-1}{2}\rfloor}$。</p>
<p>两根指针等长，在上述答案上乘2；三根指针不等长，在上述答案上乘6。</p>
<figure class="highlight cpp hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;bits/stdc++.h&gt;</span></span></span><br><span class="line"><span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> <span class="hljs-built_in">std</span>;</span><br><span class="line"><span class="hljs-keyword">typedef</span> <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> <span class="hljs-keyword">long</span> ll;</span><br><span class="line">ll a, b, c, n;</span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span></span><br><span class="line"><span class="hljs-function"></span>&#123;</span><br><span class="line">	<span class="hljs-built_in">scanf</span>(<span class="hljs-string">"%llu%llu%llu%llu"</span>, &amp;a, &amp;b, &amp;c, &amp;n);</span><br><span class="line">	ll tmp[<span class="hljs-number">3</span>] = &#123;n, n - <span class="hljs-number">1</span>, n - <span class="hljs-number">2</span>&#125;;</span><br><span class="line">	<span class="hljs-keyword">for</span> (ll i = <span class="hljs-number">2</span>; i &lt; <span class="hljs-number">4</span>; ++i)</span><br><span class="line">		<span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> j = <span class="hljs-number">0</span>; j &lt; <span class="hljs-number">3</span>; ++j)</span><br><span class="line">			<span class="hljs-keyword">if</span> (tmp[j] % i == <span class="hljs-number">0</span>)</span><br><span class="line">			&#123;</span><br><span class="line">				tmp[j] /= i;</span><br><span class="line">				<span class="hljs-keyword">break</span>;</span><br><span class="line">			&#125;</span><br><span class="line">	ll ans = tmp[<span class="hljs-number">0</span>] * tmp[<span class="hljs-number">1</span>] * tmp[<span class="hljs-number">2</span>];</span><br><span class="line">	tmp[<span class="hljs-number">0</span>] = n - <span class="hljs-number">1</span> &gt;&gt; <span class="hljs-number">1</span>;</span><br><span class="line">	tmp[<span class="hljs-number">1</span>] = tmp[<span class="hljs-number">0</span>] - <span class="hljs-number">1</span>;</span><br><span class="line">	tmp[<span class="hljs-number">2</span>] = n;</span><br><span class="line">	<span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> j = <span class="hljs-number">0</span>, i = <span class="hljs-number">2</span>; j &lt; <span class="hljs-number">3</span>; ++j)</span><br><span class="line">		<span class="hljs-keyword">if</span> (tmp[j] % i == <span class="hljs-number">0</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			tmp[j] /= i;</span><br><span class="line">			<span class="hljs-keyword">break</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	ans -= tmp[<span class="hljs-number">0</span>] * tmp[<span class="hljs-number">1</span>] * tmp[<span class="hljs-number">2</span>];</span><br><span class="line">	<span class="hljs-keyword">if</span> (a != b &amp;&amp; b != c &amp;&amp; c != a)</span><br><span class="line">		ans *= <span class="hljs-number">6</span>;</span><br><span class="line">	<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (a != b || b != c || c != a)</span><br><span class="line">		ans *= <span class="hljs-number">3</span>;</span><br><span class="line">	<span class="hljs-built_in">printf</span>(<span class="hljs-string">"%llu"</span>, ans);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="Tree"><a href="#Tree" class="headerlink" title="Tree"></a><a href="https://vjudge.net/problem/Gym-101964C" target="_blank" rel="noopener">Tree</a></h1><figure class="highlight cpp hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;bits/stdc++.h&gt;</span></span></span><br><span class="line"><span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> <span class="hljs-built_in">std</span>;</span><br><span class="line"><span class="hljs-keyword">const</span> <span class="hljs-keyword">int</span> N = <span class="hljs-number">127</span>, INF = <span class="hljs-number">1e9</span>;</span><br><span class="line"><span class="hljs-built_in">vector</span>&lt;<span class="hljs-keyword">int</span>&gt; g[N];</span><br><span class="line"><span class="hljs-keyword">int</span> n, m, ans = INF, p[N], a[N][N];</span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span></span><br><span class="line"><span class="hljs-function"></span>&#123;</span><br><span class="line">	<span class="hljs-built_in">scanf</span>(<span class="hljs-string">"%d%d"</span>, &amp;n, &amp;m);</span><br><span class="line">	<span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; n; ++i)</span><br><span class="line">	&#123;</span><br><span class="line">		fill(a[i], a[i] + n, INF);</span><br><span class="line">		a[i][i] = <span class="hljs-number">0</span>;</span><br><span class="line">		<span class="hljs-built_in">scanf</span>(<span class="hljs-string">"%d"</span>, &amp;p[i]);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">1</span>, u, v; i &lt; n; ++i)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="hljs-built_in">scanf</span>(<span class="hljs-string">"%d%d"</span>, &amp;u, &amp;v);</span><br><span class="line">		g[--u].push_back(--v);</span><br><span class="line">		g[v].push_back(u);</span><br><span class="line">		a[u][v] = a[v][u] = <span class="hljs-number">1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> k = <span class="hljs-number">0</span>; k &lt; n; ++k)</span><br><span class="line">		<span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; n; ++i)</span><br><span class="line">			<span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> j = <span class="hljs-number">0</span>; j &lt; n; ++j)</span><br><span class="line">				a[i][j] = min(a[i][j], a[i][k] + a[k][j]);</span><br><span class="line">	<span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; n; ++i)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="hljs-built_in">vector</span>&lt;<span class="hljs-keyword">int</span>&gt; vis(n, <span class="hljs-number">0</span>), v;</span><br><span class="line">		<span class="hljs-keyword">for</span> (<span class="hljs-built_in">deque</span>&lt;<span class="hljs-keyword">int</span>&gt; q(vis[i] = <span class="hljs-number">1</span>, i);; q.pop_front())</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="hljs-keyword">if</span> (p[q.front()])</span><br><span class="line">				v.push_back(q.front());</span><br><span class="line">			<span class="hljs-keyword">if</span> (v.size() &gt;= m)</span><br><span class="line">				<span class="hljs-keyword">break</span>;</span><br><span class="line">			<span class="hljs-keyword">for</span> (<span class="hljs-keyword">auto</span> to : g[q.front()])</span><br><span class="line">				<span class="hljs-keyword">if</span> (!vis[to])</span><br><span class="line">					q.push_back(to), vis[to] = <span class="hljs-number">1</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="hljs-keyword">int</span> tmp = <span class="hljs-number">0</span>;</span><br><span class="line">		<span class="hljs-keyword">for</span> (<span class="hljs-keyword">auto</span> j : v)</span><br><span class="line">			<span class="hljs-keyword">for</span> (<span class="hljs-keyword">auto</span> k : v)</span><br><span class="line">				tmp = max(tmp, a[j][k]);</span><br><span class="line">		ans = min(ans, tmp);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="hljs-built_in">printf</span>(<span class="hljs-string">"%d"</span>, ans);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="Fishermen"><a href="#Fishermen" class="headerlink" title="Fishermen"></a><a href="https://vjudge.net/problem/Gym-101964E" target="_blank" rel="noopener">Fishermen</a></h1><p>理解这个题的意思之后提出一种新的方案：计算每条🐟对答案的贡献。因为懒的离散化，这里用风骚的动态开点线段树做掉。</p>

undefined


<figure class="highlight cpp hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;bits/stdc++.h&gt;</span></span></span><br><span class="line"><span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> <span class="hljs-built_in">std</span>;</span><br><span class="line"><span class="hljs-keyword">const</span> <span class="hljs-keyword">int</span> N = <span class="hljs-number">2e5</span> + <span class="hljs-number">9</span>;</span><br><span class="line"><span class="hljs-keyword">typedef</span> <span class="hljs-keyword">int</span> ll;</span><br><span class="line"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">BaseFenwick</span></span></span><br><span class="line"><span class="hljs-class">&#123;</span></span><br><span class="line">	<span class="hljs-built_in">vector</span>&lt;ll&gt; v;</span><br><span class="line">	BaseFenwick(<span class="hljs-keyword">int</span> n) : v(n, <span class="hljs-number">0</span>) &#123;&#125;</span><br><span class="line">	<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">add</span><span class="hljs-params">(<span class="hljs-keyword">int</span> x, ll w)</span></span></span><br><span class="line"><span class="hljs-function">	</span>&#123;</span><br><span class="line">		<span class="hljs-keyword">for</span> (; x &lt; v.size(); x += x &amp; -x)</span><br><span class="line">			v[x] += w;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="hljs-function">ll <span class="hljs-title">ask</span><span class="hljs-params">(<span class="hljs-keyword">int</span> x)</span></span></span><br><span class="line"><span class="hljs-function">	</span>&#123;</span><br><span class="line">		ll ans = <span class="hljs-number">0</span>;</span><br><span class="line">		<span class="hljs-keyword">for</span> (; x; x -= x &amp; -x)</span><br><span class="line">			ans += v[x];</span><br><span class="line">		<span class="hljs-keyword">return</span> ans;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">Point</span></span></span><br><span class="line"><span class="hljs-class">&#123;</span></span><br><span class="line">	<span class="hljs-keyword">int</span> x, y, id;</span><br><span class="line">	<span class="hljs-keyword">bool</span> <span class="hljs-keyword">operator</span>&lt;(<span class="hljs-keyword">const</span> Point &amp;rhs) <span class="hljs-keyword">const</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="hljs-keyword">if</span> (x != rhs.x)</span><br><span class="line">			<span class="hljs-keyword">return</span> x &lt; rhs.x;</span><br><span class="line">		<span class="hljs-keyword">if</span> (y != rhs.y)</span><br><span class="line">			y &lt; rhs.y;</span><br><span class="line">		<span class="hljs-keyword">return</span> id &lt; rhs.id;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">Ranker</span> :</span> <span class="hljs-built_in">vector</span>&lt;<span class="hljs-keyword">int</span>&gt;</span><br><span class="line">&#123;</span><br><span class="line">	<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">init</span><span class="hljs-params">()</span></span></span><br><span class="line"><span class="hljs-function">	</span>&#123;</span><br><span class="line">		sort(begin(), end()), resize(unique(begin(), end()) - begin());</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">ask</span><span class="hljs-params">(<span class="hljs-keyword">int</span> y)</span></span></span><br><span class="line"><span class="hljs-function">	</span>&#123;</span><br><span class="line">		<span class="hljs-keyword">return</span> lower_bound(begin(), end(), y) - begin();</span><br><span class="line">	&#125;</span><br><span class="line">&#125; rk;</span><br><span class="line"><span class="hljs-keyword">int</span> n, m, l, ans[N];</span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span></span><br><span class="line"><span class="hljs-function"></span>&#123;</span><br><span class="line">	<span class="hljs-built_in">vector</span>&lt;Point&gt; p;</span><br><span class="line">	<span class="hljs-built_in">scanf</span>(<span class="hljs-string">"%d%d%d"</span>, &amp;n, &amp;m, &amp;l);</span><br><span class="line">	<span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>, x, y; i &lt; n; ++i)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="hljs-built_in">scanf</span>(<span class="hljs-string">"%d%d"</span>, &amp;x, &amp;y);</span><br><span class="line">		p.push_back(&#123;y + x, y - x, <span class="hljs-number">-1</span>&#125;);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>, x; i &lt; m; ++i)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="hljs-built_in">scanf</span>(<span class="hljs-string">"%d"</span>, &amp;x);</span><br><span class="line">		p.push_back(&#123;l + x, l - x, i&#125;);</span><br><span class="line">	&#125;</span><br><span class="line">	sort(p.begin(), p.end());</span><br><span class="line">	<span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; p.size(); ++i)</span><br><span class="line">		rk.push_back(p[i].y);</span><br><span class="line">	rk.init();</span><br><span class="line">	<span class="hljs-function">BaseFenwick <span class="hljs-title">t</span><span class="hljs-params">(rk.size() + <span class="hljs-number">9</span>)</span></span>;</span><br><span class="line">	<span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>, j = <span class="hljs-number">0</span>; i &lt; p.size(); ++i)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="hljs-keyword">for</span> (; p[j].x &lt; p[i].x - l * <span class="hljs-number">2</span>; ++j)</span><br><span class="line">			<span class="hljs-keyword">if</span> (p[j].id &lt; <span class="hljs-number">0</span>)</span><br><span class="line">				t.add(rk.ask(p[j].y) + <span class="hljs-number">1</span>, <span class="hljs-number">-1</span>);</span><br><span class="line">		<span class="hljs-keyword">if</span> (p[i].id &lt; <span class="hljs-number">0</span>)</span><br><span class="line">			t.add(rk.ask(p[i].y) + <span class="hljs-number">1</span>, <span class="hljs-number">1</span>);</span><br><span class="line">		<span class="hljs-keyword">else</span></span><br><span class="line">			ans[p[i].id] = t.ask(rk.ask(p[i].y) + <span class="hljs-number">1</span>) - t.ask(rk.ask(p[i].y - l * <span class="hljs-number">2</span>));</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; m; ++i)</span><br><span class="line">		<span class="hljs-built_in">printf</span>(<span class="hljs-string">"%d\n"</span>, ans[i]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="Inversion"><a href="#Inversion" class="headerlink" title="Inversion"></a><a href="https://vjudge.net/problem/Gym-101964I" target="_blank" rel="noopener">Inversion</a></h1><p>首先，我们要把原序列还原，根据逆序对的性质，还原出原序列。接着，根据题意两个对集合的定义，可以知道选出的那个点集是从左到右升序的，且点集中最小的点在序列中左边没有比它更小的点，最大的点在序列中右边没有比它更大的点，所以我们可以进行dp，dp[i]表示以i为点集最后一个点的答案的数量。</p>
<figure class="highlight cpp hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;bits/stdc++.h&gt;</span></span></span><br><span class="line"><span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> <span class="hljs-built_in">std</span>;</span><br><span class="line"><span class="hljs-keyword">typedef</span> <span class="hljs-keyword">long</span> <span class="hljs-keyword">long</span> ll;</span><br><span class="line"><span class="hljs-keyword">const</span> <span class="hljs-keyword">int</span> N = <span class="hljs-number">127</span>;</span><br><span class="line">ll f[N];</span><br><span class="line"><span class="hljs-keyword">int</span> n, m, d[N], p[N], vis[N];</span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span></span><br><span class="line"><span class="hljs-function"></span>&#123;</span><br><span class="line">	<span class="hljs-built_in">scanf</span>(<span class="hljs-string">"%d%d"</span>, &amp;n, &amp;m);</span><br><span class="line">	<span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>, x, y; i &lt; m; ++i)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="hljs-built_in">scanf</span>(<span class="hljs-string">"%d%d"</span>, &amp;x, &amp;y);</span><br><span class="line">		++d[min(--x, --y)];</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; n; ++i)</span><br><span class="line">		<span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> j = <span class="hljs-number">0</span>; j &lt; n; ++j)</span><br><span class="line">			<span class="hljs-keyword">if</span> (!vis[j])</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="hljs-keyword">if</span> (d[i])</span><br><span class="line">					--d[i];</span><br><span class="line">				<span class="hljs-keyword">else</span></span><br><span class="line">				&#123;</span><br><span class="line">					p[i] = j;</span><br><span class="line">					vis[j] = <span class="hljs-number">1</span>;</span><br><span class="line">					<span class="hljs-keyword">break</span>;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">	p[n] = n;</span><br><span class="line">	<span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt;= n; ++i)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> j = i - <span class="hljs-number">1</span>, mx = <span class="hljs-number">-1</span>; ~j; --j)</span><br><span class="line">			<span class="hljs-keyword">if</span> (mx &lt; p[j] &amp;&amp; p[j] &lt; p[i])</span><br><span class="line">				mx = p[j], f[i] += f[j];</span><br><span class="line">		f[i] = max(<span class="hljs-number">1L</span>L, f[i]);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="hljs-built_in">printf</span>(<span class="hljs-string">"%lld"</span>, f[n]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


        </div>
        
        
        
    </div>
</div>








    <div class="card">
    
    <div class="card-content article ">
        
        <div class="level article-meta is-size-7 is-uppercase is-mobile is-overflow-x-auto">
            <div class="level-left">
                <time class="level-item has-text-grey" datetime="2019-04-10T16:08:06.397Z">2019-04-11</time>
                
                <div class="level-item">
                <a class="has-link-grey -link" href="/categories/操作系统/">操作系统</a>
                </div>
                
                
                <span class="level-item has-text-grey">
                    
                    
                    14 分钟 读完 (大约 2116 个字)
                </span>
                
                
            </div>
        </div>
        
        <h1 class="title is-size-3 is-size-4-mobile has-text-weight-normal">
            
                <a class="has-link-black-ter" href="/2019/04/11/2019-03-18-加载用户程序的监控程序/"></a>
            
        </h1>
        <div class="content">
            <h1 id="实验题目"><a href="#实验题目" class="headerlink" title="实验题目"></a>实验题目</h1><p>加载用户程序的监控程序</p>
<h1 id="实验目的"><a href="#实验目的" class="headerlink" title="实验目的"></a>实验目的</h1><ul>
<li>掌握常用的 BIOS 调用</li>
<li>掌握 BIOS 编程</li>
<li>掌握加载用户程序的方法</li>
</ul>
<h1 id="实验要求"><a href="#实验要求" class="headerlink" title="实验要求"></a>实验要求</h1><ul>
<li>设计四个有输出的用户可执行程序，分别在屏幕1/4区域动态输出字符，如将用字符‘A’从屏幕左边某行位置45度角下斜射出，保持一个可观察的适当速度直线运动，碰到屏幕相应1/4区域的边后产生反射，改变方向运动，如此类推，不断运动；在此基础上，增加你的个性扩展，如同时控制两个运动的轨迹，或炫酷动态变色，个性画面，如此等等，自由不限。还要在屏幕某个区域特别的方式显示你的学号姓名等个人信息。</li>
<li>修改参考原型代码，允许键盘输入，用于指定运行这四个有输出的用户可执行程序之一，要确保系统执行代码不超过512字节，以便放在引导扇区</li>
<li>自行组织映像盘的空间存放四个用户可执行程序。</li>
</ul>
<h1 id="实验方案"><a href="#实验方案" class="headerlink" title="实验方案"></a>实验方案</h1><h2 id="实验环境"><a href="#实验环境" class="headerlink" title="实验环境"></a>实验环境</h2><h3 id="软件"><a href="#软件" class="headerlink" title="软件"></a>软件</h3><ul>
<li>Windows 10, 64-bit  (Build 17763) 10.0.17763</li>
<li>Windows Subsystem for Linux [Ubuntu 18.04.2 LTS]：WSL是以软件的形式运行在Windows下的Linux子系统，是近些年微软推出来的新工具，可以在Windows系统上原生运行Linux。</li>
<li>gcc version 7.3.0 (Ubuntu 7.3.0-27ubuntu1~18.04)：C语言程序编译器，Ubuntu自带。</li>
<li>NASM version 2.13.02：汇编程序编译器，通过<code>sudo apt install nasm</code>安装在WSL上。</li>
<li>Oracle VM VirtualBox 6.0.4 r128413 (Qt5.6.2)：轻量开源的虚拟机软件。</li>
<li>VSCode - Insiders v1.33.0：好用的文本编辑器，有丰富的插件。</li>
<li>hexdump for VSCode 1.7.2: VSCode中一个好用的十六进制显示插件。</li>
</ul>
<p>大部分开发环境安装在WSL上，较之于双系统、虚拟机等其他开发方案，更加方便，也方便直接使用Linux下的一些指令。</p>
<h3 id="硬件"><a href="#硬件" class="headerlink" title="硬件"></a>硬件</h3><h4 id="开发环境配置"><a href="#开发环境配置" class="headerlink" title="开发环境配置"></a>开发环境配置</h4><p>所用机器型号为VAIO Z Flip 2016</p>
<ul>
<li>Intel(R) Core(TM) i7-6567U CPU @3.30GHZ 3.31GHz</li>
<li>8.00GB RAM</li>
</ul>
<h4 id="虚拟机配置"><a href="#虚拟机配置" class="headerlink" title="虚拟机配置"></a>虚拟机配置</h4><ul>
<li>处理器内核总数：1</li>
<li>RAM：4MB</li>
</ul>
<h2 id="实验原理"><a href="#实验原理" class="headerlink" title="实验原理"></a>实验原理</h2><p>与<a href="https://wu-kan.github.io/操作系统/裸机控制权与引导程序" target="_blank" rel="noopener">前一个实验</a>差不多。</p>
<ol>
<li>虚拟软盘的第一个扇区用于存储主引导程序（即监控程序），需要保证最后两个字节为<code>55aa</code>。验证主引导程序有效后，跳转到<code>7c00h</code>开始执行。</li>
<li>引导程序接受键盘输入，选择程序，随后从软盘加载指定程序扇区的内容到内存并跳转执行。</li>
<li>中断标号<code>0x00</code>到<code>0x13</code>已经具有功能，<code>0x14</code>到<code>0x1f</code>为保留标号，<code>0x20</code>到<code>0xff</code>提供给用户自定义中断。因此定义<code>0x20h</code>号中断用于从用户程序返回监控程序。</li>
<li>在用户程序的循环中需要加入软件中断<code>int 20h</code>，用于监测是否有键盘返回，如果有则返回监控程序，否则继续执行。</li>
</ol>
<h1 id="实验过程"><a href="#实验过程" class="headerlink" title="实验过程"></a>实验过程</h1><h2 id="a-asm"><a href="#a-asm" class="headerlink" title="a.asm"></a>a.asm</h2><p>本次实验要求写 4 个用户程序，分别是在屏幕的4个象限中弹来弹去。四个代码的程序几乎相同，只需要修改某些常量和变量的定义即可。这里只给出其中一个程序的代码。</p>
<p>另外，本想直接用<a href="https://wu-kan.github.io/操作系统/裸机控制权与引导程序" target="_blank" rel="noopener">前一个实验</a>的<code>c.asm</code>，却发现老师只考虑了边反射的情况，没有考虑四个角反射的情况，这会导致显示的内容从角飞出，在屏幕中乱飞。于是再次重构这段代码，使得编译后大小仅137bytes：</p>
<ul>
<li>加载地址修改成<code>org 0A100h</code>，表明用户程序读入内存应从内存物理地址0A100h开始。</li>
<li>重新修改横纵坐标的变化方式，改为根据运行周期自动变化。</li>
<li>修改字符串显示方式，改为调用<code>int 10h</code>实现，并写了一个<code>%macro print</code>来简化这一过程（造轮子）,仍然支持根据行号自动变色。</li>
<li>屏幕显示空出前两行，用于显示引导程序的提示信息。</li>
</ul>
<figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line">%macro print 4	; string, length, x, y</span><br><span class="line">	mov ax, cs</span><br><span class="line">	mov ds, ax</span><br><span class="line">	mov bp, %1</span><br><span class="line">	mov ax, ds</span><br><span class="line">	mov es, ax</span><br><span class="line">	mov cx, %2</span><br><span class="line">	mov ah, 13h</span><br><span class="line">	mov al, 00h</span><br><span class="line">	mov bh, 00h</span><br><span class="line">	mov bl, %3	; 根据行号自动变色</span><br><span class="line">	mov dh, %3</span><br><span class="line">	mov dl, %4</span><br><span class="line">	int 10h</span><br><span class="line">%endmacro</span><br><span class="line"></span><br><span class="line">	N equ 12	;显示区域高度</span><br><span class="line">	M equ 32	;显示区域宽度减去字符串长度</span><br><span class="line">	TOP equ 2	;显示区域上端点</span><br><span class="line">	LEFT equ 40	;显示区域左端点</span><br><span class="line">	LENGTH equ 8	;字符串的长度</span><br><span class="line">	DELAY equ 99999999</span><br><span class="line">	org 0A100h</span><br><span class="line">	mov ax,0B800h</span><br><span class="line">	mov gs,ax	; GS = 0xB800h，文本窗口显存起始地址</span><br><span class="line"></span><br><span class="line">myLoop:</span><br><span class="line">	dec dword[count]	; 递减计数变量</span><br><span class="line">	jnz myLoop	; &gt;0：跳转</span><br><span class="line">	mov dword[count], DELAY</span><br><span class="line"></span><br><span class="line">	mov word ax, [t]	; ax = t</span><br><span class="line">	mov word bx,2*N-2</span><br><span class="line">	xor dx, dx	; clear dx and prepare for division</span><br><span class="line">	div bx  ; dx = t mod (2N - 2)</span><br><span class="line">	cmp dx, N ; compare dx and n</span><br><span class="line">	jb xok  ; if (dx &lt; n) jump xok</span><br><span class="line">	sub bx, dx</span><br><span class="line">	mov dx, bx ; dx = 2n - 2 - dx</span><br><span class="line">xok:</span><br><span class="line">	mov word[x], dx</span><br><span class="line">	add word[x], TOP</span><br><span class="line"></span><br><span class="line">	mov word ax, [t]</span><br><span class="line">	mov word bx, 2*M-2</span><br><span class="line">	xor dx, dx</span><br><span class="line">	div bx</span><br><span class="line">	cmp dx, M</span><br><span class="line">	jb yok</span><br><span class="line">	sub bx, dx</span><br><span class="line">	mov dx, bx</span><br><span class="line">yok:</span><br><span class="line">	mov word [y],dx</span><br><span class="line">	add word [y],LEFT</span><br><span class="line"></span><br><span class="line">	inc word[t]</span><br><span class="line">	print message, LENGTH, [x], [y]</span><br><span class="line">	int 20h</span><br><span class="line">	jmp myLoop</span><br><span class="line">datadef:</span><br><span class="line">	count dd 1</span><br><span class="line">	t dw 0</span><br><span class="line">	x dw 1</span><br><span class="line">	y dw 0</span><br><span class="line">	message db &apos; wu-kan &apos;</span><br></pre></td></tr></table></figure>

<h2 id="wukos-asm"><a href="#wukos-asm" class="headerlink" title="wukos.asm"></a>wukos.asm</h2><p>引导扇区的 bootloader，其功能有：</p>
<ul>
<li>显示正在运行的是哪一个程序，或是选择页面提示语。</li>
<li>使用<code>int 13h</code>读取扇区，并把它放到内存合适的位置上。</li>
<li>使用<code>int 16h</code>读取键盘输入，用于选择程序。</li>
</ul>
<p>这里遇到一个问题，就是直接使用上面自动变色的程序时没有显示。因前两行的x坐标恰好对应了颜色中的黑底黑字。因此修改显示颜色<code>mov bl, 07h</code>（黑底白字）即可。</p>
<figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line">OffSetOfUserPrg equ 0A100h</span><br><span class="line">org  7c00h</span><br><span class="line">%macro print 4	; string, length, x, y</span><br><span class="line">	mov ax, cs</span><br><span class="line">	mov ds, ax</span><br><span class="line">	mov bp, %1</span><br><span class="line">	mov ax, ds</span><br><span class="line">	mov es, ax</span><br><span class="line">	mov cx, %2</span><br><span class="line">	mov ah, 13h</span><br><span class="line">	mov al, 00h</span><br><span class="line">	mov bh, 00h</span><br><span class="line">	mov bl, 07h	; 黑底白字</span><br><span class="line">	mov dh, %3</span><br><span class="line">	mov dl, %4</span><br><span class="line">	int 10h</span><br><span class="line">%endmacro</span><br><span class="line"></span><br><span class="line">mov ax, 0000h</span><br><span class="line">mov es, ax</span><br><span class="line">mov ax, 20h</span><br><span class="line">mov bx, 4</span><br><span class="line">mul bx</span><br><span class="line">mov si, ax</span><br><span class="line">mov ax, _int20h</span><br><span class="line">mov [es:si], ax</span><br><span class="line">add si, 2</span><br><span class="line">mov ax, cs</span><br><span class="line">mov [es:si], ax</span><br><span class="line">begin:</span><br><span class="line">	call cls</span><br><span class="line">	print msg, msglen, 0, 0</span><br><span class="line">input:</span><br><span class="line">	mov ah, 0</span><br><span class="line">	int 16h</span><br><span class="line">	cmp al, &apos;1&apos;</span><br><span class="line">	jl input</span><br><span class="line">	cmp al, &apos;4&apos;</span><br><span class="line">	jg input</span><br><span class="line">	mov [sectorNum], al</span><br><span class="line">	call cls</span><br><span class="line">	print msg1, msglen1, 0, 0</span><br><span class="line">	print sectorNum, 1, 0, 16</span><br><span class="line"></span><br><span class="line">	mov cl, [sectorNum]</span><br><span class="line">	sub cl, &apos;0&apos;-1  ;从第二个扇区开始</span><br><span class="line">	mov ax, cs</span><br><span class="line">	mov es, ax</span><br><span class="line">	mov ah, 2</span><br><span class="line">	mov al, 1</span><br><span class="line">	mov dl, 0</span><br><span class="line">	mov dh, 0</span><br><span class="line">	mov ch, 0</span><br><span class="line">	mov bx, OffSetOfUserPrg</span><br><span class="line">	int 13H</span><br><span class="line">	jmp OffSetOfUserPrg</span><br><span class="line">cls:</span><br><span class="line">	mov ax, 0B800h</span><br><span class="line">	mov es, ax</span><br><span class="line">	mov si, 0</span><br><span class="line">	mov cx, 80*25</span><br><span class="line">	mov dx, 0</span><br><span class="line">	clsLoop:</span><br><span class="line">		mov [es:si], dx</span><br><span class="line">		add si, 2</span><br><span class="line">	loop clsLoop</span><br><span class="line">	ret</span><br><span class="line">int20h:</span><br><span class="line">	mov ah, 01h</span><br><span class="line">	int 16h</span><br><span class="line">	jz noclick</span><br><span class="line">	mov ah, 00h</span><br><span class="line">	int 16h</span><br><span class="line">	cmp ax, 2e03h	; 检测Ctrl + C</span><br><span class="line">	jne noclick</span><br><span class="line">	jmp begin</span><br><span class="line">noclick:</span><br><span class="line">	iret</span><br><span class="line">datadef:</span><br><span class="line">	msg db &apos;Welcome to WuKOS, press 1~4 to run a program.&apos;</span><br><span class="line">	msglen equ ($-msg)</span><br><span class="line">	msg1 db &apos;This is program 0, press Ctrl + C to return.&apos;</span><br><span class="line">	msglen1 equ ($-msg1)</span><br><span class="line">	sectorNum db &apos;1&apos;</span><br></pre></td></tr></table></figure>

<h2 id="编译烧盘"><a href="#编译烧盘" class="headerlink" title="编译烧盘"></a>编译烧盘</h2><p>在WSL终端下按顺序执行下述指令。主引导程序存储在虚拟软盘的第一个扇区，第一个用户程序存储在第二个扇区，第二个用户程序存储在第三个扇区，以此类推。</p>
<figure class="highlight bash hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">nasm wukos.asm -o wukos.com</span><br><span class="line">nasm a.asm -o a.com</span><br><span class="line">nasm b.asm -o b.com</span><br><span class="line">nasm c.asm -o c.com</span><br><span class="line">nasm d.asm -o d.com</span><br><span class="line">/sbin/mkfs.msdos -C wukos.img 1440</span><br><span class="line">dd <span class="hljs-keyword">if</span>=wukos.com of=wukos.img conv=notrunc</span><br><span class="line">dd <span class="hljs-keyword">if</span>=a.com of=wukos.img seek=1 conv=notrunc</span><br><span class="line">dd <span class="hljs-keyword">if</span>=b.com of=wukos.img seek=2 conv=notrunc</span><br><span class="line">dd <span class="hljs-keyword">if</span>=c.com of=wukos.img seek=3 conv=notrunc</span><br><span class="line">dd <span class="hljs-keyword">if</span>=d.com of=wukos.img seek=4 conv=notrunc</span><br></pre></td></tr></table></figure>

<h2 id="运行结果"><a href="#运行结果" class="headerlink" title="运行结果"></a>运行结果</h2><h3 id="引导界面"><a href="#引导界面" class="headerlink" title="引导界面"></a>引导界面</h3><p><img src="/2019/04/11/2019-03-18-加载用户程序的监控程序/image/2019-03-18-0.png" alt></p>
<h3 id="程序1"><a href="#程序1" class="headerlink" title="程序1"></a>程序1</h3><p><img src="/2019/04/11/2019-03-18-加载用户程序的监控程序/image/2019-03-18-1.png" alt><br>显示姓名。</p>
<h3 id="程序2"><a href="#程序2" class="headerlink" title="程序2"></a>程序2</h3><p><img src="/2019/04/11/2019-03-18-加载用户程序的监控程序/image/2019-03-18-2.png" alt><br>显示学号。</p>
<h3 id="程序3"><a href="#程序3" class="headerlink" title="程序3"></a>程序3</h3><p><img src="/2019/04/11/2019-03-18-加载用户程序的监控程序/image/2019-03-18-3.png" alt><br>显示邮箱。</p>
<h3 id="程序4"><a href="#程序4" class="headerlink" title="程序4"></a>程序4</h3><p><img src="/2019/04/11/2019-03-18-加载用户程序的监控程序/image/2019-03-18-4.png" alt><br>显示博客。</p>
<h1 id="实验总结"><a href="#实验总结" class="headerlink" title="实验总结"></a>实验总结</h1><p>重写了之前的代码，没有想到本来上次已经很小的290bytes还能压到更小的137bytes…</p>
<p>还遇到了根据行号变色时第一行看不到输出的原因，仔细思考和查阅网上资料后发现00h用于表示不显示，在自动变色行号为0的时候就会导致看不到输出。</p>
<p>现在对<code>org 7c00h</code>等语句有了更深的理解了。</p>

        </div>
        
        
        
    </div>
</div>








    <div class="card">
    
    <div class="card-content article ">
        
        <div class="level article-meta is-size-7 is-uppercase is-mobile is-overflow-x-auto">
            <div class="level-left">
                <time class="level-item has-text-grey" datetime="2019-04-10T16:08:06.397Z">2019-04-11</time>
                
                <div class="level-item">
                <a class="has-link-grey -link" href="/categories/操作系统/">操作系统</a>
                </div>
                
                
                <span class="level-item has-text-grey">
                    
                    
                    25 分钟 读完 (大约 3684 个字)
                </span>
                
                
            </div>
        </div>
        
        <h1 class="title is-size-3 is-size-4-mobile has-text-weight-normal">
            
                <a class="has-link-black-ter" href="/2019/04/11/2019-03-13-裸机控制权与引导程序/"></a>
            
        </h1>
        <div class="content">
            <h1 id="实验题目"><a href="#实验题目" class="headerlink" title="实验题目"></a>实验题目</h1><p>裸机控制权与引导程序</p>
<h1 id="实验目的"><a href="#实验目的" class="headerlink" title="实验目的"></a>实验目的</h1><ul>
<li>掌握NASM的语法</li>
<li>掌握用汇编器的用法</li>
<li>掌握创建空白软盘镜像的方法</li>
<li>掌握虚拟机的设置及使用方法</li>
</ul>
<h1 id="实验要求"><a href="#实验要求" class="headerlink" title="实验要求"></a>实验要求</h1><h2 id="搭建和应用实验环境"><a href="#搭建和应用实验环境" class="headerlink" title="搭建和应用实验环境"></a>搭建和应用实验环境</h2><p>虚拟机安装，生成一个基本配置的虚拟机XXXPC和多个1.44MB容量的虚拟软盘，将其中一个虚拟软盘用DOS格式化为DOS引导盘，用WinHex工具将其中一个虚拟软盘的首扇区填满你的个人信息。</p>
<h2 id="接管裸机的控制权"><a href="#接管裸机的控制权" class="headerlink" title="接管裸机的控制权"></a>接管裸机的控制权</h2><p>设计IBM_PC的一个引导扇区程序，程序功能是：用字符‘A’从屏幕左边某行位置45度角下斜射出，保持一个可观察的适当速度直线运动，碰到屏幕的边后产生反射，改变方向运动，如此类推，不断运动；在此基础上，增加你的个性扩展，如同时控制两个运动的轨迹，或炫酷动态变色，个性画面，如此等等，自由不限。还要在屏幕某个区域特别的方式显示你的学号姓名等个人信息。将这个程序的机器码放进放进第三张虚拟软盘的首扇区，并用此软盘引导你的XXXPC，直到成功。</p>
<h1 id="实验方案"><a href="#实验方案" class="headerlink" title="实验方案"></a>实验方案</h1><h2 id="实验环境"><a href="#实验环境" class="headerlink" title="实验环境"></a>实验环境</h2><h3 id="软件"><a href="#软件" class="headerlink" title="软件"></a>软件</h3><ul>
<li>Windows 10, 64-bit  (Build 17763) 10.0.17763</li>
<li>Windows Subsystem for Linux [Ubuntu 18.04.2 LTS]：WSL是以软件的形式运行在Windows下的Linux子系统，是近些年微软推出来的新工具，可以在Windows系统上原生运行Linux。</li>
<li>gcc version 7.3.0 (Ubuntu 7.3.0-27ubuntu1~18.04)：C语言程序编译器，Ubuntu自带。</li>
<li>NASM version 2.13.02：汇编程序编译器，通过<code>sudo apt install nasm</code>安装在WSL上。</li>
<li>Oracle VM VirtualBox 6.0.4 r128413 (Qt5.6.2)：轻量开源的虚拟机软件。</li>
<li>VSCode - Insiders v1.33.0：好用的文本编辑器，有丰富的插件。</li>
<li>hexdump for VSCode 1.7.2: VSCode中一个好用的十六进制显示插件。</li>
</ul>
<p>这里，没有使用老师推荐的WinHex来打开十六进制，而是使用了VSCode下一个相对好用的插件来查看十六进制；同时，向软盘内填充信息可以直接敲代码解决。</p>
<p>此外，大部分开发环境安装在WSL上，较之于双系统、虚拟机等其他开发方案，更加方便，也方便直接使用Linux下的一些指令。</p>
<h3 id="硬件"><a href="#硬件" class="headerlink" title="硬件"></a>硬件</h3><h4 id="开发环境配置"><a href="#开发环境配置" class="headerlink" title="开发环境配置"></a>开发环境配置</h4><p>所用机器型号为VAIO Z Flip 2016</p>
<ul>
<li>Intel(R) Core(TM) i7-6567U CPU @3.30GHZ 3.31GHz</li>
<li>8.00GB RAM</li>
</ul>
<h4 id="虚拟机配置"><a href="#虚拟机配置" class="headerlink" title="虚拟机配置"></a>虚拟机配置</h4><ul>
<li>处理器内核总数：1</li>
<li>RAM：4MB</li>
</ul>
<h1 id="实验过程"><a href="#实验过程" class="headerlink" title="实验过程"></a>实验过程</h1><h2 id="搭建和应用实验环境-1"><a href="#搭建和应用实验环境-1" class="headerlink" title="搭建和应用实验环境"></a>搭建和应用实验环境</h2><h3 id="安装、配置虚拟机"><a href="#安装、配置虚拟机" class="headerlink" title="安装、配置虚拟机"></a>安装、配置虚拟机</h3><ol>
<li>打开Oracle VM VirtualBox</li>
<li>点新建，名称填“WuKPC”，并指定位置，类型选“Other”，版本选择“Other/Unknown”，点“下一步”</li>
<li>内存选4MB</li>
<li>选不添加虚拟硬盘</li>
</ol>
<h3 id="创建并格式化虚拟软盘"><a href="#创建并格式化虚拟软盘" class="headerlink" title="创建并格式化虚拟软盘"></a>创建并格式化虚拟软盘</h3><p>Linux上可以直接用如下的指令创建虚拟软盘，其中要注意的是1.44MB=1440KB。</p>
<figure class="highlight bash hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/sbin/mkfs.msdos -C a.img 1440</span><br></pre></td></tr></table></figure>

<p>同目录下出现<code>a.img</code>，得到如下反馈</p>
<figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkfs.fat 4.1 (2017-01-24)</span><br></pre></td></tr></table></figure>

<p>这说明生成的虚拟软盘已经自动格式化了。打开“设置”-“存储”-“添加软盘驱动器”-“完成”，然后在新生成的控制器中添加虚拟软驱，点“注册”，打开刚刚生成的“a.img”，并确认。现在开启虚拟机，发现虚拟机的屏幕上已经有了显示:</p>
<p><img src="/2019/04/11/2019-03-13-裸机控制权与引导程序/image/2019-03-13-1.png" alt></p>
<p>这说明虚拟软盘格式化成功。</p>
<h3 id="填满个人信息"><a href="#填满个人信息" class="headerlink" title="填满个人信息"></a>填满个人信息</h3><p>使用hexdump for VSCode打开刚刚创建的<code>a.img</code>，发现其有着如下的结构（以下仅截取前三十四行）:</p>
<figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">  Offset: 00 01 02 03 04 05 06 07 08 09 0A 0B 0C 0D 0E 0F</span><br><span class="line">00000000: EB 3C 90 6D 6B 66 73 2E 66 61 74 00 02 01 01 00    k&lt;.mkfs.fat.....</span><br><span class="line">00000010: 02 E0 00 40 0B F0 09 00 12 00 02 00 00 00 00 00    .`.@.p..........</span><br><span class="line">00000020: 00 00 00 00 00 00 29 95 B1 98 3C 4E 4F 20 4E 41    ......).1.&lt;NO.NA</span><br><span class="line">00000030: 4D 45 20 20 20 20 46 41 54 31 32 20 20 20 0E 1F    ME....FAT12.....</span><br><span class="line">00000040: BE 5B 7C AC 22 C0 74 0B 56 B4 0E BB 07 00 CD 10    &gt;[|,&quot;@t.V4.;..M.</span><br><span class="line">00000050: 5E EB F0 32 E4 CD 16 CD 19 EB FE 54 68 69 73 20    ^kp2dM.M.k~This.</span><br><span class="line">00000060: 69 73 20 6E 6F 74 20 61 20 62 6F 6F 74 61 62 6C    is.not.a.bootabl</span><br><span class="line">00000070: 65 20 64 69 73 6B 2E 20 20 50 6C 65 61 73 65 20    e.disk...Please.</span><br><span class="line">00000080: 69 6E 73 65 72 74 20 61 20 62 6F 6F 74 61 62 6C    insert.a.bootabl</span><br><span class="line">00000090: 65 20 66 6C 6F 70 70 79 20 61 6E 64 0D 0A 70 72    e.floppy.and..pr</span><br><span class="line">000000a0: 65 73 73 20 61 6E 79 20 6B 65 79 20 74 6F 20 74    ess.any.key.to.t</span><br><span class="line">000000b0: 72 79 20 61 67 61 69 6E 20 2E 2E 2E 20 0D 0A 00    ry.again........</span><br><span class="line">000000c0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00    ................</span><br><span class="line">000000d0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00    ................</span><br><span class="line">000000e0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00    ................</span><br><span class="line">000000f0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00    ................</span><br><span class="line">00000100: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00    ................</span><br><span class="line">00000110: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00    ................</span><br><span class="line">00000120: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00    ................</span><br><span class="line">00000130: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00    ................</span><br><span class="line">00000140: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00    ................</span><br><span class="line">00000150: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00    ................</span><br><span class="line">00000160: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00    ................</span><br><span class="line">00000170: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00    ................</span><br><span class="line">00000180: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00    ................</span><br><span class="line">00000190: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00    ................</span><br><span class="line">000001a0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00    ................</span><br><span class="line">000001b0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00    ................</span><br><span class="line">000001c0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00    ................</span><br><span class="line">000001d0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00    ................</span><br><span class="line">000001e0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00    ................</span><br><span class="line">000001f0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 55 AA    ..............U*</span><br><span class="line">00000200: F0 FF FF 00 00 00 00 00 00 00 00 00 00 00 00 00    p...............</span><br></pre></td></tr></table></figure>

<p>要填满在第一个扇区除了引导区之外填满个人信息，只需要在<code>0x500B</code>~<code>0x1f00D</code>间填满个人信息即可。这里直接偷懒用一段C（<code>b.c</code>）解决：</p>
<figure class="highlight c hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="hljs-keyword">char</span> s[] = <span class="hljs-string">"17341163-wu-kan "</span>, b[<span class="hljs-number">1440</span> &lt;&lt; <span class="hljs-number">10</span>];</span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span></span><br><span class="line"><span class="hljs-function"></span>&#123;</span><br><span class="line">	fread(b, <span class="hljs-keyword">sizeof</span>(*b), <span class="hljs-keyword">sizeof</span>(b), fopen(<span class="hljs-string">"a.img"</span>, <span class="hljs-string">"rb+"</span>));</span><br><span class="line">	<span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">91</span>; i &lt; <span class="hljs-number">510</span>; ++i)</span><br><span class="line">		b[i] = s[i % (<span class="hljs-keyword">sizeof</span>(s) - <span class="hljs-number">1</span>)];</span><br><span class="line">	fwrite(b, <span class="hljs-keyword">sizeof</span>(*b), <span class="hljs-keyword">sizeof</span>(b), fopen(<span class="hljs-string">"b.img"</span>, <span class="hljs-string">"wb"</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>运行得到的<code>b.img</code>，其十六进制有着如下的结构（前三十四行），可以发现已经填充成功。</p>
<figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">  Offset: 00 01 02 03 04 05 06 07 08 09 0A 0B 0C 0D 0E 0F</span><br><span class="line">00000000: EB 3C 90 6D 6B 66 73 2E 66 61 74 00 02 01 01 00    k&lt;.mkfs.fat.....</span><br><span class="line">00000010: 02 E0 00 40 0B F0 09 00 12 00 02 00 00 00 00 00    .`.@.p..........</span><br><span class="line">00000020: 00 00 00 00 00 00 29 B9 CA 4B BC 4E 4F 20 4E 41    ......)9JK&lt;NO.NA</span><br><span class="line">00000030: 4D 45 20 20 20 20 46 41 54 31 32 20 20 20 0E 1F    ME....FAT12.....</span><br><span class="line">00000040: BE 5B 7C AC 22 C0 74 0B 56 B4 0E BB 07 00 CD 10    &gt;[|,&quot;@t.V4.;..M.</span><br><span class="line">00000050: 5E EB F0 32 E4 CD 16 CD 19 EB FE 2D 6B 61 6E 20    ^kp2dM.M.k~-kan.</span><br><span class="line">00000060: 31 37 33 34 31 31 36 33 2D 77 75 2D 6B 61 6E 20    17341163-wu-kan.</span><br><span class="line">00000070: 31 37 33 34 31 31 36 33 2D 77 75 2D 6B 61 6E 20    17341163-wu-kan.</span><br><span class="line">00000080: 31 37 33 34 31 31 36 33 2D 77 75 2D 6B 61 6E 20    17341163-wu-kan.</span><br><span class="line">00000090: 31 37 33 34 31 31 36 33 2D 77 75 2D 6B 61 6E 20    17341163-wu-kan.</span><br><span class="line">000000a0: 31 37 33 34 31 31 36 33 2D 77 75 2D 6B 61 6E 20    17341163-wu-kan.</span><br><span class="line">000000b0: 31 37 33 34 31 31 36 33 2D 77 75 2D 6B 61 6E 20    17341163-wu-kan.</span><br><span class="line">000000c0: 31 37 33 34 31 31 36 33 2D 77 75 2D 6B 61 6E 20    17341163-wu-kan.</span><br><span class="line">000000d0: 31 37 33 34 31 31 36 33 2D 77 75 2D 6B 61 6E 20    17341163-wu-kan.</span><br><span class="line">000000e0: 31 37 33 34 31 31 36 33 2D 77 75 2D 6B 61 6E 20    17341163-wu-kan.</span><br><span class="line">000000f0: 31 37 33 34 31 31 36 33 2D 77 75 2D 6B 61 6E 20    17341163-wu-kan.</span><br><span class="line">00000100: 31 37 33 34 31 31 36 33 2D 77 75 2D 6B 61 6E 20    17341163-wu-kan.</span><br><span class="line">00000110: 31 37 33 34 31 31 36 33 2D 77 75 2D 6B 61 6E 20    17341163-wu-kan.</span><br><span class="line">00000120: 31 37 33 34 31 31 36 33 2D 77 75 2D 6B 61 6E 20    17341163-wu-kan.</span><br><span class="line">00000130: 31 37 33 34 31 31 36 33 2D 77 75 2D 6B 61 6E 20    17341163-wu-kan.</span><br><span class="line">00000140: 31 37 33 34 31 31 36 33 2D 77 75 2D 6B 61 6E 20    17341163-wu-kan.</span><br><span class="line">00000150: 31 37 33 34 31 31 36 33 2D 77 75 2D 6B 61 6E 20    17341163-wu-kan.</span><br><span class="line">00000160: 31 37 33 34 31 31 36 33 2D 77 75 2D 6B 61 6E 20    17341163-wu-kan.</span><br><span class="line">00000170: 31 37 33 34 31 31 36 33 2D 77 75 2D 6B 61 6E 20    17341163-wu-kan.</span><br><span class="line">00000180: 31 37 33 34 31 31 36 33 2D 77 75 2D 6B 61 6E 20    17341163-wu-kan.</span><br><span class="line">00000190: 31 37 33 34 31 31 36 33 2D 77 75 2D 6B 61 6E 20    17341163-wu-kan.</span><br><span class="line">000001a0: 31 37 33 34 31 31 36 33 2D 77 75 2D 6B 61 6E 20    17341163-wu-kan.</span><br><span class="line">000001b0: 31 37 33 34 31 31 36 33 2D 77 75 2D 6B 61 6E 20    17341163-wu-kan.</span><br><span class="line">000001c0: 31 37 33 34 31 31 36 33 2D 77 75 2D 6B 61 6E 20    17341163-wu-kan.</span><br><span class="line">000001d0: 31 37 33 34 31 31 36 33 2D 77 75 2D 6B 61 6E 20    17341163-wu-kan.</span><br><span class="line">000001e0: 31 37 33 34 31 31 36 33 2D 77 75 2D 6B 61 6E 20    17341163-wu-kan.</span><br><span class="line">000001f0: 31 37 33 34 31 31 36 33 2D 77 75 2D 6B 61 55 AA    17341163-wu-kaU*</span><br><span class="line">00000200: F0 FF FF 00 00 00 00 00 00 00 00 00 00 00 00 00    p...............</span><br></pre></td></tr></table></figure>

<p>用虚拟机加载b.img，如下：</p>
<p><img src="/2019/04/11/2019-03-13-裸机控制权与引导程序/image/2019-03-13-2.png" alt></p>
<h2 id="接管裸机的控制权-1"><a href="#接管裸机的控制权-1" class="headerlink" title="接管裸机的控制权"></a>接管裸机的控制权</h2><p>老师给的代码（<code>stone.asm</code>）如下：</p>
<figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br></pre></td><td class="code"><pre><span class="line">; 程序源代码（stone.asm）</span><br><span class="line">; 本程序在文本方式显示器上从左边射出一个*号,以45度向右下运动，撞到边框后反射,如此类推.</span><br><span class="line">;  凌应标 2014/3</span><br><span class="line">;   MASM汇编格式</span><br><span class="line">     Dn_Rt equ 1                  ;D-Down,U-Up,R-right,L-Left</span><br><span class="line">     Up_Rt equ 2                  ;</span><br><span class="line">     Up_Lt equ 3                  ;</span><br><span class="line">     Dn_Lt equ 4                  ;</span><br><span class="line">     delay equ 50000					; 计时器延迟计数,用于控制画框的速度</span><br><span class="line">     ddelay equ 580					; 计时器延迟计数,用于控制画框的速度</span><br><span class="line">     .386</span><br><span class="line">     org 100h					; 程序加载到100h，可用于生成COM</span><br><span class="line">     ASSUME cs:code,ds:code</span><br><span class="line">code SEGMENT</span><br><span class="line">start:</span><br><span class="line">	;xor ax,ax					; AX = 0   程序加载到0000：100h才能正确执行</span><br><span class="line">      mov ax,cs</span><br><span class="line">	mov es,ax					; ES = 0</span><br><span class="line">	mov ds,ax					; DS = CS</span><br><span class="line">	mov es,ax					; ES = CS</span><br><span class="line">	mov ax,0B800h				; 文本窗口显存起始地址</span><br><span class="line">	mov gs,ax					; GS = B800h</span><br><span class="line">      mov byte[char],&apos;A&apos;</span><br><span class="line">loop1:</span><br><span class="line">	dec word[count]				; 递减计数变量</span><br><span class="line">	jnz loop1					; &gt;0：跳转;</span><br><span class="line">	mov word[count],delay</span><br><span class="line">	dec word[dcount]				; 递减计数变量</span><br><span class="line">      jnz loop1</span><br><span class="line">	mov word[count],delay</span><br><span class="line">	mov word[dcount],ddelay</span><br><span class="line"></span><br><span class="line">      mov al,1</span><br><span class="line">      cmp al,byte[rdul]</span><br><span class="line">	jz  DnRt</span><br><span class="line">      mov al,2</span><br><span class="line">      cmp al,byte[rdul]</span><br><span class="line">	jz  UpRt</span><br><span class="line">      mov al,3</span><br><span class="line">      cmp al,byte[rdul]</span><br><span class="line">	jz  UpLt</span><br><span class="line">      mov al,4</span><br><span class="line">      cmp al,byte[rdul]</span><br><span class="line">	jz  DnLt</span><br><span class="line">      jmp $</span><br><span class="line"></span><br><span class="line">DnRt:</span><br><span class="line">	inc word[x]</span><br><span class="line">	inc word[y]</span><br><span class="line">	mov bx,word[x]</span><br><span class="line">	mov ax,25</span><br><span class="line">	sub ax,bx</span><br><span class="line">      jz  dr2ur</span><br><span class="line">	mov bx,word[y]</span><br><span class="line">	mov ax,80</span><br><span class="line">	sub ax,bx</span><br><span class="line">      jz  dr2dl</span><br><span class="line">	jmp show</span><br><span class="line">dr2ur:</span><br><span class="line">      mov word[x],23</span><br><span class="line">      mov byte[rdul],Up_Rt</span><br><span class="line">      jmp show</span><br><span class="line">dr2dl:</span><br><span class="line">      mov word[y],78</span><br><span class="line">      mov byte[rdul],Dn_Lt</span><br><span class="line">      jmp show</span><br><span class="line"></span><br><span class="line">UpRt:</span><br><span class="line">	dec word[x]</span><br><span class="line">	inc word[y]</span><br><span class="line">	mov bx,word[y]</span><br><span class="line">	mov ax,80</span><br><span class="line">	sub ax,bx</span><br><span class="line">      jz  ur2ul</span><br><span class="line">	mov bx,word[x]</span><br><span class="line">	mov ax,-1</span><br><span class="line">	sub ax,bx</span><br><span class="line">      jz  ur2dr</span><br><span class="line">	jmp show</span><br><span class="line">ur2ul:</span><br><span class="line">      mov word[y],78</span><br><span class="line">      mov byte[rdul],Up_Lt</span><br><span class="line">      jmp show</span><br><span class="line">ur2dr:</span><br><span class="line">      mov word[x],1</span><br><span class="line">      mov byte[rdul],Dn_Rt</span><br><span class="line">      jmp show</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">UpLt:</span><br><span class="line">	dec word[x]</span><br><span class="line">	dec word[y]</span><br><span class="line">	mov bx,word[x]</span><br><span class="line">	mov ax,-1</span><br><span class="line">	sub ax,bx</span><br><span class="line">      jz  ul2dl</span><br><span class="line">	mov bx,word[y]</span><br><span class="line">	mov ax,-1</span><br><span class="line">	sub ax,bx</span><br><span class="line">      jz  ul2ur</span><br><span class="line">	jmp show</span><br><span class="line"></span><br><span class="line">ul2dl:</span><br><span class="line">      mov word[x],1</span><br><span class="line">      mov byte[rdul],Dn_Lt</span><br><span class="line">      jmp show</span><br><span class="line">ul2ur:</span><br><span class="line">      mov word[y],1</span><br><span class="line">      mov byte[rdul],Up_Rt</span><br><span class="line">      jmp show</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">DnLt:</span><br><span class="line">	inc word[x]</span><br><span class="line">	dec word[y]</span><br><span class="line">	mov bx,word[y]</span><br><span class="line">	mov ax,-1</span><br><span class="line">	sub ax,bx</span><br><span class="line">      jz  dl2dr</span><br><span class="line">	mov bx,word[x]</span><br><span class="line">	mov ax,25</span><br><span class="line">	sub ax,bx</span><br><span class="line">      jz  dl2ul</span><br><span class="line">	jmp show</span><br><span class="line"></span><br><span class="line">dl2dr:</span><br><span class="line">      mov word[y],1</span><br><span class="line">      mov byte[rdul],Dn_Rt</span><br><span class="line">      jmp show</span><br><span class="line"></span><br><span class="line">dl2ul:</span><br><span class="line">      mov word[x],23</span><br><span class="line">      mov byte[rdul],Up_Lt</span><br><span class="line">      jmp show</span><br><span class="line"></span><br><span class="line">show:</span><br><span class="line">      xor ax,ax                 ; 计算显存地址</span><br><span class="line">      mov ax,word[x]</span><br><span class="line">	mov bx,80</span><br><span class="line">	mul bx</span><br><span class="line">	add ax,word[y]</span><br><span class="line">	mov bx,2</span><br><span class="line">	mul bx</span><br><span class="line">	mov bx,ax</span><br><span class="line">	mov ah,0Fh				;  0000：黑底、1111：亮白字（默认值为07h）</span><br><span class="line">	mov al,byte[char]			;  AL = 显示字符值（默认值为20h=空格符）</span><br><span class="line">	mov es:[bx],ax  		;  显示字符的ASCII码值</span><br><span class="line">	jmp loop1</span><br><span class="line"></span><br><span class="line">end:</span><br><span class="line">    jmp $                   ; 停止画框，无限循环</span><br><span class="line"></span><br><span class="line">datadef:</span><br><span class="line">    count dw delay</span><br><span class="line">    dcount dw ddelay</span><br><span class="line">    rdul db Dn_Rt         ; 向右下运动</span><br><span class="line">    x    dw 7</span><br><span class="line">    y    dw 0</span><br><span class="line">    char db &apos;A&apos;</span><br><span class="line">code ENDS</span><br><span class="line">     END start</span><br></pre></td></tr></table></figure>

<p>在终端里敲下面的指令编译一下看看：</p>
<figure class="highlight bash hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nasm stone.asm -o stone.bin</span><br></pre></td></tr></table></figure>

<p>报错了，一脸懵逼…</p>
<figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">stone.asm:11: warning: label alone on a line without a colon might be in error [-w+orphan-labels]</span><br><span class="line">stone.asm:11: error: attempt to define a</span><br><span class="line">local label before any non-local labels</span><br><span class="line">stone.asm:13: error: parser: instruction</span><br><span class="line">expected</span><br><span class="line">stone.asm:14: warning: macro `SEGMENT&apos; exists, but not taking 0 parameters [-w+macro-params]</span><br><span class="line">stone.asm:14: error: parser: instruction</span><br><span class="line">expected</span><br><span class="line">stone.asm:162: error: symbol `code&apos; redefined</span><br><span class="line">stone.asm:162: error: parser: instruction expected</span><br><span class="line">stone.asm:163: error: parser: instruction expected</span><br></pre></td></tr></table></figure>

<p>把上面这段东西放在Stack Overflow上搜一下看看，找到一个差不多的问题（见参考文献），仅有一个的回答是这样的；</p>
<blockquote>
<p>That assembly language is MASM, not NASM.</p>
<p>For starters, NASM segments are defined differently.<br>Instead of</p>
<blockquote>
<p>Code    segment word public ‘CODE’</p>
</blockquote>
<p>we write</p>
<blockquote>
<p>.section text</p>
</blockquote>
<p>And that “ASSUME” declaration… You must have an ancient book. That is old, old MASM code. Brings back memories from the early 1980s for me!</p>
<p>There are many differences between NASM and MASM, and your code needs quite a bit of work to port. If you want to port that MASM code to NASM, see MASM/NASM Differences or the NASM documentation or google “NASM vs MASM”</p>
<p>TL;DR: you are writing MASM code, not NASM.</p>
</blockquote>
<p>就是说，老师给我们的是“from the early 1980s”的“MASM”代码而不是“NASM”。<br>干脆重构了老师的代码：</p>
<ul>
<li>又要显示学号，又要有弹跳的<code>a</code>，不如让学号跟着一起弹跳（<code>a</code>在我的姓名里有）。于是每次打印整个字符串，并设置弹跳的右边界为<code>WIDTH-LENGTH</code>。</li>
<li>打印前有一句<code>mov ah,0Fh</code>，是用来设置输出字符串的颜色的（黑底白字），这里去掉它，这时输出字符的颜色就会随行号（<code>ah</code>中原来的值）来变化。</li>
<li>原先老师用来实现延迟是使用了两层循环+两个<code>dw</code>变量，感觉没有必要，因此修改成单层循环+一个<code>dd</code>变量。</li>
<li>几处“撞墙”检测的逻辑修改。原先的逻辑是<strong>假如当前下标出界，修改方向，并把下标调整到正常的位置</strong>。修改之后的逻辑是<strong>假如当前下标在边界上，改变方向</strong>。修改后的逻辑更加简洁有效。</li>
<li>某些代码逻辑的优化，例如在进行运算时减少中间变量的过渡。这样可以减小生成代码的体积。</li>
</ul>
<p>重构的代码（<code>c.asm</code>）如下，编译生成的代码只有290bytes，可见这个重构还是很有效的。</p>
<blockquote>
<p>2019-03-19 update：这是直接从老师的代码中改来的代码，有一个BUG，就是字符运行到四个顶点的时候会从角上飞出，导致显示内容错乱；原因是老师只考虑了边反射没有考虑角反射。在<a href="https://wu-kan.github.io/操作系统/加载用户程序的监控程序" target="_blank" rel="noopener">下一个实验</a>里，我再次重构了这段代码，修复了这个BUG，并且大大减小了编译后的大小（137bytes）。</p>
</blockquote>
<figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br></pre></td><td class="code"><pre><span class="line">DNRT equ 1	; D-Down,U-Up,R-right,L-Left</span><br><span class="line">UPRT equ 2</span><br><span class="line">UPLT equ 3</span><br><span class="line">DNLT equ 4</span><br><span class="line">WIDTH equ 80</span><br><span class="line">HEIGHT equ 25</span><br><span class="line">LENGTH equ 17	; 字符串的长度</span><br><span class="line">org 7c00h</span><br><span class="line">section .data</span><br><span class="line">	count dd 1</span><br><span class="line">	x dw 0</span><br><span class="line">	y dw 0</span><br><span class="line">	rdul db DNRT	; 向右下运动</span><br><span class="line">	message db &apos; 17341163 wu-kan &apos;</span><br><span class="line">section .text</span><br><span class="line">	mov ax,0B800h</span><br><span class="line">	mov gs,ax	; GS = 0xB800h，文本窗口显存起始地址</span><br><span class="line">myLoop:</span><br><span class="line">	dec dword[count]	; 递减计数变量</span><br><span class="line">	jnz myLoop	; &gt;0：跳转;</span><br><span class="line">	mov dword[count],99999999</span><br><span class="line">	cmp byte[rdul],DNRT</span><br><span class="line">	jz  dnrt</span><br><span class="line">	cmp byte[rdul],UPRT</span><br><span class="line">	jz  uprt</span><br><span class="line">	cmp byte[rdul],UPLT</span><br><span class="line">	jz  uplt</span><br><span class="line">	cmp byte[rdul],DNLT</span><br><span class="line">	jz  dnlt</span><br><span class="line">dnrt:</span><br><span class="line">	inc word[x]</span><br><span class="line">	inc word[y]</span><br><span class="line">	mov ax,HEIGHT-1</span><br><span class="line">	sub ax,word[x]</span><br><span class="line">	jz  dr2ur</span><br><span class="line">	mov ax,WIDTH-LENGTH</span><br><span class="line">	sub ax,word[y]</span><br><span class="line">	jz  dr2dl</span><br><span class="line">	jmp show</span><br><span class="line">dr2ur:</span><br><span class="line">	mov byte[rdul],UPRT</span><br><span class="line">	jmp show</span><br><span class="line">dr2dl:</span><br><span class="line">	mov byte[rdul],DNLT</span><br><span class="line">	jmp show</span><br><span class="line">uprt:</span><br><span class="line">	dec word[x]</span><br><span class="line">	inc word[y]</span><br><span class="line">	mov ax,2</span><br><span class="line">	sub ax,word[x]</span><br><span class="line">	jz  ur2dr</span><br><span class="line">	mov ax,WIDTH-LENGTH</span><br><span class="line">	sub ax,word[y]</span><br><span class="line">	jz  ur2ul</span><br><span class="line">	jmp show</span><br><span class="line">ur2dr:</span><br><span class="line">	mov byte[rdul],DNRT</span><br><span class="line">	jmp show</span><br><span class="line">ur2ul:</span><br><span class="line">	mov byte[rdul],UPLT</span><br><span class="line">	jmp show</span><br><span class="line">uplt:</span><br><span class="line">	dec word[x]</span><br><span class="line">	dec word[y]</span><br><span class="line">	mov ax,2</span><br><span class="line">	sub ax,word[x]</span><br><span class="line">	jz  ul2dl</span><br><span class="line">	mov ax,1</span><br><span class="line">	sub ax,word[y]</span><br><span class="line">	jz  ul2ur</span><br><span class="line">	jmp show</span><br><span class="line">ul2dl:</span><br><span class="line">	mov byte[rdul],DNLT</span><br><span class="line">	jmp show</span><br><span class="line">ul2ur:</span><br><span class="line">	mov byte[rdul],UPRT</span><br><span class="line">	jmp show</span><br><span class="line">dnlt:</span><br><span class="line">	inc word[x]</span><br><span class="line">	dec word[y]</span><br><span class="line">	mov ax,HEIGHT-1</span><br><span class="line">	sub ax,word[x]</span><br><span class="line">	jz  dl2ul</span><br><span class="line">	mov ax,1</span><br><span class="line">	sub ax,word[y]</span><br><span class="line">	jz  dl2dr</span><br><span class="line">	jmp show</span><br><span class="line">dl2ul:</span><br><span class="line">	mov byte[rdul],UPLT</span><br><span class="line">	jmp show</span><br><span class="line">dl2dr:</span><br><span class="line">	mov byte[rdul],DNRT</span><br><span class="line">	jmp show</span><br><span class="line">show:</span><br><span class="line">	xor ax,ax</span><br><span class="line">	mov word ax,[x]</span><br><span class="line">	mov bx,WIDTH</span><br><span class="line">	mul bx</span><br><span class="line">	add word ax,[y]</span><br><span class="line">	mov bx,2</span><br><span class="line">	mul bx</span><br><span class="line">	mov bx,ax</span><br><span class="line">	mov si, message</span><br><span class="line">	mov cx, LENGTH</span><br><span class="line">	printStr:</span><br><span class="line">		mov byte al,[si]</span><br><span class="line">		mov [gs:bx],ax</span><br><span class="line">		inc si</span><br><span class="line">		inc bx</span><br><span class="line">		inc bx</span><br><span class="line">	loop printStr</span><br><span class="line">	jmp myLoop</span><br></pre></td></tr></table></figure>

<p>在终端中依次执行下列指令，将上述汇编代码编译并写进新的软驱<code>c.img</code>。</p>
<figure class="highlight bash hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">nasm c.asm -o c.com</span><br><span class="line">/sbin/mkfs.msdos -C c.img 1440</span><br><span class="line">dd <span class="hljs-keyword">if</span>=c.com of=c.img bs=1440k conv=notrunc</span><br></pre></td></tr></table></figure>

<p>用虚拟机打开<code>c.img</code>，运行结果如下：</p>
<p><img src="/2019/04/11/2019-03-13-裸机控制权与引导程序/image/2019-03-13-3.png" alt></p>
<h1 id="实验总结"><a href="#实验总结" class="headerlink" title="实验总结"></a>实验总结</h1><p>终于有空静下心来做操作系统实验。在第一次的实验过程中，我遇到了很多的问题，包括编译失败、在虚拟机上运行没有正确输出等。通过查找资料、自己动手尝试，检查究竟是哪里出问题，找到问题的根源。</p>
<p>同时，也对老师提供的实验思路展开了一些自己的思考。例如：</p>
<ol>
<li>向软盘的第一个扇区内填充自己的个人信息，这里我直接使用一段C语言，用二进制打开生成的软盘文件进行操作，方便快捷。</li>
<li>向软盘内写入自己的引导扇区程序，老师课上演示的方案是使用WinHex打开之后手动拷贝，并修改扇区尾部。但是，Linux下其实是有着自己的软盘拷贝指令的（见参考资料），使用这个指令简化了很多操作。</li>
</ol>
<h1 id="参考文献"><a href="#参考文献" class="headerlink" title="参考文献"></a>参考文献</h1><ul>
<li>于渊 著. 《Orange‘s：一个操作系统的实现》.  电子工业出版社，2009年6月</li>
<li>陈渝、向勇编著. 《操作系统实验指导》.  清华大学出版社，2013年7月</li>
<li>李忠著. 《 x86汇编语言-从实模式到保护模式》.电子工业出版社，2013年1月</li>
<li><a href="https://stackoverflow.com/questions/11572307/nasm-error-parsing-instruction-expected" target="_blank" rel="noopener">assembly - NASM Error Parsing, Instruction Expected - Stack Overflow</a></li>
<li><a href="http://www.runoob.com/linux/linux-comm-dd.html" target="_blank" rel="noopener">Linux dd命令 - 菜鸟教程</a></li>
</ul>

        </div>
        
        
        
    </div>
</div>








    <div class="card">
    
    <div class="card-content article ">
        
        <div class="level article-meta is-size-7 is-uppercase is-mobile is-overflow-x-auto">
            <div class="level-left">
                <time class="level-item has-text-grey" datetime="2019-04-10T16:08:06.397Z">2019-04-11</time>
                
                <div class="level-item">
                <a class="has-link-grey -link" href="/categories/计算机网络/">计算机网络</a>
                </div>
                
                
                <span class="level-item has-text-grey">
                    
                    
                    19 分钟 读完 (大约 2780 个字)
                </span>
                
                
            </div>
        </div>
        
        <h1 class="title is-size-3 is-size-4-mobile has-text-weight-normal">
            
                <a class="has-link-black-ter" href="/2019/04/11/2019-03-11-Echo实验/"></a>
            
        </h1>
        <div class="content">
            <h1 id="实验题目"><a href="#实验题目" class="headerlink" title="实验题目"></a>实验题目</h1><p>Echo实验</p>
<h1 id="实验目的"><a href="#实验目的" class="headerlink" title="实验目的"></a>实验目的</h1><p>掌握套节字的基本使用方法</p>
<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><ul>
<li><a href="https://www.cnblogs.com/hgwang/p/6074038.html" target="_blank" rel="noopener">https://www.cnblogs.com/hgwang/p/6074038.html</a>  （套接字）</li>
<li><a href="https://www.jb51.net/article/37410.htm" target="_blank" rel="noopener">https://www.jb51.net/article/37410.htm</a>  （字符串）</li>
<li><a href="https://docs.microsoft.com/en-us/c/c-runtime-library/stream-i-o?view=vs-2017" target="_blank" rel="noopener">https://docs.microsoft.com/en-us/c/c-runtime-library/stream-i-o?view=vs-2017</a>  （字符串）</li>
<li><a href="https://docs.microsoft.com/en-us/c/c-runtime-library/reference/crt-alphabetical-function-reference?view=vs-2017#s" target="_blank" rel="noopener">https://docs.microsoft.com/en-us/c/c-runtime-library/reference/crt-alphabetical-function-reference?view=vs-2017#s</a>   （字符串）</li>
<li><a href="http://www.runoob.com/cprogramming/" target="_blank" rel="noopener">http://www.runoob.com/cprogramming/</a>  （字符串）</li>
</ul>
<h1 id="实验环境"><a href="#实验环境" class="headerlink" title="实验环境"></a>实验环境</h1><ul>
<li>Windows + VS 2012  <a href="http://172.18.187.9/netdisk/default.aspx?vm=17net" target="_blank" rel="noopener">http://172.18.187.9/netdisk/default.aspx?vm=17net</a></li>
<li>对于VS2015和VS2017默认使用安全周期检查，如果不关闭VS的安全周期检查，很多字符串函数都不能用。</li>
<li>Linux + gcc</li>
</ul>
<p>这里我使用的环境是Windows 10 + VSCode + gcc version 8.1.0 (x86_64-posix-sjlj-rev0, Built by MinGW-W64 project)</p>
<h1 id="实验内容"><a href="#实验内容" class="headerlink" title="实验内容"></a>实验内容</h1><h2 id="编写TCP-Echo增强程序"><a href="#编写TCP-Echo增强程序" class="headerlink" title="编写TCP Echo增强程序"></a>编写TCP Echo增强程序</h2><h3 id="实验要求："><a href="#实验要求：" class="headerlink" title="实验要求："></a>实验要求：</h3><p>服务器把客户端发送来的任何消息都返回给客户端，返回的消息前面要加上服务器的当前时间。客户端把返回的消息显示出来。客户端每输入一条消息就建立TCP连接，并把消息发送给服务器，在收到服务器回应后关闭连接。在这一基础上，服务器在收到客户端的消息时显示服务器的当前时间、客户端的IP地址、客户端的端口号和客户端发来的信息，并把它们一并返回给客户端。客户端在发送消息后把服务器发回给它的消息显示出来。要求服务器直接从accept()的参数fsin中得到客户端的IP地址和端口号。服务器获取IP地址后要求直接使用s_un_b的四个分量得到IP地址，不能使用函数inet_ntoa()转换IP地址。</p>
<h3 id="只运行客户端程序而不运行服务器程序会出现什么错误，截屏并说明原因。"><a href="#只运行客户端程序而不运行服务器程序会出现什么错误，截屏并说明原因。" class="headerlink" title="只运行客户端程序而不运行服务器程序会出现什么错误，截屏并说明原因。"></a>只运行客户端程序而不运行服务器程序会出现什么错误，截屏并说明原因。</h3><p><img src="/2019/04/11/2019-03-11-Echo实验/image/2019-03-11-1.png" alt><br>如图，退出了服务器程序后再运行客户端程序，得到了10057的报错。</p>
<h3 id="服务器如何可以退出循环？"><a href="#服务器如何可以退出循环？" class="headerlink" title="服务器如何可以退出循环？"></a>服务器如何可以退出循环？</h3><p>kbhit()在执行时,检测是否有按键按下,有按下返回非0值，没有按下则返回0，是非阻塞函数；因此，预期在监听的过程中将服务器程序从后台激活并按下键盘按键即可退出循环。</p>
<p>然而，在实际运行中这样是失效的，正是因为他是非阻塞函数，而下面收发信息却是阻塞的。因此退出循环只有我们在命令行中手动按Ctrl+C了。</p>
<h3 id="截屏（ctrl-alt-PrintScreen）服务器和客户端的运行结果（注明客户端和服务器）"><a href="#截屏（ctrl-alt-PrintScreen）服务器和客户端的运行结果（注明客户端和服务器）" class="headerlink" title="截屏（ctrl+alt+PrintScreen）服务器和客户端的运行结果（注明客户端和服务器）"></a>截屏（ctrl+alt+PrintScreen）服务器和客户端的运行结果（注明客户端和服务器）</h3><p>客户端：<br><img src="/2019/04/11/2019-03-11-Echo实验/image/2019-03-11-2.png" alt><br>服务器：<br><img src="/2019/04/11/2019-03-11-Echo实验/image/2019-03-11-3.png" alt></p>
<h3 id="服务器的全部源代码（或自选主要代码）"><a href="#服务器的全部源代码（或自选主要代码）" class="headerlink" title="服务器的全部源代码（或自选主要代码）"></a>服务器的全部源代码（或自选主要代码）</h3><figure class="highlight c hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;time.h&gt;</span></span></span><br><span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;winsock2.h&gt;</span></span></span><br><span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;conio.h&gt;</span></span></span><br><span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> BUFLEN 2000</span></span><br><span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> WSVERS MAKEWORD(2, 0)</span></span><br><span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">pragma</span> comment(lib, <span class="hljs-meta-string">"ws2_32.lib"</span>) <span class="hljs-comment">//使用winsock 2.2 library</span></span></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-keyword">int</span> argc, <span class="hljs-keyword">char</span> *argv[])</span>   <span class="hljs-comment">// argc: 命令行参数个数，例如：C:\&gt; TCPServer 8080 argc=2 argv[0]=“TCPServer", argv[1]="8080"</span></span></span><br><span class="line"><span class="hljs-function"></span>&#123;</span><br><span class="line">	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sockaddr_in</span> <span class="hljs-title">fsin</span>;</span> <span class="hljs-comment">// the from address of a client</span></span><br><span class="line">	SOCKET msock, ssock;	 <span class="hljs-comment">// master &amp; slave sockets</span></span><br><span class="line">	WSADATA wsadata;</span><br><span class="line">	<span class="hljs-keyword">char</span> service[] = <span class="hljs-string">"50500"</span>;</span><br><span class="line">	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sockaddr_in</span> <span class="hljs-title">sin</span>;</span>							   <span class="hljs-comment">// an Internet endpoint address</span></span><br><span class="line">	<span class="hljs-keyword">int</span> alen;										   <span class="hljs-comment">// from-address length</span></span><br><span class="line">	<span class="hljs-keyword">char</span> pts[BUFLEN + <span class="hljs-number">1</span>];							   <span class="hljs-comment">// pointer to time string</span></span><br><span class="line">	<span class="hljs-keyword">time_t</span> now;										   <span class="hljs-comment">// current time</span></span><br><span class="line">	WSAStartup(WSVERS, &amp;wsadata);					   <span class="hljs-comment">// 加载winsock library，WSVERS为请求版本，wsadata返回系统实际支持的最高版本</span></span><br><span class="line">	msock = socket(PF_INET, SOCK_STREAM, IPPROTO_TCP); <span class="hljs-comment">// 创建套接字。 参数：因特网协议簇(family)，字节流，TCP协议号。 返回：要监听套接字的描述符或INVALID_SOCKET</span></span><br><span class="line">	<span class="hljs-built_in">memset</span>(&amp;<span class="hljs-built_in">sin</span>, <span class="hljs-number">0</span>, <span class="hljs-keyword">sizeof</span>(<span class="hljs-built_in">sin</span>));					   <span class="hljs-comment">//从&amp;sin开始的长度为sizeof(sin)的内存清0 , sin为一个地址结构</span></span><br><span class="line">	<span class="hljs-built_in">sin</span>.sin_family = AF_INET;						   <span class="hljs-comment">//因特网地址簇(INET-Internet)</span></span><br><span class="line">	<span class="hljs-built_in">sin</span>.sin_addr.s_addr = INADDR_ANY;				   <span class="hljs-comment">//监听所有(接口的)IP地址(32位)，// 0.0.0.0</span></span><br><span class="line">	<span class="hljs-built_in">sin</span>.sin_port = htons((u_short)atoi(service));	  <span class="hljs-comment">//监听的端口号(16位) 。atoi--把ascii转化为int，htons—主机序到网络序</span></span><br><span class="line">	bind(msock, (struct sockaddr *)&amp;<span class="hljs-built_in">sin</span>, <span class="hljs-keyword">sizeof</span>(<span class="hljs-built_in">sin</span>)); <span class="hljs-comment">// 通过sin把要监听的IP地址和端口号绑定到套接字上</span></span><br><span class="line">	listen(msock, <span class="hljs-number">5</span>);								   <span class="hljs-comment">// 建立长度为5的连接请求队列，并开始监听是否有连接请求到来，来了则放入队列</span></span><br><span class="line">	<span class="hljs-built_in">printf</span>(<span class="hljs-string">"Server Start to listen.\n"</span>);</span><br><span class="line">	<span class="hljs-keyword">while</span> (!_kbhit()) <span class="hljs-comment">// 检测是否有按键 (什么时候执行？)</span></span><br><span class="line">	&#123;</span><br><span class="line">		alen = <span class="hljs-keyword">sizeof</span>(struct sockaddr);</span><br><span class="line">		ssock = accept(msock, (struct sockaddr *)&amp;fsin, &amp;alen); <span class="hljs-comment">// accept：如果有新的连接请求，返回连接套接字，否则，被阻塞，fsin包含客户端IP地址和端口号</span></span><br><span class="line">		time(&amp;now);												<span class="hljs-comment">// 取得系统时间</span></span><br><span class="line">		<span class="hljs-keyword">int</span> cnt = <span class="hljs-built_in">sprintf</span>(pts, <span class="hljs-string">"Accept Time:\n"</span></span><br><span class="line">							   <span class="hljs-string">"%s"</span></span><br><span class="line">							   <span class="hljs-string">"sin_port:\n"</span></span><br><span class="line">							   <span class="hljs-string">"%u\n"</span></span><br><span class="line">							   <span class="hljs-string">"sin_addr:\n"</span></span><br><span class="line">							   <span class="hljs-string">"%d.%d.%d.%d\n"</span></span><br><span class="line">							   <span class="hljs-string">"Receive Message:\n"</span>,</span><br><span class="line">						  ctime(&amp;now),</span><br><span class="line">						  fsin.sin_port,</span><br><span class="line">						  fsin.sin_addr.S_un.S_un_b.s_b1,</span><br><span class="line">						  fsin.sin_addr.S_un.S_un_b.s_b2,</span><br><span class="line">						  fsin.sin_addr.S_un.S_un_b.s_b3,</span><br><span class="line">						  fsin.sin_addr.S_un.S_un_b.s_b4); <span class="hljs-comment">// 把时间转换为字符串</span></span><br><span class="line">		<span class="hljs-keyword">int</span> cc = recv(ssock, pts + cnt, BUFLEN - cnt, <span class="hljs-number">0</span>);</span><br><span class="line">		pts[cnt + cc] = <span class="hljs-number">0</span>;</span><br><span class="line">		<span class="hljs-built_in">printf</span>(<span class="hljs-string">"\n%s\n"</span>, pts);</span><br><span class="line">		send(ssock, pts, cnt + cc, <span class="hljs-number">0</span>);</span><br><span class="line">		closesocket(ssock); <span class="hljs-comment">//  关闭连接套接字</span></span><br><span class="line">	&#125;</span><br><span class="line">	closesocket(msock);</span><br><span class="line">	WSACleanup();</span><br><span class="line">	system(<span class="hljs-string">"pause"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="客户端的全部源代码（或自选主要代码）"><a href="#客户端的全部源代码（或自选主要代码）" class="headerlink" title="客户端的全部源代码（或自选主要代码）"></a>客户端的全部源代码（或自选主要代码）</h3><figure class="highlight c hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;winsock2.h&gt;</span></span></span><br><span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> BUFLEN 2000</span></span><br><span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> WSVERS MAKEWORD(2, 0)</span></span><br><span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">pragma</span> comment(lib, <span class="hljs-meta-string">"ws2_32.lib"</span>)</span></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-keyword">int</span> argc, <span class="hljs-keyword">char</span> *argv[])</span></span></span><br><span class="line"><span class="hljs-function"></span>&#123;</span><br><span class="line">	<span class="hljs-keyword">char</span> host[] = <span class="hljs-string">"127.0.0.1"</span>;			   <span class="hljs-comment">// server IP to connect，127.0.0.1指本机</span></span><br><span class="line">	<span class="hljs-keyword">char</span> service[] = <span class="hljs-string">"50500"</span>;			   <span class="hljs-comment">// server port to connect</span></span><br><span class="line">	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sockaddr_in</span> <span class="hljs-title">sin</span>;</span>				   <span class="hljs-comment">// an Internet endpoint address</span></span><br><span class="line">	<span class="hljs-keyword">char</span> buf[BUFLEN + <span class="hljs-number">1</span>], msg[BUFLEN + <span class="hljs-number">1</span>]; <span class="hljs-comment">// buffer for one line of text</span></span><br><span class="line">	SOCKET sock;						   <span class="hljs-comment">// socket descriptor</span></span><br><span class="line">	<span class="hljs-keyword">int</span> cc;								   <span class="hljs-comment">// recv character count</span></span><br><span class="line">	WSADATA wsadata;</span><br><span class="line">	WSAStartup(WSVERS, &amp;wsadata);</span><br><span class="line">	sock = socket(PF_INET, SOCK_STREAM, IPPROTO_TCP);</span><br><span class="line">	<span class="hljs-built_in">memset</span>(&amp;<span class="hljs-built_in">sin</span>, <span class="hljs-number">0</span>, <span class="hljs-keyword">sizeof</span>(<span class="hljs-built_in">sin</span>));				  <span class="hljs-comment">// sin的内存清0</span></span><br><span class="line">	<span class="hljs-built_in">sin</span>.sin_family = AF_INET;					  <span class="hljs-comment">// 因特网地址簇</span></span><br><span class="line">	<span class="hljs-built_in">sin</span>.sin_addr.s_addr = inet_addr(host);		  <span class="hljs-comment">// 服务器IP地址(32位)</span></span><br><span class="line">	<span class="hljs-built_in">sin</span>.sin_port = htons((u_short)atoi(service)); <span class="hljs-comment">// 服务器端口号(16位)</span></span><br><span class="line">	<span class="hljs-built_in">printf</span>(<span class="hljs-string">"Send the Message:\n"</span>);</span><br><span class="line">	gets(msg);</span><br><span class="line">	<span class="hljs-keyword">int</span> ret = connect(sock, (struct sockaddr *)&amp;<span class="hljs-built_in">sin</span>, <span class="hljs-keyword">sizeof</span>(<span class="hljs-built_in">sin</span>)); <span class="hljs-comment">// 连接到服务器.无错时，返回0， // 否则，返回SOCKET_ERROR ，可以调用 //    函数WSAGetLastError取得错误代码</span></span><br><span class="line">	cc = send(sock, msg, <span class="hljs-built_in">strlen</span>(msg), <span class="hljs-number">0</span>);						   <span class="hljs-comment">//把缓冲区pts的数据发送出去，len为要发送的字节数， // 返回值：(&gt;0) 实际发送的字节数(≤len), (=0) 对方正常关闭， //    （=SOCKET_ERROR) 出错，用函数WSAGetLastError取错误码。</span></span><br><span class="line">	cc = recv(sock, buf, BUFLEN, <span class="hljs-number">0</span>);							   <span class="hljs-comment">// BUFLEN为缓冲区buf的长度。 // 返回值：接收的字符数(&gt;0)、对方已关闭(=0) 或连接出错(&lt;0)</span></span><br><span class="line">	<span class="hljs-keyword">if</span> (cc == SOCKET_ERROR)</span><br><span class="line">		<span class="hljs-built_in">printf</span>(<span class="hljs-string">"Error:\n%d.\n"</span>, GetLastError());</span><br><span class="line">	<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (cc == <span class="hljs-number">0</span>)</span><br><span class="line">		<span class="hljs-built_in">printf</span>(<span class="hljs-string">"Server closed.\n"</span>);</span><br><span class="line">	<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (cc &gt; <span class="hljs-number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		buf[cc] = <span class="hljs-string">'\0'</span>;		   <span class="hljs-comment">//  ensure null-termination</span></span><br><span class="line">		<span class="hljs-built_in">printf</span>(<span class="hljs-string">"\n%s\n"</span>, buf); <span class="hljs-comment">// 显示所接收的字符串</span></span><br><span class="line">	&#125;</span><br><span class="line">	closesocket(sock); <span class="hljs-comment">// 关闭套接字</span></span><br><span class="line">	WSACleanup();	  <span class="hljs-comment">//  卸载winsock library</span></span><br><span class="line">	system(<span class="hljs-string">"pause"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="编写UDP-Echo增强程序"><a href="#编写UDP-Echo增强程序" class="headerlink" title="编写UDP Echo增强程序"></a>编写UDP Echo增强程序</h2><h3 id="实验要求"><a href="#实验要求" class="headerlink" title="实验要求"></a>实验要求</h3><p>修改UDP例程，完成Echo功能，即当客户端发来消息时，服务器显示出服务器的当前时间、客户端的IP、客户端的端口号和客户发来的信息，并把它们一并发回给客户端，客户端然后把它们显示出来。<br>服务器可以直接从recvfrom()的参数from中得到客户端的IP地址和端口号，并且服务器用sendto()发回给客户端消息时可以直接用该参数from作为参数toAddr。可以使用inet_ntoa()转换客户端IP地址。<br>客户端程序的recvfrom()可以直接使用原来sendto使用的sock。该sock已经绑定了客户端的IP地址和端口号，客户端可以直接用来接收数据。</p>
<h3 id="只运行客户端程序而不运行服务器程序会出现什么错误，截屏并说明原因"><a href="#只运行客户端程序而不运行服务器程序会出现什么错误，截屏并说明原因" class="headerlink" title="只运行客户端程序而不运行服务器程序会出现什么错误，截屏并说明原因"></a>只运行客户端程序而不运行服务器程序会出现什么错误，截屏并说明原因</h3><p><img src="/2019/04/11/2019-03-11-Echo实验/image/2019-03-11-4.png" alt><br>如图，在发送时没有报错，但是试图从服务器获得信息时获得了10054的报错。</p>
<h3 id="截屏服务器和客户端的运行结果（注明客户端和服务器）"><a href="#截屏服务器和客户端的运行结果（注明客户端和服务器）" class="headerlink" title="截屏服务器和客户端的运行结果（注明客户端和服务器）"></a>截屏服务器和客户端的运行结果（注明客户端和服务器）</h3><p><img src="/2019/04/11/2019-03-11-Echo实验/image/2019-03-11-5.png" alt><br>服务器：<br><img src="/2019/04/11/2019-03-11-Echo实验/image/2019-03-11-6.png" alt></p>
<h3 id="服务器的全部源代码（或自选主要代码）-1"><a href="#服务器的全部源代码（或自选主要代码）-1" class="headerlink" title="服务器的全部源代码（或自选主要代码）"></a>服务器的全部源代码（或自选主要代码）</h3><figure class="highlight c hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;time.h&gt;</span></span></span><br><span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;conio.h&gt;</span></span></span><br><span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;winsock2.h&gt;</span></span></span><br><span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> BUFLEN 2000				   <span class="hljs-comment">// 缓冲区大小</span></span></span><br><span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> WSVERS MAKEWORD(2, 2)	  <span class="hljs-comment">// 指明版本2.2</span></span></span><br><span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">pragma</span> comment(lib, <span class="hljs-meta-string">"ws2_32.lib"</span>) <span class="hljs-comment">// 加载winsock 2.2 Llibrary</span></span></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-keyword">int</span> argc, <span class="hljs-keyword">char</span> *argv[])</span></span></span><br><span class="line"><span class="hljs-function"></span>&#123;</span><br><span class="line">	<span class="hljs-keyword">char</span> host[] = <span class="hljs-string">"127.0.0.1"</span>; <span class="hljs-comment">// server IP Address to connect</span></span><br><span class="line">	<span class="hljs-keyword">char</span> service[] = <span class="hljs-string">"50500"</span>;  <span class="hljs-comment">// server port to connect</span></span><br><span class="line">	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sockaddr_in</span> <span class="hljs-title">sin</span>;</span>	<span class="hljs-comment">// an Internet endpoint address</span></span><br><span class="line">	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sockaddr_in</span> <span class="hljs-title">from</span>;</span>   <span class="hljs-comment">// sender address</span></span><br><span class="line">	<span class="hljs-keyword">int</span> fromsize = <span class="hljs-keyword">sizeof</span>(from);</span><br><span class="line">	<span class="hljs-keyword">char</span> buf[BUFLEN + <span class="hljs-number">1</span>], pts[BUFLEN + <span class="hljs-number">1</span>]; <span class="hljs-comment">// buffer for one line of text</span></span><br><span class="line">	SOCKET sock;						   <span class="hljs-comment">// socket descriptor</span></span><br><span class="line">	<span class="hljs-keyword">int</span> cc;								   <span class="hljs-comment">// recv character count</span></span><br><span class="line">	WSADATA wsadata;</span><br><span class="line">	WSAStartup(WSVERS, &amp;wsadata);					 <span class="hljs-comment">// 加载winsock library，WSVERS为请求版本,wsadata返回系统实际支持的最高版本。</span></span><br><span class="line">	sock = socket(PF_INET, SOCK_DGRAM, IPPROTO_UDP); <span class="hljs-comment">// 创建UDP套接字, 参数：因特网协议簇(family)，数据报套接字，UDP协议号， 返回：要监听套接字的描述符或INVALID_SOCKET</span></span><br><span class="line">	<span class="hljs-built_in">memset</span>(&amp;<span class="hljs-built_in">sin</span>, <span class="hljs-number">0</span>, <span class="hljs-keyword">sizeof</span>(<span class="hljs-built_in">sin</span>));</span><br><span class="line">	<span class="hljs-built_in">sin</span>.sin_family = AF_INET;</span><br><span class="line">	<span class="hljs-built_in">sin</span>.sin_addr.s_addr = INADDR_ANY;				  <span class="hljs-comment">// 绑定(监听)所有的接口。</span></span><br><span class="line">	<span class="hljs-built_in">sin</span>.sin_port = htons((u_short)atoi(service));	 <span class="hljs-comment">// 绑定指定接口。atoi--把ascii转化为int，htons -- 主机序(host)转化为网络序(network), 为short类型。</span></span><br><span class="line">	bind(sock, (struct sockaddr *)&amp;<span class="hljs-built_in">sin</span>, <span class="hljs-keyword">sizeof</span>(<span class="hljs-built_in">sin</span>)); <span class="hljs-comment">// 绑定本地端口号（和本地IP地址)</span></span><br><span class="line">	<span class="hljs-built_in">printf</span>(<span class="hljs-string">"UDPServer Start.\n"</span>);</span><br><span class="line">	<span class="hljs-keyword">while</span> (!_kbhit())</span><br><span class="line">	&#123;																	   <span class="hljs-comment">//检测是否有按键</span></span><br><span class="line">		cc = recvfrom(sock, buf, BUFLEN, <span class="hljs-number">0</span>, (SOCKADDR *)&amp;from, &amp;fromsize); <span class="hljs-comment">//接收客户数据。返回结果：cc为接收的字符数，from中将包含客户IP地址和端口号。</span></span><br><span class="line">		<span class="hljs-keyword">if</span> (cc == SOCKET_ERROR)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="hljs-built_in">printf</span>(<span class="hljs-string">"recvfrom() failed; %d\n"</span>, WSAGetLastError());</span><br><span class="line">			<span class="hljs-keyword">break</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (cc == <span class="hljs-number">0</span>)</span><br><span class="line">			<span class="hljs-keyword">break</span>;</span><br><span class="line">		<span class="hljs-keyword">else</span></span><br><span class="line">		&#123;</span><br><span class="line">			buf[cc] = <span class="hljs-number">0</span>;</span><br><span class="line">			<span class="hljs-keyword">time_t</span> now;</span><br><span class="line">			time(&amp;now); <span class="hljs-comment">// 取得系统时间</span></span><br><span class="line">			<span class="hljs-built_in">sprintf</span>(pts,</span><br><span class="line">					<span class="hljs-string">"Accept Time:\n"</span></span><br><span class="line">					<span class="hljs-string">"%s"</span></span><br><span class="line">					<span class="hljs-string">"sin_port:\n"</span></span><br><span class="line">					<span class="hljs-string">"%u\n"</span></span><br><span class="line">					<span class="hljs-string">"sin_addr:\n"</span></span><br><span class="line">					<span class="hljs-string">"%d.%d.%d.%d\n"</span></span><br><span class="line">					<span class="hljs-string">"Receive Message:\n"</span></span><br><span class="line">					<span class="hljs-string">"%s\n"</span>,</span><br><span class="line">					ctime(&amp;now),</span><br><span class="line">					from.sin_port,</span><br><span class="line">					from.sin_addr.S_un.S_un_b.s_b1,</span><br><span class="line">					from.sin_addr.S_un.S_un_b.s_b2,</span><br><span class="line">					from.sin_addr.S_un.S_un_b.s_b3,</span><br><span class="line">					from.sin_addr.S_un.S_un_b.s_b4,</span><br><span class="line">					buf);</span><br><span class="line">			<span class="hljs-built_in">printf</span>(<span class="hljs-string">"%s"</span>, pts);</span><br><span class="line">			cc = sendto(sock, pts, <span class="hljs-built_in">strlen</span>(pts), <span class="hljs-number">0</span>, (SOCKADDR *)&amp;from, fromsize);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	closesocket(sock);</span><br><span class="line">	WSACleanup(); <span class="hljs-comment">// 卸载某版本的DLL</span></span><br><span class="line">	system(<span class="hljs-string">"pause"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="客户端的全部源代码（或自选主要代码）-1"><a href="#客户端的全部源代码（或自选主要代码）-1" class="headerlink" title="客户端的全部源代码（或自选主要代码）"></a>客户端的全部源代码（或自选主要代码）</h3><figure class="highlight c hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;winsock2.h&gt;</span></span></span><br><span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> BUFLEN 2000				   <span class="hljs-comment">// 缓冲区大小</span></span></span><br><span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> WSVERS MAKEWORD(2, 2)	  <span class="hljs-comment">// 指明版本2.2</span></span></span><br><span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">pragma</span> comment(lib, <span class="hljs-meta-string">"ws2_32.lib"</span>) <span class="hljs-comment">// 加载winsock 2.2 Llibrary</span></span></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-keyword">int</span> argc, <span class="hljs-keyword">char</span> *argv[])</span></span></span><br><span class="line"><span class="hljs-function"></span>&#123;</span><br><span class="line">	<span class="hljs-keyword">char</span> host[] = <span class="hljs-string">"127.0.0.1"</span>;		 <span class="hljs-comment">// server IP to connect</span></span><br><span class="line">	<span class="hljs-keyword">char</span> service[] = <span class="hljs-string">"50500"</span>;		 <span class="hljs-comment">// server port to connect</span></span><br><span class="line">	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sockaddr_in</span> <span class="hljs-title">toAddr</span>, <span class="hljs-title">from</span>;</span> <span class="hljs-comment">// an Internet endpoint address</span></span><br><span class="line">	<span class="hljs-keyword">int</span> fromsize = <span class="hljs-keyword">sizeof</span>(from);</span><br><span class="line">	<span class="hljs-keyword">char</span> buf[BUFLEN + <span class="hljs-number">1</span>]; <span class="hljs-comment">// buffer for one line of text</span></span><br><span class="line">	SOCKET sock;		  <span class="hljs-comment">// socket descriptor</span></span><br><span class="line">	<span class="hljs-keyword">int</span> cc;				  <span class="hljs-comment">// recv character count</span></span><br><span class="line">	WSADATA wsadata;</span><br><span class="line">	WSAStartup(WSVERS, &amp;wsadata); <span class="hljs-comment">// 启动某版本Socket的DLL</span></span><br><span class="line">	sock = socket(PF_INET, SOCK_DGRAM, IPPROTO_UDP);</span><br><span class="line">	<span class="hljs-built_in">memset</span>(&amp;toAddr, <span class="hljs-number">0</span>, <span class="hljs-keyword">sizeof</span>(toAddr));</span><br><span class="line">	toAddr.sin_family = AF_INET;</span><br><span class="line">	toAddr.sin_port = htons((u_short)atoi(service)); <span class="hljs-comment">//atoi：把ascii转化为int. htons：主机序(host)转化为网络序(network), s--short</span></span><br><span class="line">	toAddr.sin_addr.s_addr = inet_addr(host);		 <span class="hljs-comment">//如果host为域名，需要先用函数gethostbyname把域名转化为IP地址</span></span><br><span class="line">	<span class="hljs-built_in">printf</span>(<span class="hljs-string">"Send the Message:\n"</span>);</span><br><span class="line">	gets(buf);</span><br><span class="line">	cc = sendto(sock, buf, <span class="hljs-built_in">strlen</span>(buf), <span class="hljs-number">0</span>, (SOCKADDR *)&amp;toAddr, <span class="hljs-keyword">sizeof</span>(toAddr));</span><br><span class="line">	<span class="hljs-keyword">if</span> (cc == SOCKET_ERROR)</span><br><span class="line">		<span class="hljs-built_in">printf</span>(<span class="hljs-string">"Error:\n%d\n"</span>, WSAGetLastError());</span><br><span class="line">	<span class="hljs-keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">		cc = recvfrom(sock, buf, BUFLEN, <span class="hljs-number">0</span>, (SOCKADDR *)&amp;from, &amp;fromsize);</span><br><span class="line">		<span class="hljs-keyword">if</span> (cc == SOCKET_ERROR)</span><br><span class="line">			<span class="hljs-built_in">printf</span>(<span class="hljs-string">"Receive Error:\n%d\n"</span>, WSAGetLastError());</span><br><span class="line">		<span class="hljs-keyword">else</span></span><br><span class="line">			<span class="hljs-built_in">printf</span>(<span class="hljs-string">"%s"</span>, buf);</span><br><span class="line">	&#125;</span><br><span class="line">	closesocket(sock);</span><br><span class="line">	WSACleanup(); <span class="hljs-comment">// 卸载某版本的DLL</span></span><br><span class="line">	system(<span class="hljs-string">"pause"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="实验体会"><a href="#实验体会" class="headerlink" title="实验体会"></a>实验体会</h1><p>在Windows下使用gcc编译，需要加编译指令-lwsock32来引入套接字的库，于是写了如下脚本帮助编译：</p>
<figure class="highlight bash hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">gcc TCPServer.c -o TCPServer -lwsock32</span><br><span class="line">gcc TCPClient.c -o TCPClient -lwsock32</span><br></pre></td></tr></table></figure>

<p>节省了不少时间。</p>
<p>服务器对收到的消息进行处理这里使用了sprintf这个函数，感觉相比别的方法简化了很多代码。</p>
<p>想当然的认为服务器程序只需要按下键盘就会退出，说明一开始对阻塞的理解还不透彻啊。</p>

        </div>
        
        
        
    </div>
</div>








    <div class="card">
    
    <div class="card-content article ">
        
        <div class="level article-meta is-size-7 is-uppercase is-mobile is-overflow-x-auto">
            <div class="level-left">
                <time class="level-item has-text-grey" datetime="2019-04-10T16:08:06.397Z">2019-04-11</time>
                
                <div class="level-item">
                <a class="has-link-grey -link" href="/categories/计算机网络/">计算机网络</a>
                </div>
                
                
                <span class="level-item has-text-grey">
                    
                    
                    13 分钟 读完 (大约 1880 个字)
                </span>
                
                
            </div>
        </div>
        
        <h1 class="title is-size-3 is-size-4-mobile has-text-weight-normal">
            
                <a class="has-link-black-ter" href="/2019/04/11/2019-03-19-Chat实验/"></a>
            
        </h1>
        <div class="content">
            <h1 id="实验题目"><a href="#实验题目" class="headerlink" title="实验题目"></a>实验题目</h1><p>Chat实验</p>
<h1 id="实验目的"><a href="#实验目的" class="headerlink" title="实验目的"></a>实验目的</h1><p>掌握套节字的多线程编程方法。</p>
<h1 id="实验介绍"><a href="#实验介绍" class="headerlink" title="实验介绍"></a>实验介绍</h1><p>利用客户/服务器(Client/Sever或CS)模式实现一个多人聊天(群聊)程序。其功能是每个客户发送给服务器的消息都会传送给所有的客户端。</p>
<figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">graph TB</span><br><span class="line">服务器--Hello--&gt;A</span><br><span class="line">A==Hello==&gt;服务器</span><br><span class="line">服务器--Hello--&gt;B</span><br><span class="line">服务器--Hello--&gt;C</span><br><span class="line">服务器--Hello--&gt;D</span><br></pre></td></tr></table></figure>

<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><ul>
<li><a href="https://docs.microsoft.com/en-us/windows/desktop/WinSock/getting-started-with-winsock" target="_blank" rel="noopener">https://docs.microsoft.com/en-us/windows/desktop/WinSock/getting-started-with-winsock</a> （套接字）</li>
<li><a href="https://www.cnblogs.com/hgwang/p/6074038.html" target="_blank" rel="noopener">https://www.cnblogs.com/hgwang/p/6074038.html</a>  （套接字）</li>
<li><a href="https://www.jb51.net/article/37410.htm" target="_blank" rel="noopener">https://www.jb51.net/article/37410.htm</a>  （字符串）</li>
<li><a href="https://docs.microsoft.com/en-us/cpp/c-runtime-library/stream-i-o?view=vs-2017" target="_blank" rel="noopener">https://docs.microsoft.com/en-us/cpp/c-runtime-library/stream-i-o?view=vs-2017</a>  （字符串）</li>
<li><a href="https://docs.microsoft.com/en-us/cpp/c-runtime-library/reference/crt-alphabetical-function-reference?view=vs-2017#s" target="_blank" rel="noopener">https://docs.microsoft.com/en-us/cpp/c-runtime-library/reference/crt-alphabetical-function-reference?view=vs-2017#s</a>   （字符串）</li>
<li><a href="http://www.runoob.com/cprogramming/" target="_blank" rel="noopener">http://www.runoob.com/cprogramming/</a>  （字符串）</li>
<li>例程“_beginthreadex”          （创建线程）</li>
<li>例程“TCPServer和TCPClient”    （传送服务器时间）</li>
<li>课件“套接字并发编程.PDF”</li>
<li>Chat实验的课件</li>
</ul>
<h1 id="实验环境"><a href="#实验环境" class="headerlink" title="实验环境"></a>实验环境</h1><ul>
<li>Windows + VS 2012<ul>
<li>对于VS2015和VS2017默认使用安全周期检查，如果不关闭VS的安全周期检查，很多字符串函数都不能用。</li>
</ul>
</li>
<li>Linux + gcc</li>
</ul>
<p>这里我使用的环境是Windows 10 + VSCode + gcc version 8.1.0 (x86_64-posix-sjlj-rev0, Built by MinGW-W64 project)</p>
<h1 id="实验内容"><a href="#实验内容" class="headerlink" title="实验内容"></a>实验内容</h1><p>先阅读课件“套接字并发编程.PDF”。重点是读懂课件中“chat并发编程(服务器)”和“chat并发编程(客户端)”的流程图。 然后，完成下面步骤（截屏要同时显示服务器和至少两个客户端）：</p>
<ol>
<li>编写多人聊天程序，要求客户端和服务器都采用多线程方式进行编程。每个客户端都采用TCP协议连接服务器并保持连接。服务器同时与所有客户端建立和保持连接。每个客户端输入的消息都会通过服务器转发给所有客户。</li>
<li>服务器程序转发某个客户端发来的消息时都在消息前面加上该客户端的IP地址和端口号以及服务器的当前时间。要求服务器程序把转发的 消息也显示出来。</li>
<li>新客户刚连接时服务器端把“enter”消息（包含客户端IP地址和端口号）发送给所有客户端。</li>
<li>客户端输入exit时退出客户端程序（正常退出），或者客户端直接关闭窗口退出（异常退出），服务器都会把该客户leave的消息广播给所有客户。</li>
</ol>
<p>客户端程序：</p>
<figure class="highlight c hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;process.h&gt;</span></span></span><br><span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;winsock2.h&gt;</span></span></span><br><span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> BUFLEN 2000</span></span><br><span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> WSVERS MAKEWORD(2, 0)</span></span><br><span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">pragma</span> comment(lib, <span class="hljs-meta-string">"ws2_32.lib"</span>)</span></span><br><span class="line"><span class="hljs-keyword">int</span> finish = <span class="hljs-number">0</span>;</span><br><span class="line"><span class="hljs-keyword">unsigned</span> __<span class="hljs-function">stdcall <span class="hljs-title">recvMessage</span><span class="hljs-params">(SOCKET *p)</span></span></span><br><span class="line"><span class="hljs-function"></span>&#123;</span><br><span class="line">	<span class="hljs-keyword">for</span> (<span class="hljs-keyword">char</span> buf[BUFLEN];;)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="hljs-keyword">int</span> cc = recv(*p, buf, BUFLEN, <span class="hljs-number">0</span>); <span class="hljs-comment">// BUFLEN为缓冲区buf的长度，返回值：接收的字符数(&gt;0)、对方已关闭(=0) 或连接出错(&lt;0)</span></span><br><span class="line">		<span class="hljs-keyword">if</span> (finish)</span><br><span class="line">			<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;</span><br><span class="line">		<span class="hljs-keyword">if</span> (cc &gt; <span class="hljs-number">0</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			buf[cc] = <span class="hljs-string">'\0'</span>;	<span class="hljs-comment">//  ensure null-termination</span></span><br><span class="line">			<span class="hljs-built_in">printf</span>(<span class="hljs-string">"%s"</span>, buf); <span class="hljs-comment">// 显示所接收的字符串</span></span><br><span class="line">		&#125;</span><br><span class="line">		<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (cc == SOCKET_ERROR)</span><br><span class="line">			<span class="hljs-built_in">printf</span>(<span class="hljs-string">"Recv Error:\n%d\n"</span>, GetLastError());</span><br><span class="line">		<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (cc == <span class="hljs-number">0</span>)</span><br><span class="line">			<span class="hljs-built_in">printf</span>(<span class="hljs-string">"Recv connect closed.\n"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span></span><br><span class="line"><span class="hljs-function"></span>&#123;</span><br><span class="line">	<span class="hljs-keyword">char</span> buf[BUFLEN];</span><br><span class="line">	WSADATA wsadata;</span><br><span class="line">	WSAStartup(WSVERS, &amp;wsadata);</span><br><span class="line">	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sockaddr_in</span> <span class="hljs-title">sin</span>;</span> <span class="hljs-comment">// an Internet endpoint address</span></span><br><span class="line">	<span class="hljs-built_in">memset</span>(&amp;<span class="hljs-built_in">sin</span>, <span class="hljs-number">0</span>, <span class="hljs-keyword">sizeof</span>(<span class="hljs-built_in">sin</span>));</span><br><span class="line">	<span class="hljs-built_in">sin</span>.sin_family = AF_INET; <span class="hljs-comment">// 因特网地址簇</span></span><br><span class="line">	<span class="hljs-built_in">printf</span>(<span class="hljs-string">"Input the IP address:\n"</span>);</span><br><span class="line">	gets(buf);</span><br><span class="line">	<span class="hljs-built_in">sin</span>.sin_addr.s_addr = inet_addr(buf); <span class="hljs-comment">// 服务器IP地址(32位)</span></span><br><span class="line">	<span class="hljs-built_in">printf</span>(<span class="hljs-string">"Input the IP port:\n"</span>);</span><br><span class="line">	gets(buf);</span><br><span class="line">	<span class="hljs-built_in">sin</span>.sin_port = htons(atoi(buf));						 <span class="hljs-comment">// 服务器端口号(16位)</span></span><br><span class="line">	SOCKET sock = socket(PF_INET, SOCK_STREAM, IPPROTO_TCP); <span class="hljs-comment">// socket descriptor</span></span><br><span class="line">	<span class="hljs-keyword">int</span> ret = connect(sock, &amp;<span class="hljs-built_in">sin</span>, <span class="hljs-keyword">sizeof</span>(<span class="hljs-built_in">sin</span>));				 <span class="hljs-comment">// 连接到服务器.无错时，返回0；否则，返回SOCKET_ERROR ，可以调用函数WSAGetLastError取得错误代码</span></span><br><span class="line">	HANDLE h = _beginthreadex(<span class="hljs-literal">NULL</span>, <span class="hljs-number">0</span>, &amp;recvMessage, &amp;sock, <span class="hljs-number">0</span>, <span class="hljs-literal">NULL</span>);</span><br><span class="line">	<span class="hljs-keyword">for</span> (;;)</span><br><span class="line">	&#123;</span><br><span class="line">		gets(buf);</span><br><span class="line">		<span class="hljs-keyword">if</span> (!<span class="hljs-built_in">strcmp</span>(buf, <span class="hljs-string">"exit"</span>))</span><br><span class="line">			<span class="hljs-keyword">break</span>;</span><br><span class="line">		<span class="hljs-keyword">int</span> cc = send(sock, buf, <span class="hljs-built_in">strlen</span>(buf), <span class="hljs-number">0</span>); <span class="hljs-comment">//把缓冲区buf的数据发送出去，len为要发送的字节数，返回值：(&gt;0) 实际发送的字节数(≤len), (=0) 对方正常关闭，（=SOCKET_ERROR) 出错，用函数WSAGetLastError取错误码。</span></span><br><span class="line">		<span class="hljs-keyword">if</span> (cc == SOCKET_ERROR)</span><br><span class="line">			<span class="hljs-built_in">printf</span>(<span class="hljs-string">"Send Error:\n%d\n"</span>, GetLastError());</span><br><span class="line">		<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (cc == <span class="hljs-number">0</span>)</span><br><span class="line">			<span class="hljs-built_in">printf</span>(<span class="hljs-string">"Send connect closed.\n"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	finish = <span class="hljs-number">1</span>;</span><br><span class="line">	CloseHandle(h);</span><br><span class="line">	closesocket(sock); <span class="hljs-comment">// 关闭套接字</span></span><br><span class="line">	WSACleanup();	  <span class="hljs-comment">//  卸载winsock library</span></span><br><span class="line">	system(<span class="hljs-string">"pause"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>服务器端程序：</p>
<figure class="highlight c hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;time.h&gt;</span></span></span><br><span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;process.h&gt;</span></span></span><br><span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;winsock2.h&gt;</span></span></span><br><span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> BUFLEN 2000</span></span><br><span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> WSVERS MAKEWORD(2, 0)</span></span><br><span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">pragma</span> comment(lib, <span class="hljs-meta-string">"ws2_32.lib"</span>) <span class="hljs-comment">//使用winsock 2.2 library</span></span></span><br><span class="line">SOCKET ssock[BUFLEN];			   <span class="hljs-comment">//master &amp; *p sockets</span></span><br><span class="line"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sockaddr_in</span> <span class="hljs-title">ssin</span>[<span class="hljs-title">BUFLEN</span>];</span></span><br><span class="line"><span class="hljs-keyword">int</span> sbadd[BUFLEN], ssock_size = <span class="hljs-number">0</span>;</span><br><span class="line"><span class="hljs-keyword">unsigned</span> __<span class="hljs-function">stdcall <span class="hljs-title">server</span><span class="hljs-params">(<span class="hljs-keyword">int</span> *p)</span></span></span><br><span class="line"><span class="hljs-function"></span>&#123;</span><br><span class="line">	<span class="hljs-keyword">for</span> (<span class="hljs-keyword">char</span> msg[BUFLEN] = <span class="hljs-string">"Enter!"</span>, pts[BUFLEN];;)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="hljs-keyword">time_t</span> now = time(<span class="hljs-literal">NULL</span>);</span><br><span class="line">		<span class="hljs-built_in">sprintf</span>(pts,</span><br><span class="line">				<span class="hljs-string">"ip: %d.%d.%d.%d port: %u\n"</span></span><br><span class="line">				<span class="hljs-string">"time: %s"</span></span><br><span class="line">				<span class="hljs-string">"message: %s\n"</span></span><br><span class="line">				<span class="hljs-string">"\n&gt;&gt;"</span>,</span><br><span class="line">				ssin[*p].sin_addr.S_un.S_un_b.s_b1,</span><br><span class="line">				ssin[*p].sin_addr.S_un.S_un_b.s_b2,</span><br><span class="line">				ssin[*p].sin_addr.S_un.S_un_b.s_b3,</span><br><span class="line">				ssin[*p].sin_addr.S_un.S_un_b.s_b4,</span><br><span class="line">				ssin[*p].sin_port,</span><br><span class="line">				ctime(&amp;now),</span><br><span class="line">				msg);</span><br><span class="line">		<span class="hljs-built_in">printf</span>(pts);</span><br><span class="line">		<span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; ssock_size; ++i)</span><br><span class="line">			send(ssock[i], pts, <span class="hljs-built_in">strlen</span>(pts), <span class="hljs-number">0</span>);</span><br><span class="line">		<span class="hljs-keyword">if</span> (!<span class="hljs-built_in">strcmp</span>(msg, <span class="hljs-string">"Leave!"</span>))</span><br><span class="line">			<span class="hljs-keyword">return</span> closesocket(ssock[*p]), <span class="hljs-number">0</span>; <span class="hljs-comment">//关闭连接套接字</span></span><br><span class="line">		<span class="hljs-keyword">int</span> cc = recv(ssock[*p], msg, BUFLEN, <span class="hljs-number">0</span>);</span><br><span class="line">		<span class="hljs-keyword">if</span> (cc &gt; <span class="hljs-number">0</span>)</span><br><span class="line">			msg[cc] = <span class="hljs-number">0</span>;</span><br><span class="line">		<span class="hljs-keyword">else</span></span><br><span class="line">			<span class="hljs-built_in">sprintf</span>(msg, <span class="hljs-string">"Leave!"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span></span><br><span class="line"><span class="hljs-function"></span>&#123;</span><br><span class="line">	WSADATA wsadata;</span><br><span class="line">	WSAStartup(WSVERS, &amp;wsadata);							  <span class="hljs-comment">//加载winsock library，WSVERS为请求版本，wsadata返回系统实际支持的最高版本</span></span><br><span class="line">	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sockaddr_in</span> <span class="hljs-title">msin</span>;</span>								  <span class="hljs-comment">//an Internet endpoint addresss</span></span><br><span class="line">	<span class="hljs-built_in">memset</span>(&amp;msin, <span class="hljs-number">0</span>, <span class="hljs-keyword">sizeof</span>(msin));							  <span class="hljs-comment">//从&amp;sin开始的长度为sizeof(sin)的内存清0 , sin为一个地址结构</span></span><br><span class="line">	msin.sin_family = AF_INET;								  <span class="hljs-comment">//因特网地址簇(INET-Internet)</span></span><br><span class="line">	msin.sin_addr.s_addr = INADDR_ANY;						  <span class="hljs-comment">//监听所有(接口的)IP地址(32位)，0.0.0.0</span></span><br><span class="line">	msin.sin_port = htons(atoi(<span class="hljs-string">"50500"</span>));					  <span class="hljs-comment">//监听的端口号(16位) 。atoi--把ascii转化为int，htons—主机序到网络序</span></span><br><span class="line">	SOCKET msock = socket(PF_INET, SOCK_STREAM, IPPROTO_TCP); <span class="hljs-comment">//创建套接字。参数：因特网协议簇(family)，字节流，TCP协议号。 返回：要监听套接字的描述符或INVALID_SOCKET</span></span><br><span class="line">	bind(msock, (struct sockaddr *)&amp;msin, <span class="hljs-keyword">sizeof</span>(msin));	  <span class="hljs-comment">//通过msin把要监听的IP地址和端口号绑定到套接字上</span></span><br><span class="line">	listen(msock, <span class="hljs-number">5</span>);										  <span class="hljs-comment">//建立长度为5的连接请求队列，并开始监听是否有连接请求到来，来了则放入队列</span></span><br><span class="line">	<span class="hljs-built_in">printf</span>(<span class="hljs-string">"Server Start to listen.\n"</span>);</span><br><span class="line">	<span class="hljs-keyword">while</span> (!_kbhit()) <span class="hljs-comment">//检测是否有按键 (什么时候执行？)</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="hljs-keyword">int</span> alen = <span class="hljs-keyword">sizeof</span>(struct sockaddr);												<span class="hljs-comment">//from-address length</span></span><br><span class="line">		ssock[ssock_size] = accept(msock, (struct sockaddr *)&amp;ssin[ssock_size], &amp;alen); <span class="hljs-comment">//accept：如果有新的连接请求，返回连接套接字，否则，被阻塞，ssin包含客户端IP地址和端口号</span></span><br><span class="line">		sbadd[ssock_size] = ssock_size;</span><br><span class="line">		_beginthreadex(<span class="hljs-literal">NULL</span>, <span class="hljs-number">0</span>, &amp;server, &amp;sbadd[ssock_size++], <span class="hljs-number">0</span>, <span class="hljs-literal">NULL</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	closesocket(msock);</span><br><span class="line">	WSACleanup();</span><br><span class="line">	system(<span class="hljs-string">"pause"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>运行效果如下：<br><img src="/2019/04/11/2019-03-19-Chat实验/image/2019-03-19-1.jpg" alt></p>
<p>测试一下客户端是否能够连上老师在校园网搭的服务器（172.18.187.9:50500）：<br>运行截屏（客户端）：<br><img src="/2019/04/11/2019-03-19-Chat实验/image/2019-03-19-2.jpg" alt></p>
<p>和同学互测一下看看，作为服务器运行截屏：<br><img src="/2019/04/11/2019-03-19-Chat实验/image/2019-03-19-3.jpg" alt><br>作为客户端运行截屏：<br><img src="/2019/04/11/2019-03-19-Chat实验/image/2019-03-19-4.jpg" alt></p>
<h1 id="实验体会"><a href="#实验体会" class="headerlink" title="实验体会"></a>实验体会</h1><ol>
<li>在服务端的程序中，一开始传新连接的下标的指针到子线程的时候直接传了一个局部变量过去，结果在新开的线程里就会出错；原因是局部变量已经被析构。随后使用一个全局数组作为过渡。为什么是数组？因为假设只用一个变量进行过渡的话，在有多人同时连接，新开多个线程时可能该变量的变化早于新开线程的参数传递。</li>
<li>在和同学测试时没有关掉本机防火墙，导致接收不到同学发来的消息。</li>
<li>客户端输入exit下线时，如果不接受的线程不同时关闭的话会不断报错。于是额外用一个全局变量<code>finish</code>来中转，子线程在<code>finish</code>值变化的时候不再接受消息。</li>
</ol>

        </div>
        
        
        
    </div>
</div>








    <div class="card">
    
    <div class="card-content article ">
        
        <div class="level article-meta is-size-7 is-uppercase is-mobile is-overflow-x-auto">
            <div class="level-left">
                <time class="level-item has-text-grey" datetime="2019-04-10T16:08:06.396Z">2019-04-11</time>
                
                <div class="level-item">
                <a class="has-link-grey -link" href="/categories/计算机网络/">计算机网络</a>
                </div>
                
                
                <span class="level-item has-text-grey">
                    
                    
                    7 分钟 读完 (大约 1079 个字)
                </span>
                
                
            </div>
        </div>
        
        <h1 class="title is-size-3 is-size-4-mobile has-text-weight-normal">
            
                <a class="has-link-black-ter" href="/2019/04/11/2019-03-06-计算机网络 第一章 概述/"></a>
            
        </h1>
        <div class="content">
            <h1 id="什么是计算机网络？"><a href="#什么是计算机网络？" class="headerlink" title="什么是计算机网络？"></a>什么是计算机网络？</h1><blockquote>
<p>计算机网络(computer network)是自主计算机的互连集合。（ANDREW S. TANENBAUM）</p>
</blockquote>
<blockquote>
<p>计算机网络是利用通信设备和线路将地理位置不同的、功 能独立的<strong>多个计算机系统***</strong>连接***起来，以功能完善的网络软件实现网络的硬件、软件及资源共享和信息传递的系统。 简单来说就是连接两台或多台计算机进行通信的系统。（维基百科）</p>
</blockquote>
<h2 id="直接连接的网络"><a href="#直接连接的网络" class="headerlink" title="直接连接的网络"></a>直接连接的网络</h2><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">graph LR</span><br><span class="line">A--链路（link），专用介质（dedicated medium）---B,节点(node)或主机(host)</span><br></pre></td></tr></table></figure>

<p>点到点网络 (point-to-point network)</p>
<ul>
<li>单向(simplex)</li>
<li>半双工(half duplex)</li>
<li>全双工(full duplex)</li>
</ul>
<figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">graph LR</span><br><span class="line">共享介质(shared medium), 广播, 碰撞(collision)</span><br></pre></td></tr></table></figure>

<p>多路访问网络 (multiple access network)</p>
<ul>
<li>单播(unicast)</li>
<li>多播(multicast)</li>
<li>广播(broadcast)</li>
</ul>
<h2 id="间接连接的网络"><a href="#间接连接的网络" class="headerlink" title="间接连接的网络"></a>间接连接的网络</h2><ul>
<li>中间节点、路由器(router)</li>
<li>包(packet)</li>
<li>存储转发(store-and-forward)</li>
<li>路由选择(routing)</li>
<li>路由(route)</li>
<li>目的地(destination),下一跳(next hop)</li>
<li>路由表(routing table)</li>
</ul>
<h2 id="网络互连"><a href="#网络互连" class="headerlink" title="网络互连"></a>网络互连</h2><p>用路由器(或网关)连接起来构成的网络称为互连网络(internetwork 或internet)。因特网 (Internet) 是一种互连网络。</p>
<figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">graph TB</span><br><span class="line">路由器---网络1</span><br><span class="line">路由器---网络2</span><br><span class="line">路由器---网络3</span><br></pre></td></tr></table></figure>

<ul>
<li>系统域网(System Area Network, SAN)</li>
<li>局域网(Local Area Network, LAN)</li>
<li>城域网(Metropolitan Area Network, MAN)</li>
<li>广域网(Wide Area Network, WAN)</li>
</ul>
<p>局域网（LAN）：一般限定在较小的区域内（小于10km的范围），通常采用有线的方法连接起来。<br>城域网（MAN）：规模局限在一座城市的范围内。<br>广域网（WAN）：网络跨越国界、洲界，甚至遍及全球范围。<br>个人区域网（PAN）：一般指家庭一台或多台电脑所使用的网络<br>无线局域网（WLAN）：是指通过无线设备建立的，给支持无线通信的设备使用的，比如无线网卡，或手机上的WIFI。</p>
<h1 id="什么是因特网？"><a href="#什么是因特网？" class="headerlink" title="什么是因特网？"></a>什么是因特网？</h1><p>ISP ( Internet Service Provider) – 因特网服务提供商</p>
<ul>
<li>终端系统(end system)：主机<ul>
<li>运行网络应用程序 (例如，浏览器)</li>
</ul>
</li>
<li>通信链路(communication link)<ul>
<li>光纤, 铜线, 无线电, 卫星</li>
<li>传输速率=带宽</li>
</ul>
</li>
<li>路由器(router)</li>
</ul>
<h1 id="因特网体系结构"><a href="#因特网体系结构" class="headerlink" title="因特网体系结构"></a>因特网体系结构</h1><h2 id="网络提供的服务"><a href="#网络提供的服务" class="headerlink" title="网络提供的服务"></a>网络提供的服务</h2><p>数据链路层一般都提供3种基本服务，即无确认的无连接服务、有确认的无连接服务、有确认 的面向连接的服务。</p>
<p>（1）无确认的无连接服务 无确认的无连接服务是源机器向目的机器发送独立的帧，而目的机器对收到的帧不作确认。<br>如果由于线路上的噪声而造成帧丢失，数据链路层不作努力去恢复它，恢复工作留给上层去完成。<br>这类服务适用于误码率很低的情况，也适用于像语音之类的实时传输，实时传输情况下有时数据延误比数据损坏影响更严重。<br>大多数局域网在数据链路层都使用无确认的无连接服务。</p>
<p>（2）有确认的无连接服务 这种服务仍然不建立连接，但是所发送的每一帧都进行单独确认。<br>以这种方式，发送方就会知道帧是否正确地到达。如果在某个确定的时间间隔内，帧没有到达，就必须重新发此帧。</p>
<p>（3）有确认的面向连接的服务 采用这种服务，源机器和目的机器在传递任何数据之前，先建立一条连接。<br>在这条连接上所发送的每一帧都被编上号，数据链路层保证所发送的每一帧都确实已收到。<br>而且，它保证每帧只收到一次，所有的帧都是按正确顺序收到的。面向连接的服务为网络进程间提供了可靠地传送比特流的服务。</p>
<h1 id="开放系统互连参考模型"><a href="#开放系统互连参考模型" class="headerlink" title="开放系统互连参考模型"></a>开放系统互连参考模型</h1><h1 id="网络性能分析"><a href="#网络性能分析" class="headerlink" title="网络性能分析"></a>网络性能分析</h1>
        </div>
        
        
        
    </div>
</div>








    <div class="card">
    
    <div class="card-content article ">
        
        <div class="level article-meta is-size-7 is-uppercase is-mobile is-overflow-x-auto">
            <div class="level-left">
                <time class="level-item has-text-grey" datetime="2019-04-10T16:08:06.396Z">2019-04-11</time>
                
                <div class="level-item">
                <a class="has-link-grey -link" href="/categories/超级计算机原理与操作/">超级计算机原理与操作</a>
                </div>
                
                
                <span class="level-item has-text-grey">
                    
                    
                    15 分钟 读完 (大约 2181 个字)
                </span>
                
                
            </div>
        </div>
        
        <h1 class="title is-size-3 is-size-4-mobile has-text-weight-normal">
            
                <a class="has-link-black-ter" href="/2019/04/11/2019-03-06-超级计算机原理与操作（1）/"></a>
            
        </h1>
        <div class="content">
            <h1 id="习题"><a href="#习题" class="headerlink" title="习题"></a>习题</h1><h2 id="1-1"><a href="#1-1" class="headerlink" title="1.1"></a>1.1</h2><blockquote>
<p>为求全局总和例子中的<code>my_first_i</code>和<code>my_last_i</code>推导一个公式。需要注意的是：在循环中，应该给各个核分配数目大致相同的计算元素。 （ 提示： 先考虑n 能被 p 整除的情况）。</p>
<figure class="highlight c hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="hljs-keyword">for</span> (my_i = my_first_i my_i &lt; my_last_i; ++my_i)</span><br><span class="line">&gt; &#123;</span><br><span class="line">&gt; 	my_x = Compute_next_value(...);</span><br><span class="line">&gt; 	my_sum += my_x;</span><br><span class="line">&gt; &#125;</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<p>可以看出对于每个核心$i$，其对应累加的范围是左闭合区间$[my_first_i,my_last_i)$。</p>
<p>假设所有$p$个核心的编号是$0,1,\ldots,p-1$，显然对于除了最后一个核心之外，其余核心的区间长度都应当是$\lceil\frac{n}{p}\rceil$，其中$\lceil\rceil$表示向上取整。</p>
<p>因此，可以得到结果：</p>
<ul>
<li>对于每个核心$i$，显然有$my_first_i=(i-1)\times\lceil\frac{n}{p}\rceil$；</li>
<li>对于最后一个核心$i=p$，显然有$my_last_i=n-1$</li>
<li>对于除了最后一个核心之外的每个核心$i$，有$my_last_i=my_first_(i+1)=i\times\lceil\frac{n}{p}\rceil$</li>
</ul>
<h2 id="1-6"><a href="#1-6" class="headerlink" title="1.6"></a>1.6</h2><p>在下列情况中，推到公式求出 0 号核执行接受与加法操作的次数。</p>
<blockquote>
<p>最初的求全局总和的伪代码</p>
</blockquote>
<p>0号核接受其余$p-1$个核的结果并把它们加起来，因此执行了$p-1$次接受操作和$p-1$次加法操作。</p>
<blockquote>
<p>树形结构求全局总和</p>
</blockquote>
<p>在树形结构除了根节点那一层的每一层里，0号核心都接受相邻节点的结果并把它和自己的结果相加，而树形结构有$\lceil\log_2n\rceil+1$层，因此进行了$\lceil\log_2n\rceil$次护额受操作和加法操作。</p>
<blockquote>
<p>制作一张表来比较这两种算法在总核数是$2,4,8,\ldots,1024$时，0 号核执行的接收与加法操作的次数</p>
</blockquote>
<table>
<thead>
<tr>
<th>总核数</th>
<th>最初的分块法</th>
<th>树形求和法</th>
</tr>
</thead>
<tbody><tr>
<td>2</td>
<td>1</td>
<td>1</td>
</tr>
<tr>
<td>4</td>
<td>3</td>
<td>2</td>
</tr>
<tr>
<td>8</td>
<td>7</td>
<td>3</td>
</tr>
<tr>
<td>16</td>
<td>15</td>
<td>4</td>
</tr>
<tr>
<td>32</td>
<td>31</td>
<td>5</td>
</tr>
<tr>
<td>64</td>
<td>63</td>
<td>6</td>
</tr>
<tr>
<td>128</td>
<td>127</td>
<td>7</td>
</tr>
<tr>
<td>256</td>
<td>255</td>
<td>8</td>
</tr>
<tr>
<td>512</td>
<td>511</td>
<td>9</td>
</tr>
<tr>
<td>1024</td>
<td>1023</td>
<td>10</td>
</tr>
</tbody></table>
<h2 id="2-2"><a href="#2-2" class="headerlink" title="2.2"></a>2.2</h2><blockquote>
<p>请解释在 CPU 硬件里实现的一个队列，怎么使用可以提高写直达高速缓存（write-through cache）的性能。</p>
</blockquote>
<p>队列的特点是队尾插入队首删除。要提高写直达高速缓存的性能，就要尽量避免频繁操作主存区。因此，可以只将队首和队尾元素放进缓存区，仅在插入删除时更新缓存区。</p>
<h2 id="2-3"><a href="#2-3" class="headerlink" title="2.3"></a>2.3</h2><blockquote>
<p>回顾之前一个从缓存读取二维数组的示例。请问一个更大矩阵和一个更大的缓存是如何影响两对嵌套循环的性能的？如果 MAX = 8，缓存可以存储 4 个缓存行，情况又会是怎样的？在第一对嵌套循环中对 A 的读操作，会导致发生多少次失效？第二对嵌套循环中的失效次数又是多少？</p>
<figure class="highlight c hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="hljs-keyword">double</span> A[MAX][MAX], x[MAX], y[MAX];</span><br><span class="line">&gt; <span class="hljs-comment">/* First pair of loops */</span></span><br><span class="line">&gt; <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; MAX; ++i)</span><br><span class="line">&gt; 	<span class="hljs-keyword">for</span> (j = <span class="hljs-number">0</span>; j &lt; MAX; ++j)</span><br><span class="line">&gt; 		y[i] += A[i][j] * x[j];</span><br><span class="line">&gt; <span class="hljs-comment">/* Second pair of loops */</span></span><br><span class="line">&gt; <span class="hljs-keyword">for</span> (j = <span class="hljs-number">0</span>; j &lt; MAX; ++j)</span><br><span class="line">&gt; 	<span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; MAX; ++i)</span><br><span class="line">&gt; 		y[i] += A[i][j] * x[j];</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<blockquote>
<table>
<thead>
<tr>
<th>Cache Line</th>
<th>Elements of A</th>
<th></th>
<th></th>
<th></th>
</tr>
</thead>
<tbody><tr>
<td>0</td>
<td>A[0][0]</td>
<td>A[0][1]</td>
<td>A[0][2]</td>
<td>A[0][3]</td>
</tr>
<tr>
<td>1</td>
<td>A[1][0]</td>
<td>A[1][1]</td>
<td>A[1][2]</td>
<td>A[1][3]</td>
</tr>
<tr>
<td>2</td>
<td>A[2][0]</td>
<td>A[2][1]</td>
<td>A[2][2]</td>
<td>A[2][3]</td>
</tr>
<tr>
<td>3</td>
<td>A[3][0]</td>
<td>A[3][1]</td>
<td>A[3][2]</td>
<td>A[3][3]</td>
</tr>
</tbody></table>
</blockquote>
<p>更大的缓存会增加两个循环的性能，其中第一个循环性能增加更多，因为第一个循环是操作的内存地址都是相邻的，缓存增加后从主存中读取元素的次数减少了。同理，更大的矩阵会显著降低第一个循环的性能，而对第二个循环的影响较小。</p>
<p>MAX=8时，第一对循环的读操作一行有两次缺失的发生，会发生$2\times 8=16$次失效。第二对循环一列有八次缺失的发生，会发生$8\times 8=64$次失效。</p>
<h2 id="2-16"><a href="#2-16" class="headerlink" title="2.16"></a>2.16</h2><blockquote>
<p>假定一个串行程序的运行时间为$𝑇<em>{串行} = 𝑛^2$，运行时间的单位为毫秒。并行程序的运行时间为$𝑇</em>{并行} = 𝑛^2/𝑝  + \log_2𝑝$。对于n 和p 的不同值，请写出一个程序并找出这个程序的加速比和效率。在 𝑛 = 10 、 20 、 40 、 …、 320 和𝑝 = 1 、 2 、 4 、 …、 128 等不同情况下运行该程序。当 𝑝 增加、 n 保持恒定时，加速比和效率的情况分别如何？当p 保持恒定而n 增加呢？</p>
</blockquote>
<p>如下这段c语言矩阵加法的程序，随着n的增加，运行时间成二次增长，其对应的并行版本的时间$𝑇<em>{并行} = 𝑛^2/𝑝  + T</em>{开销}$。</p>
<figure class="highlight c hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> N 320</span></span><br><span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> double lf</span></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">addMatrix</span><span class="hljs-params">(lf a[N][N], lf b[N][N])</span></span></span><br><span class="line"><span class="hljs-function"></span>&#123;</span><br><span class="line">	<span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; N; ++i)</span><br><span class="line">		<span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> j = <span class="hljs-number">0</span>; j &lt; N; ++j)</span><br><span class="line">			a[i][j] += b[i][j];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>p增加，n保持恒定的时候，加速比先增后降，效率降低。</p>
<p>p保持恒定，n增加的时候，加速比增加，效率增加。</p>
<blockquote>
<p>假设$𝑇<em>{并行}=𝑇</em>{串行}/𝑝+𝑇_{开销}$，我们固定p 的大小，并增加问题的规模。</p>
<ul>
<li>请解释如果$𝑇<em>{开销}$比$𝑇</em>{串行}$增长得慢，随着问题规模的增加，并行效率也将增加。</li>
<li>请解释如果$𝑇<em>{开销}$比$𝑇</em>{串行}$增长得快，随着问题规模的增加，并行效率将降低。</li>
</ul>
</blockquote>
<p>$E=\frac{T_{串行}}{pT_{并行}}=\frac{T_{串行}}{p(𝑇<em>{串行}/𝑝+𝑇</em>{开销})}=\frac{1}{1+p\frac{T_{开销}}{T_{串行}}}$,显然$\frac{T_{开销}}{T_{串行}}$越大,效率E越小,反之亦然.因此:</p>
<ul>
<li>如果$𝑇<em>{开销}$比$𝑇</em>{串行}$增长得慢，随着问题规模的增加，$\frac{T_{开销}}{T_{串行}}$减小,并行效率E增加。</li>
<li>如果$𝑇<em>{开销}$比$𝑇</em>{串行}$增长得快，随着问题规模的增加，$\frac{T_{开销}}{T_{串行}}$增加,并行效率将降低。</li>
</ul>
<h2 id="2-17"><a href="#2-17" class="headerlink" title="2.17"></a>2.17</h2><blockquote>
<p>如果一个并行程序所获得的加速比可以超过 𝑝（进程或线程的个数），则我们有时称该并行程序拥有超线性加速比（superlinear speedup）。然而，许多作者并不将能够克服“资源限制”的程序视为是拥有超线性加速比。例如，当一个程序运行在一个单处理器系统上时，它必须使用二级存储，当它运行在一个大的分布式内存系统上时，它可以将所有数据都放置在主存上。请给出另外一个例子，说明程序是如何克服资源限制，并获得大于𝑝的加速比的。</p>
</blockquote>
<p>当一个程序串行运行的时候，某些资源可能会在程序的不同阶段被重复加载。并行运行的时候，这些资源可以只加载一次，然后进程/线程可以共享，避免重复加载。</p>
<h2 id="2-19"><a href="#2-19" class="headerlink" title="2.19"></a>2.19</h2><blockquote>
<p>假定$𝑇<em>{串行}=𝑛,𝑇</em>{并行}=𝑛/𝑝+\log_2𝑝$， 时间单位为毫秒。如果以倍率 𝑘 增加 𝑝，那么为了保持效率值得恒定，需要如何增加 𝑛？请给出公式。如果我们将进程数从 8 加倍到 16，则 𝑛 的增加又是多少？该并行程序是可扩展的吗？</p>
</blockquote>
<p>$E=\frac{T_{串行}}{pT_{并行}}=\frac{n}{p(n/p+\log_2p)}=\frac{n}{n+plog_2p}=\frac{1}{1+\frac{p}{n}\log_2p}$恒定，则$\frac{p}{n}\log_2p\equiv c$，其中c为常数。以kp代替p，$n’$代替$n$到左式，有$\frac{p}{n}\log_2p=\frac{kp}{n’}\log_2kp$，即$n’=nk\frac{\log_2kp}{\log_2p}$，因此需要以$k\frac{\log_2k+log_2p}{\log_2p}$的倍率增加n。</p>
<p>p从8到16时，即k=2，代入得n增加的倍率为$2\times\frac{1+3}{3}=\frac{8}{3}$。</p>
<p>该并行程序是可扩展的，因为对于任意一个n都可以找到一个对应的相等规模的p解决问题。</p>
<h2 id="2-20"><a href="#2-20" class="headerlink" title="2.20"></a>2.20</h2><blockquote>
<p>一个可以获得线性加速比的程序是强可扩展的吗？请解释。</p>
</blockquote>
<p>是。如果一个程序获得了线性加速比，那么问题规模就可以认为是一个常数，且这个常数不随着p的变化而变化，我们只需要线性增加进程/线程数量，就能使线性加速后的程序以相同的效率解决不断增加的问题，无需同时增加问题大小。所以这样的程序是强可扩展的程序。</p>

        </div>
        
        
        
    </div>
</div>









    
<div class="card card-transparent">
    <nav class="pagination is-centered" role="navigation" aria-label="pagination">
        <div class="pagination-previous">
            <a class="is-flex-grow has-text-black-ter" href="/">上一页</a>
        </div>
        <div class="pagination-next">
            <a class="is-flex-grow has-text-black-ter" href="/page/3/">下一页</a>
        </div>
        <ul class="pagination-list is-hidden-mobile">
            
            <li><a class="pagination-link has-text-black-ter" href="/">1</a></li>
            
            <li><a class="pagination-link is-current" href="/page/2/">2</a></li>
            
            <li><a class="pagination-link has-text-black-ter" href="/page/3/">3</a></li>
            
            <li><span class="pagination-ellipsis has-text-black-ter">&hellip;</span></li>
            
            <li><a class="pagination-link has-text-black-ter" href="/page/16/">16</a></li>
            
        </ul>
    </nav>
</div>
</div>
                




<div class="column is-4-tablet is-4-desktop is-3-widescreen  has-order-1 column-left ">
    
        
<div class="card widget">
    <div class="card-content">
        <nav class="level">
            <div class="level-item has-text-centered" style="flex-shrink: 1">
                <div>
                    
                        <img class="image is-128x128 has-mb-6" src="/images/cat/color_cat.jpg" alt="贾小厨">
                    
                    
                    <p class="is-size-4 is-block">
                        贾小厨
                    </p>
                    
                    
                    <p class="is-size-6 is-block">
                        当前，你无法预测未来会怎样，但你可以选择跟靠谱的人一同工作，选择做正确的事。
                    </p>
                    
                    
                    <p class="is-size-6 is-flex is-flex-center has-text-grey">
                        <i class="fas fa-map-marker-alt has-mr-7"></i>
                        <span>Beijing.China</span>
                    </p>
                    
                </div>
            </div>
        </nav>
        <nav class="level is-mobile">
            <div class="level-item has-text-centered is-marginless">
                <div>
                    <p class="heading">
                        文章
                    </p>
                    <p class="title has-text-weight-normal">
                        160
                    </p>
                </div>
            </div>
            <div class="level-item has-text-centered is-marginless">
                <div>
                    <p class="heading">
                        分类
                    </p>
                    <p class="title has-text-weight-normal">
                        29
                    </p>
                </div>
            </div>
            <div class="level-item has-text-centered is-marginless">
                <div>
                    <p class="heading">
                        标签
                    </p>
                    <p class="title has-text-weight-normal">
                        46
                    </p>
                </div>
            </div>
        </nav>
        <div class="level">
            <a class="level-item button is-link is-rounded" href="https://github.com/jiaxiaochu" target="_blank">
                关注我</a>
        </div>
        
        
        <div class="level is-mobile">
            
            <a class="level-item button is-white is-marginless" target="_blank" title="Github" href="https://github.com/jiaxiaochu">
                
                <i class="fab fa-github"></i>
                
            </a>
            
            <a class="level-item button is-white is-marginless" target="_blank" title="Facebook" href="https://facebook.com">
                
                <i class="fab fa-facebook"></i>
                
            </a>
            
            <a class="level-item button is-white is-marginless" target="_blank" title="Twitter" href="https://twitter.com">
                
                <i class="fab fa-twitter"></i>
                
            </a>
            
            <a class="level-item button is-white is-marginless" target="_blank" title="Dribbble" href="https://dribbble.com">
                
                <i class="fab fa-dribbble"></i>
                
            </a>
            
            <a class="level-item button is-white is-marginless" target="_blank" title="RSS" href="/">
                
                <i class="fas fa-rss"></i>
                
            </a>
            
        </div>
        
    </div>
</div>
    
        
    
        
<div class="card widget">
    <div class="card-content">
        <div class="menu">
            <h3 class="menu-label">
                分类
            </h3>
            <ul class="menu-list">
            <li>
        <a class="level is-marginless" href="/categories/ACM/">
            <span class="level-start">
                <span class="level-item">ACM</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">84</span>
            </span>
        </a><ul><li>
        <a class="level is-marginless" href="/categories/ACM/Template/">
            <span class="level-start">
                <span class="level-item">Template</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">10</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/ACM/算法竞赛入门经典训练指南/">
            <span class="level-start">
                <span class="level-item">算法竞赛入门经典训练指南</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">7</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/ACM/题解/">
            <span class="level-start">
                <span class="level-item">题解</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">50</span>
            </span>
        </a></li></ul></li><li>
        <a class="level is-marginless" href="/categories/Linux/">
            <span class="level-start">
                <span class="level-item">Linux</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">1</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/Python/">
            <span class="level-start">
                <span class="level-item">Python</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">1</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/Spider/">
            <span class="level-start">
                <span class="level-item">Spider</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">1</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/函数程序设计实验/">
            <span class="level-start">
                <span class="level-item">函数程序设计实验</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">12</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/博客搭建/">
            <span class="level-start">
                <span class="level-item">博客搭建</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">1</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/吴恩达机器学习笔记/">
            <span class="level-start">
                <span class="level-item">吴恩达机器学习笔记</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">3</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/学习笔记/">
            <span class="level-start">
                <span class="level-item">学习笔记</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">3</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/小工具/">
            <span class="level-start">
                <span class="level-item">小工具</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">1</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/并行与分布式计算/">
            <span class="level-start">
                <span class="level-item">并行与分布式计算</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">2</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/操作系统/">
            <span class="level-start">
                <span class="level-item">操作系统</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">4</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/数字电路与逻辑设计/">
            <span class="level-start">
                <span class="level-item">数字电路与逻辑设计</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">6</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/机器学习/">
            <span class="level-start">
                <span class="level-item">机器学习</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">4</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/环境配置/">
            <span class="level-start">
                <span class="level-item">环境配置</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">14</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/程序设计/">
            <span class="level-start">
                <span class="level-item">程序设计</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">8</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/计算机组成原理/">
            <span class="level-start">
                <span class="level-item">计算机组成原理</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">3</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/计算机网络/">
            <span class="level-start">
                <span class="level-item">计算机网络</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">8</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/超级计算机原理与操作/">
            <span class="level-start">
                <span class="level-item">超级计算机原理与操作</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">3</span>
            </span>
        </a></li>
            </ul>
        </div>
    </div>
</div>
    
        
<div class="card widget">
    <div class="card-content">
        <h3 class="menu-label">
            最新文章
        </h3>
        
        <article class="media">
            
            <a href="/2019/07/23/pymysql远程连接被拒绝问题解决方法/" class="media-left">
                <p class="image is-64x64">
                    <img class="thumbnail" src="https://ws1.sinaimg.cn/large/0065l1jqly1g592mgpd7mg30ot0ea7d5.gif" alt="pymysql远程连接被拒绝问题解决方法">
                </p>
            </a>
            
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2019-07-22T16:08:33.000Z">2019-07-23</time></div>
                    <a href="/2019/07/23/pymysql远程连接被拒绝问题解决方法/" class="has-link-black-ter is-size-6">pymysql远程连接被拒绝问题解决方法</a>
                    <p class="is-size-7 is-uppercase">
                        <a class="has-link-grey -link" href="/categories/环境配置/">环境配置</a>
                    </p>
                </div>
            </div>
        </article>
        
        <article class="media">
            
            <a href="/2019/07/22/Ubuntu系统搭建配置Python虚拟开发环境/" class="media-left">
                <p class="image is-64x64">
                    <img class="thumbnail" src="https://ws1.sinaimg.cn/large/0065l1jqly1g590mpqs2ej30gg08c3ym.jpg" alt="Ubuntu系统搭建配置Python虚拟开发环境">
                </p>
            </a>
            
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2019-07-22T14:57:27.000Z">2019-07-22</time></div>
                    <a href="/2019/07/22/Ubuntu系统搭建配置Python虚拟开发环境/" class="has-link-black-ter is-size-6">Ubuntu系统搭建配置Python虚拟开发环境</a>
                    <p class="is-size-7 is-uppercase">
                        <a class="has-link-grey -link" href="/categories/环境配置/">环境配置</a>
                    </p>
                </div>
            </div>
        </article>
        
        <article class="media">
            
            <a href="/2019/07/14/2017-11-17-垃圾回收/" class="media-left">
                <p class="image is-64x64">
                    <img class="thumbnail" src="/images/thumbnail.svg" alt="Python中的垃圾回收机制">
                </p>
            </a>
            
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2019-07-14T08:06:52.968Z">2019-07-14</time></div>
                    <a href="/2019/07/14/2017-11-17-垃圾回收/" class="has-link-black-ter is-size-6">Python中的垃圾回收机制</a>
                    <p class="is-size-7 is-uppercase">
                        <a class="has-link-grey -link" href="/categories/Python/">Python</a>
                    </p>
                </div>
            </div>
        </article>
        
        <article class="media">
            
            <a href="/2019/07/14/2017-08-14-爬取网易财经中股票的历史交易数据/" class="media-left">
                <p class="image is-64x64">
                    <img class="thumbnail" src="/images/thumbnail.svg" alt="爬取网易财经中股票的历史交易数据">
                </p>
            </a>
            
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2019-07-14T08:06:52.967Z">2019-07-14</time></div>
                    <a href="/2019/07/14/2017-08-14-爬取网易财经中股票的历史交易数据/" class="has-link-black-ter is-size-6">爬取网易财经中股票的历史交易数据</a>
                    <p class="is-size-7 is-uppercase">
                        <a class="has-link-grey -link" href="/categories/Spider/">Spider</a>
                    </p>
                </div>
            </div>
        </article>
        
        <article class="media">
            
            <a href="/2019/04/11/2019-03-31-应用层实验/" class="media-left">
                <p class="image is-64x64">
                    <img class="thumbnail" src="/images/thumbnail.svg" alt>
                </p>
            </a>
            
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2019-04-10T16:08:06.399Z">2019-04-11</time></div>
                    <a href="/2019/04/11/2019-03-31-应用层实验/" class="has-link-black-ter is-size-6"></a>
                    <p class="is-size-7 is-uppercase">
                        <a class="has-link-grey -link" href="/categories/计算机网络/">计算机网络</a>
                    </p>
                </div>
            </div>
        </article>
        
    </div>
</div>

    
    
        <div class="column-right-shadow is-hidden-widescreen ">
        
            
<div class="card widget">
    <div class="card-content">
        <h3 class="menu-label">
            标签云
        </h3>
        <a href="/tags/Anaconda/" style="font-size: 10px;">Anaconda</a> <a href="/tags/Bug/" style="font-size: 10px;">Bug</a> <a href="/tags/ChromeDriver/" style="font-size: 10px;">ChromeDriver</a> <a href="/tags/DP/" style="font-size: 10px;">DP</a> <a href="/tags/Deepin/" style="font-size: 11.43px;">Deepin</a> <a href="/tags/ICPC模板/" style="font-size: 18.57px;">ICPC模板</a> <a href="/tags/LCA/" style="font-size: 10px;">LCA</a> <a href="/tags/MongoDB数据库/" style="font-size: 10px;">MongoDB数据库</a> <a href="/tags/MySQL/" style="font-size: 10px;">MySQL</a> <a href="/tags/NTT/" style="font-size: 10px;">NTT</a> <a href="/tags/Pycharm/" style="font-size: 11.43px;">Pycharm</a> <a href="/tags/Python解释器的安装与配置/" style="font-size: 12.86px;">Python解释器的安装与配置</a> <a href="/tags/Ubuntu/" style="font-size: 10px;">Ubuntu</a> <a href="/tags/VMware/" style="font-size: 10px;">VMware</a> <a href="/tags/chrome/" style="font-size: 10px;">chrome</a> <a href="/tags/chromedriver/" style="font-size: 10px;">chromedriver</a> <a href="/tags/pymysql/" style="font-size: 10px;">pymysql</a> <a href="/tags/三维计算几何/" style="font-size: 12.86px;">三维计算几何</a> <a href="/tags/主席树/" style="font-size: 10px;">主席树</a> <a href="/tags/二分/" style="font-size: 10px;">二分</a> <a href="/tags/二维计算几何/" style="font-size: 10px;">二维计算几何</a> <a href="/tags/动态开点/" style="font-size: 10px;">动态开点</a> <a href="/tags/励志/" style="font-size: 10px;">励志</a> <a href="/tags/单调栈/" style="font-size: 10px;">单调栈</a> <a href="/tags/单调队列/" style="font-size: 12.86px;">单调队列</a> <a href="/tags/原根/" style="font-size: 10px;">原根</a> <a href="/tags/可持久化/" style="font-size: 11.43px;">可持久化</a> <a href="/tags/扫描线/" style="font-size: 10px;">扫描线</a> <a href="/tags/拓扑排序/" style="font-size: 10px;">拓扑排序</a> <a href="/tags/搜索/" style="font-size: 10px;">搜索</a> <a href="/tags/数据库/" style="font-size: 10px;">数据库</a> <a href="/tags/数据结构/" style="font-size: 17.14px;">数据结构</a> <a href="/tags/数论/" style="font-size: 11.43px;">数论</a> <a href="/tags/无旋Treap/" style="font-size: 14.29px;">无旋Treap</a> <a href="/tags/最大流/" style="font-size: 10px;">最大流</a> <a href="/tags/最短路/" style="font-size: 10px;">最短路</a> <a href="/tags/树状数组/" style="font-size: 10px;">树状数组</a> <a href="/tags/环境配置/" style="font-size: 20px;">环境配置</a> <a href="/tags/珂朵莉树/" style="font-size: 11.43px;">珂朵莉树</a> <a href="/tags/系统配置/" style="font-size: 10px;">系统配置</a> <a href="/tags/线段树/" style="font-size: 15.71px;">线段树</a> <a href="/tags/老司机树/" style="font-size: 11.43px;">老司机树</a> <a href="/tags/莫比乌斯反演/" style="font-size: 10px;">莫比乌斯反演</a> <a href="/tags/虚拟机/" style="font-size: 10px;">虚拟机</a> <a href="/tags/虚拟环境/" style="font-size: 10px;">虚拟环境</a> <a href="/tags/谷歌输入法/" style="font-size: 10px;">谷歌输入法</a>
    </div>
</div>

        
            <div class="card widget">
    <div class="card-content">
        <div class="menu">
        <h3 class="menu-label">
            归档
        </h3>
        <ul class="menu-list">
        
        <li>
            <a class="level is-marginless" href="/archives/2019/07/">
                <span class="level-start">
                    <span class="level-item">七月 2019</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">4</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2019/04/">
                <span class="level-start">
                    <span class="level-item">四月 2019</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">22</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2019/03/">
                <span class="level-start">
                    <span class="level-item">三月 2019</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">4</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2019/02/">
                <span class="level-start">
                    <span class="level-item">二月 2019</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">27</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2019/01/">
                <span class="level-start">
                    <span class="level-item">一月 2019</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">6</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2018/12/">
                <span class="level-start">
                    <span class="level-item">十二月 2018</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">6</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2018/11/">
                <span class="level-start">
                    <span class="level-item">十一月 2018</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">13</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2018/10/">
                <span class="level-start">
                    <span class="level-item">十月 2018</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">21</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2018/09/">
                <span class="level-start">
                    <span class="level-item">九月 2018</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">9</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2018/08/">
                <span class="level-start">
                    <span class="level-item">八月 2018</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">19</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2018/07/">
                <span class="level-start">
                    <span class="level-item">七月 2018</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">9</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2018/06/">
                <span class="level-start">
                    <span class="level-item">六月 2018</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">4</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2018/05/">
                <span class="level-start">
                    <span class="level-item">五月 2018</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">3</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2018/03/">
                <span class="level-start">
                    <span class="level-item">三月 2018</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">2</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2017/12/">
                <span class="level-start">
                    <span class="level-item">十二月 2017</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">7</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2017/11/">
                <span class="level-start">
                    <span class="level-item">十一月 2017</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">3</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2017/10/">
                <span class="level-start">
                    <span class="level-item">十月 2017</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        </ul>
        </div>
    </div>
</div>
        
            <div class="card widget">
    <div class="card-content">
        <div class="menu">
            <h3 class="menu-label">
                标签
            </h3>
            <div class="field is-grouped is-grouped-multiline">
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/Anaconda/">
                        <span class="tag">Anaconda</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/Bug/">
                        <span class="tag">Bug</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/ChromeDriver/">
                        <span class="tag">ChromeDriver</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/DP/">
                        <span class="tag">DP</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/Deepin/">
                        <span class="tag">Deepin</span>
                        <span class="tag is-grey">2</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/ICPC模板/">
                        <span class="tag">ICPC模板</span>
                        <span class="tag is-grey">10</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/LCA/">
                        <span class="tag">LCA</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/MongoDB数据库/">
                        <span class="tag">MongoDB数据库</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/MySQL/">
                        <span class="tag">MySQL</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/NTT/">
                        <span class="tag">NTT</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/Pycharm/">
                        <span class="tag">Pycharm</span>
                        <span class="tag is-grey">2</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/Python解释器的安装与配置/">
                        <span class="tag">Python解释器的安装与配置</span>
                        <span class="tag is-grey">3</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/Ubuntu/">
                        <span class="tag">Ubuntu</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/VMware/">
                        <span class="tag">VMware</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/chrome/">
                        <span class="tag">chrome</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/chromedriver/">
                        <span class="tag">chromedriver</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/pymysql/">
                        <span class="tag">pymysql</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/三维计算几何/">
                        <span class="tag">三维计算几何</span>
                        <span class="tag is-grey">3</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/主席树/">
                        <span class="tag">主席树</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/二分/">
                        <span class="tag">二分</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/二维计算几何/">
                        <span class="tag">二维计算几何</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/动态开点/">
                        <span class="tag">动态开点</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/励志/">
                        <span class="tag">励志</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/单调栈/">
                        <span class="tag">单调栈</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/单调队列/">
                        <span class="tag">单调队列</span>
                        <span class="tag is-grey">3</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/原根/">
                        <span class="tag">原根</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/可持久化/">
                        <span class="tag">可持久化</span>
                        <span class="tag is-grey">2</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/扫描线/">
                        <span class="tag">扫描线</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/拓扑排序/">
                        <span class="tag">拓扑排序</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/搜索/">
                        <span class="tag">搜索</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/数据库/">
                        <span class="tag">数据库</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/数据结构/">
                        <span class="tag">数据结构</span>
                        <span class="tag is-grey">8</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/数论/">
                        <span class="tag">数论</span>
                        <span class="tag is-grey">2</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/无旋Treap/">
                        <span class="tag">无旋Treap</span>
                        <span class="tag is-grey">4</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/最大流/">
                        <span class="tag">最大流</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/最短路/">
                        <span class="tag">最短路</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/树状数组/">
                        <span class="tag">树状数组</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/环境配置/">
                        <span class="tag">环境配置</span>
                        <span class="tag is-grey">14</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/珂朵莉树/">
                        <span class="tag">珂朵莉树</span>
                        <span class="tag is-grey">2</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/系统配置/">
                        <span class="tag">系统配置</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/线段树/">
                        <span class="tag">线段树</span>
                        <span class="tag is-grey">5</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/老司机树/">
                        <span class="tag">老司机树</span>
                        <span class="tag is-grey">2</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/莫比乌斯反演/">
                        <span class="tag">莫比乌斯反演</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/虚拟机/">
                        <span class="tag">虚拟机</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/虚拟环境/">
                        <span class="tag">虚拟环境</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/谷歌输入法/">
                        <span class="tag">谷歌输入法</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
            </div>
        </div>
    </div>
</div>
        
            

<div class="card widget">
    <div class="card-content">
        <div class="menu">
        <h3 class="menu-label">
            链接
        </h3>
        <ul class="menu-list">
        
            <li>
                <a class="level is-mobile" href="https://www.jianshu.com/u/bf4c0b4a8c83" target="_blank">
                    <span class="level-left">
                        <span class="level-item">简书</span>
                    </span>
                    <span class="level-right">
                        <span class="level-item tag">www.jianshu.com</span>
                    </span>
                </a>
            </li>
        
            <li>
                <a class="level is-mobile" href="https://github.com/jiaxiaochu" target="_blank">
                    <span class="level-left">
                        <span class="level-item">GitHub</span>
                    </span>
                    <span class="level-right">
                        <span class="level-item tag">github.com</span>
                    </span>
                </a>
            </li>
        
        </ul>
        </div>
    </div>
</div>


        
        </div>
    
</div>

                




<div class="column is-4-tablet is-4-desktop is-3-widescreen is-hidden-touch is-hidden-desktop-only has-order-3 column-right ">
    
        
<div class="card widget">
    <div class="card-content">
        <h3 class="menu-label">
            标签云
        </h3>
        <a href="/tags/Anaconda/" style="font-size: 10px;">Anaconda</a> <a href="/tags/Bug/" style="font-size: 10px;">Bug</a> <a href="/tags/ChromeDriver/" style="font-size: 10px;">ChromeDriver</a> <a href="/tags/DP/" style="font-size: 10px;">DP</a> <a href="/tags/Deepin/" style="font-size: 11.43px;">Deepin</a> <a href="/tags/ICPC模板/" style="font-size: 18.57px;">ICPC模板</a> <a href="/tags/LCA/" style="font-size: 10px;">LCA</a> <a href="/tags/MongoDB数据库/" style="font-size: 10px;">MongoDB数据库</a> <a href="/tags/MySQL/" style="font-size: 10px;">MySQL</a> <a href="/tags/NTT/" style="font-size: 10px;">NTT</a> <a href="/tags/Pycharm/" style="font-size: 11.43px;">Pycharm</a> <a href="/tags/Python解释器的安装与配置/" style="font-size: 12.86px;">Python解释器的安装与配置</a> <a href="/tags/Ubuntu/" style="font-size: 10px;">Ubuntu</a> <a href="/tags/VMware/" style="font-size: 10px;">VMware</a> <a href="/tags/chrome/" style="font-size: 10px;">chrome</a> <a href="/tags/chromedriver/" style="font-size: 10px;">chromedriver</a> <a href="/tags/pymysql/" style="font-size: 10px;">pymysql</a> <a href="/tags/三维计算几何/" style="font-size: 12.86px;">三维计算几何</a> <a href="/tags/主席树/" style="font-size: 10px;">主席树</a> <a href="/tags/二分/" style="font-size: 10px;">二分</a> <a href="/tags/二维计算几何/" style="font-size: 10px;">二维计算几何</a> <a href="/tags/动态开点/" style="font-size: 10px;">动态开点</a> <a href="/tags/励志/" style="font-size: 10px;">励志</a> <a href="/tags/单调栈/" style="font-size: 10px;">单调栈</a> <a href="/tags/单调队列/" style="font-size: 12.86px;">单调队列</a> <a href="/tags/原根/" style="font-size: 10px;">原根</a> <a href="/tags/可持久化/" style="font-size: 11.43px;">可持久化</a> <a href="/tags/扫描线/" style="font-size: 10px;">扫描线</a> <a href="/tags/拓扑排序/" style="font-size: 10px;">拓扑排序</a> <a href="/tags/搜索/" style="font-size: 10px;">搜索</a> <a href="/tags/数据库/" style="font-size: 10px;">数据库</a> <a href="/tags/数据结构/" style="font-size: 17.14px;">数据结构</a> <a href="/tags/数论/" style="font-size: 11.43px;">数论</a> <a href="/tags/无旋Treap/" style="font-size: 14.29px;">无旋Treap</a> <a href="/tags/最大流/" style="font-size: 10px;">最大流</a> <a href="/tags/最短路/" style="font-size: 10px;">最短路</a> <a href="/tags/树状数组/" style="font-size: 10px;">树状数组</a> <a href="/tags/环境配置/" style="font-size: 20px;">环境配置</a> <a href="/tags/珂朵莉树/" style="font-size: 11.43px;">珂朵莉树</a> <a href="/tags/系统配置/" style="font-size: 10px;">系统配置</a> <a href="/tags/线段树/" style="font-size: 15.71px;">线段树</a> <a href="/tags/老司机树/" style="font-size: 11.43px;">老司机树</a> <a href="/tags/莫比乌斯反演/" style="font-size: 10px;">莫比乌斯反演</a> <a href="/tags/虚拟机/" style="font-size: 10px;">虚拟机</a> <a href="/tags/虚拟环境/" style="font-size: 10px;">虚拟环境</a> <a href="/tags/谷歌输入法/" style="font-size: 10px;">谷歌输入法</a>
    </div>
</div>

    
        <div class="card widget">
    <div class="card-content">
        <div class="menu">
        <h3 class="menu-label">
            归档
        </h3>
        <ul class="menu-list">
        
        <li>
            <a class="level is-marginless" href="/archives/2019/07/">
                <span class="level-start">
                    <span class="level-item">七月 2019</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">4</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2019/04/">
                <span class="level-start">
                    <span class="level-item">四月 2019</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">22</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2019/03/">
                <span class="level-start">
                    <span class="level-item">三月 2019</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">4</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2019/02/">
                <span class="level-start">
                    <span class="level-item">二月 2019</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">27</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2019/01/">
                <span class="level-start">
                    <span class="level-item">一月 2019</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">6</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2018/12/">
                <span class="level-start">
                    <span class="level-item">十二月 2018</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">6</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2018/11/">
                <span class="level-start">
                    <span class="level-item">十一月 2018</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">13</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2018/10/">
                <span class="level-start">
                    <span class="level-item">十月 2018</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">21</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2018/09/">
                <span class="level-start">
                    <span class="level-item">九月 2018</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">9</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2018/08/">
                <span class="level-start">
                    <span class="level-item">八月 2018</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">19</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2018/07/">
                <span class="level-start">
                    <span class="level-item">七月 2018</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">9</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2018/06/">
                <span class="level-start">
                    <span class="level-item">六月 2018</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">4</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2018/05/">
                <span class="level-start">
                    <span class="level-item">五月 2018</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">3</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2018/03/">
                <span class="level-start">
                    <span class="level-item">三月 2018</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">2</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2017/12/">
                <span class="level-start">
                    <span class="level-item">十二月 2017</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">7</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2017/11/">
                <span class="level-start">
                    <span class="level-item">十一月 2017</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">3</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2017/10/">
                <span class="level-start">
                    <span class="level-item">十月 2017</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        </ul>
        </div>
    </div>
</div>
    
        <div class="card widget">
    <div class="card-content">
        <div class="menu">
            <h3 class="menu-label">
                标签
            </h3>
            <div class="field is-grouped is-grouped-multiline">
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/Anaconda/">
                        <span class="tag">Anaconda</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/Bug/">
                        <span class="tag">Bug</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/ChromeDriver/">
                        <span class="tag">ChromeDriver</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/DP/">
                        <span class="tag">DP</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/Deepin/">
                        <span class="tag">Deepin</span>
                        <span class="tag is-grey">2</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/ICPC模板/">
                        <span class="tag">ICPC模板</span>
                        <span class="tag is-grey">10</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/LCA/">
                        <span class="tag">LCA</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/MongoDB数据库/">
                        <span class="tag">MongoDB数据库</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/MySQL/">
                        <span class="tag">MySQL</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/NTT/">
                        <span class="tag">NTT</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/Pycharm/">
                        <span class="tag">Pycharm</span>
                        <span class="tag is-grey">2</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/Python解释器的安装与配置/">
                        <span class="tag">Python解释器的安装与配置</span>
                        <span class="tag is-grey">3</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/Ubuntu/">
                        <span class="tag">Ubuntu</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/VMware/">
                        <span class="tag">VMware</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/chrome/">
                        <span class="tag">chrome</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/chromedriver/">
                        <span class="tag">chromedriver</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/pymysql/">
                        <span class="tag">pymysql</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/三维计算几何/">
                        <span class="tag">三维计算几何</span>
                        <span class="tag is-grey">3</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/主席树/">
                        <span class="tag">主席树</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/二分/">
                        <span class="tag">二分</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/二维计算几何/">
                        <span class="tag">二维计算几何</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/动态开点/">
                        <span class="tag">动态开点</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/励志/">
                        <span class="tag">励志</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/单调栈/">
                        <span class="tag">单调栈</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/单调队列/">
                        <span class="tag">单调队列</span>
                        <span class="tag is-grey">3</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/原根/">
                        <span class="tag">原根</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/可持久化/">
                        <span class="tag">可持久化</span>
                        <span class="tag is-grey">2</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/扫描线/">
                        <span class="tag">扫描线</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/拓扑排序/">
                        <span class="tag">拓扑排序</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/搜索/">
                        <span class="tag">搜索</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/数据库/">
                        <span class="tag">数据库</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/数据结构/">
                        <span class="tag">数据结构</span>
                        <span class="tag is-grey">8</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/数论/">
                        <span class="tag">数论</span>
                        <span class="tag is-grey">2</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/无旋Treap/">
                        <span class="tag">无旋Treap</span>
                        <span class="tag is-grey">4</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/最大流/">
                        <span class="tag">最大流</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/最短路/">
                        <span class="tag">最短路</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/树状数组/">
                        <span class="tag">树状数组</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/环境配置/">
                        <span class="tag">环境配置</span>
                        <span class="tag is-grey">14</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/珂朵莉树/">
                        <span class="tag">珂朵莉树</span>
                        <span class="tag is-grey">2</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/系统配置/">
                        <span class="tag">系统配置</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/线段树/">
                        <span class="tag">线段树</span>
                        <span class="tag is-grey">5</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/老司机树/">
                        <span class="tag">老司机树</span>
                        <span class="tag is-grey">2</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/莫比乌斯反演/">
                        <span class="tag">莫比乌斯反演</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/虚拟机/">
                        <span class="tag">虚拟机</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/虚拟环境/">
                        <span class="tag">虚拟环境</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/谷歌输入法/">
                        <span class="tag">谷歌输入法</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
            </div>
        </div>
    </div>
</div>
    
        

<div class="card widget">
    <div class="card-content">
        <div class="menu">
        <h3 class="menu-label">
            链接
        </h3>
        <ul class="menu-list">
        
            <li>
                <a class="level is-mobile" href="https://www.jianshu.com/u/bf4c0b4a8c83" target="_blank">
                    <span class="level-left">
                        <span class="level-item">简书</span>
                    </span>
                    <span class="level-right">
                        <span class="level-item tag">www.jianshu.com</span>
                    </span>
                </a>
            </li>
        
            <li>
                <a class="level is-mobile" href="https://github.com/jiaxiaochu" target="_blank">
                    <span class="level-left">
                        <span class="level-item">GitHub</span>
                    </span>
                    <span class="level-right">
                        <span class="level-item tag">github.com</span>
                    </span>
                </a>
            </li>
        
        </ul>
        </div>
    </div>
</div>


    
    
</div>

            </div>
        </div>
    </section>
    <footer class="footer">
    <div class="container">
        <div class="level">
            <div class="level-start has-text-centered-mobile">
                <a class="footer-logo is-block has-mb-6" href="/">
                
                    <img src="/images/logo.svg" alt="贾志翔的博客" height="28">
                
                </a>
                <p class="is-size-7">
                &copy; 2019 jiazhixiang&nbsp;
                Powered &#10084; YH · Lin
                </p>
            </div>
            
            <script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>

            
            <div class="level-end">
            
                <div class="field has-addons is-flex-center-mobile has-mt-5-mobile is-flex-wrap is-flex-middle">
                
                
                <p class="control">
                    <a class="button is-white is-large" target="_blank" title="Creative Commons" href="https://creativecommons.org/">
                        
                        <i class="fab fa-creative-commons"></i>
                        
                    </a>
                </p>
                
                <p class="control">
                    <a class="button is-white is-large" target="_blank" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/">
                        
                        <i class="fab fa-creative-commons-by"></i>
                        
                    </a>
                </p>
                
                <p class="control">
                    <a class="button is-white is-large" target="_blank" title="Download on GitHub" href="https://github.com/jiaxiaochu/jiaxiaochu.github.io">
                        
                        <i class="fab fa-github"></i>
                        
                    </a>
                </p>
                
                </div>
            
            </div>
        <div align="center">
            <span id="timeDate">载入天数...</span><span id="times">载入时分秒...</span>
            <script>
                var now = new Date(); 
                function createtime() { 
                    var grt= new Date("4/1/2019 12:49:00");//此处修改你的建站时间或者网站上线时间 
                    now.setTime(now.getTime()+250); 
                    days = (now - grt ) / 1000 / 60 / 60 / 24; dnum = Math.floor(days); 
                    hours = (now - grt ) / 1000 / 60 / 60 - (24 * dnum); hnum = Math.floor(hours); 
                    if(String(hnum).length ==1 ){hnum = "0" + hnum;} minutes = (now - grt ) / 1000 /60 - (24 * 60 * dnum) - (60 * hnum); 
                    mnum = Math.floor(minutes); if(String(mnum).length ==1 ){mnum = "0" + mnum;} 
                    seconds = (now - grt ) / 1000 - (24 * 60 * 60 * dnum) - (60 * 60 * hnum) - (60 * mnum); 
                    snum = Math.round(seconds); if(String(snum).length ==1 ){snum = "0" + snum;} 
                    document.getElementById("timeDate").innerHTML = "本站已安全运行 "+dnum+" 天 "; 
                    document.getElementById("times").innerHTML = hnum + " 小时 " + mnum + " 分 " + snum + " 秒"; 
                } 
            setInterval("createtime()",250);
            </script>
            <div align="center">
            <span id="busuanzi_container_site_pv" class="theme-info">本站总访问量-<span id="busuanzi_value_site_pv"></span>-次|
              </span>
              <span id="busuanzi_container_site_uv" class="theme-info">您是第-<span id="busuanzi_value_site_uv"></span>-位小伙伴</span>

            <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
            </div>
        </div>
        <span>
        <script type="text/javascript" src="//rf.revolvermaps.com/0/0/0.js?i=0xetp0d4rdh&amp;d=2&amp;p=1&amp;b=8&amp;w=193&amp;g=2&amp;f=arial&amp;fs=12&amp;r=0&amp;c0=000000&amp;c1=00a99d&amp;c2=000000&amp;ic0=0&amp;ic1=0" async="async"></script>
        </span>
        </div>

    </div>

    <script>
        (function(){
            var bp = document.createElement('script');
            bp.src = '//push.zhanzhang.baidu.com/push.js';
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(bp, s);
        })();
</script>
<script src="https://cdn.jsdelivr.net/npm/meting@1.1.0/dist/Meting.min.js"></script>
</footer>
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script>
<script>moment.locale("zh-CN");</script>


    
    
    
    <script src="/js/animation.js"></script>
    

    
    
    
    <script src="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/js/lightgallery.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/js/jquery.justifiedGallery.min.js" defer></script>
    <script src="/js/gallery.js" defer></script>
    

    
    

<div id="outdated">
    <h6>Your browser is out-of-date!</h6>
    <p>Update your browser to view this website correctly. <a id="btnUpdateBrowser" href="http://outdatedbrowser.com/">Update
            my browser now </a></p>
    <p class="last"><a href="#" id="btnCloseUpdateBrowser" title="Close">&times;</a></p>
</div>
<script src="https://cdn.jsdelivr.net/npm/outdatedbrowser@1.1.5/outdatedbrowser/outdatedbrowser.min.js" defer></script>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        outdatedBrowser({
            bgColor: '#f25648',
            color: '#ffffff',
            lowerThan: 'flex'
        });
    });
</script>


    
    
<script src="https://cdn.jsdelivr.net/npm/mathjax@2.7.5/unpacked/MathJax.js?config=TeX-MML-AM_CHTML" defer></script>
<script>
document.addEventListener('DOMContentLoaded', function () {
    MathJax.Hub.Config({
        'HTML-CSS': {
            matchFontHeight: false
        },
        SVG: {
            matchFontHeight: false
        },
        CommonHTML: {
            matchFontHeight: false
        },
        tex2jax: {
            inlineMath: [
                ['$','$'],
                ['\\(','\\)']
            ]
        }
    });
});
</script>

    
    

<a id="back-to-top" title="回到顶端" href="javascript:;">
    <i class="fas fa-chevron-up"></i>
</a>
<script src="/js/back-to-top.js" defer></script>


    
    

    
    
    
    

    
    
    
    
    
    <script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script>
    <script src="/js/clipboard.js" defer></script>
    

    


<script src="/js/main.js" defer></script>

    
    <div class="searchbox ins-search">
    <div class="searchbox-container ins-search-container">
        <div class="searchbox-input-wrapper">
            <input type="text" class="searchbox-input ins-search-input" placeholder="想要查找什么...">
            <span class="searchbox-close ins-close ins-selectable"><i class="fa fa-times-circle"></i></span>
        </div>
        <div class="searchbox-result-wrapper ins-section-wrapper">
            <div class="ins-section-container"></div>
        </div>
    </div>
</div>
<script>
    (function (window) {
        var INSIGHT_CONFIG = {
            TRANSLATION: {
                POSTS: '文章',
                PAGES: '页面',
                CATEGORIES: '分类',
                TAGS: '标签',
                UNTITLED: '(无标题)',
            },
            CONTENT_URL: '/content.json',
        };
        window.INSIGHT_CONFIG = INSIGHT_CONFIG;
    })(window);
</script>
<script src="/js/insight.js" defer></script>
<link rel="stylesheet" href="/css/search.css">
<link rel="stylesheet" href="/css/insight.css">
    
        <!-- 雪花特效 -->
    <script type="text/javascript">
      var windowWidth = $(window).width();
      if (windowWidth > 480) {
        document.write('<script type="text/javascript" src="/js/src/snow.js"><\/script>');
      }
    </script>

    <script src="//code.tidio.co/wgmwb2zlxrcti0crizzmumshwbxpums2.js"></script>
    
</body>
</html>